

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Fragment实现原理 [ Swithun Blog ]</title>

  
  <!-- stylesheets list from _config.yml -->
  
  <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css">
  
  <link rel="stylesheet" href="/lib/highlight-11-9-0/src/styles/atom-one-dark.css">
  
  <link rel="stylesheet" href="/css/again.css">
  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>

  <!-- menu -->
  <div id="menu-outer">
    <div id="menu-inner">
      
      <a class="menu-button" href="/">Home</a>
      
      <a class="menu-button" href="/about">About</a>
      
      <a class="menu-button" href="/contact">Contact</a>
      
      <a class="menu-button" href="/archives">Archives</a>
      
      <a class="menu-button" href="/categories">Category</a>
      
    </div>
  </div>

  <!-- 中间主体 -->
  <div id="main">
    <!-- 侧边栏 -->
    <div id="aside-outer">
      <aside>
        <!-- 搜索栏 -->
<div id="search">
    <input class="search-input" type="text" placeholder="search">
    <i id="search-icon" class="fa fa-bars" title="切换目录与索引"></i>
</div>

<!-- 侧边目录栏 -->
<div id="tree">
    

    

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            Android
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file active">
                        <a href="/2023/10/18/Android/Fragment原理/">
                            <i class="fa fa-file"></i>
                            Fragment原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/Android/viewmodel原理/">
                            <i class="fa fa-file"></i>
                            viewmodel原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/03/03/Android/view绘制原理/">
                            <i class="fa fa-file"></i>
                            view绘制原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/03/09/Android/自定义View实现拖拽展开面板/">
                            <i class="fa fa-file"></i>
                            自定义View实现拖拽展开面板
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/03/10/Android/Android窗口机制/">
                            <i class="fa fa-file"></i>
                            Android窗口机制
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/05/12/Android/NestedScrolling原理/">
                            <i class="fa fa-file"></i>
                            NestedScrolling原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/05/25/Android/自己实现一个NestedScrollView/">
                            <i class="fa fa-file"></i>
                            自己实现一个NestedScrollView
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/06/02/Android/EditText光标定位原理/">
                            <i class="fa fa-file"></i>
                            EditText光标定位原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/06/02/Android/一步步解决NestedScrollView嵌套EditText的冲突/">
                            <i class="fa fa-file"></i>
                            一步步解决NestedScrollView嵌套EditText的冲突
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/06/11/Android/Dialog原理/">
                            <i class="fa fa-file"></i>
                            Dialog原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/07/20/Android/从0实现一个BottomSheetDialog/">
                            <i class="fa fa-file"></i>
                            从0实现一个BottomSheetDialog
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            主题演示
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/主题演示/demo1/">
                            <i class="fa fa-file"></i>
                            demo1
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/22/主题演示/temp/">
                            <i class="fa fa-file"></i>
                            temp
                        </a>
                    </li>
                </ul>

              

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            demo_folder_level2
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/主题演示/demo_folder_level2/demo2/">
                            <i class="fa fa-file"></i>
                            demo2
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 
</div>

<div id="toc" style="display: none;"></div>
      </aside>
    </div>
    <!-- 文章内容 -->
    <div id="content-outer">
      <div id="content-inner">
        
<article id="post">
  <h1>Fragment实现原理</h1>
  <blockquote>
<p>基于Android Api 33</p>
</blockquote>
<h2 id="Activity的生命周期与Fragment生命周期的关联"><a href="#Activity的生命周期与Fragment生命周期的关联" class="headerlink" title="Activity的生命周期与Fragment生命周期的关联"></a>Activity的生命周期与Fragment生命周期的关联</h2><img src="/2023/10/18/Android/Fragment%E5%8E%9F%E7%90%86/image-2.png" class="" title="Alt text">

<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;
    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    tools:context=&quot;.MainActivity&quot;&gt;

    &lt;Button
        android:id=&quot;@+id/f1&quot;
        android:text=&quot;Fragment 1&quot;
        android:layout_width=&quot;wrap_content&quot;
        android:layout_height=&quot;wrap_content&quot;
        app:layout_constraintTop_toTopOf=&quot;parent&quot;
        app:layout_constraintLeft_toLeftOf=&quot;parent&quot;
        /&gt;

    &lt;fragment android:name=&quot;com.example.test_android.Fragment1&quot;
        android:id=&quot;@+id/prefill_fragment&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;0dp&quot;
        app:layout_constraintTop_toBottomOf=&quot;@id/f1&quot;
        app:layout_constraintStart_toStartOf=&quot;parent&quot;
        app:layout_constraintEnd_toEndOf=&quot;parent&quot;
        app:layout_constraintBottom_toTopOf=&quot;@id/content_fragment&quot;
        /&gt;

    &lt;FrameLayout
        android:id=&quot;@+id/content_fragment&quot;
        android:background=&quot;#8EFDCB&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;0dp&quot;
        app:layout_constraintTop_toBottomOf=&quot;@id/prefill_fragment&quot;
        app:layout_constraintStart_toStartOf=&quot;parent&quot;
        app:layout_constraintEnd_toEndOf=&quot;parent&quot;
        app:layout_constraintBottom_toBottomOf=&quot;parent&quot;
        /&gt;

&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;
</code></pre>
<pre><code class="kotlin">import android.content.Context
import android.os.Bundle
import android.util.AttributeSet
import android.util.Log
import android.view.View
import android.widget.Button
import androidx.fragment.app.Fragment
import androidx.fragment.app.FragmentActivity

class MainActivity : FragmentActivity() &#123;

    var f1: Button? = null

    override fun onCreate(savedInstanceState: Bundle?) &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;MainActivity onCreate&quot;)
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        f1 = findViewById(R.id.f1)

        f1()
        Log.d(&quot;swithun-xxxx&quot;, &quot;MainActivity onCreate end&quot;)
    &#125;

    override fun onStart() &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;MainActivity onStart begin&quot;)
        super.onStart()
        Log.d(&quot;swithun-xxxx&quot;, &quot;MainActivity onStart end&quot;)
    &#125;

    override fun onCreateView(name: String, context: Context, attrs: AttributeSet): View? &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;MainActivity onCreateView 1&quot;)
        return super.onCreateView(name, context, attrs)
    &#125;

    override fun onCreateView(
        parent: View?,
        name: String,
        context: Context,
        attrs: AttributeSet
    ): View? &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;MainActivity onCreateView 2&quot;)
        return super.onCreateView(parent, name, context, attrs)
    &#125;

    override fun onAttachFragment(fragment: Fragment) &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;MainActivity onAttachFragment&quot;)
        super.onAttachFragment(fragment)
    &#125;

    override fun onResume() &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;MainActivity onResume&quot;)
        super.onResume()
    &#125;

    override fun onStop() &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;MainActivity onResume&quot;)
        super.onStop()
    &#125;

    override fun onDestroy() &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;MainActivity onDestroy&quot;)
        super.onDestroy()
    &#125;

    private fun f1() &#123;
        f1?.setOnClickListener &#123;
            val transaction = supportFragmentManager.beginTransaction();
            transaction.add(R.id.content_fragment, Fragment2())
            transaction.commit()
        &#125;
    &#125;
&#125;
</code></pre>
<pre><code class="kotlin">import android.content.Context
import android.os.Bundle
import android.util.Log
import android.view.Gravity
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.FrameLayout
import android.widget.TextView
import androidx.fragment.app.Fragment

open class Fragment1: Fragment() &#123;

    open val name = &quot;fragment 1&quot;

    override fun onAttach(context: Context) &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;$name onAttach&quot;)
        super.onAttach(context)
    &#125;

    override fun onCreate(savedInstanceState: Bundle?) &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;$name onCreate&quot;)
        super.onCreate(savedInstanceState)
    &#125;

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? &#123;
        // 居中添加一个TextView——“hello Fragment1&quot;
        Log.d(&quot;swithun-xxxx&quot;, &quot;$name onCreateView&quot;)
        val view = TextView(context)
        val param = FrameLayout.LayoutParams(FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT)
        param.gravity = Gravity.CENTER
        view.layoutParams = param
        view.text = &quot;hello $name&quot;
        view.textSize = 15F
        view.gravity = Gravity.CENTER
        return view
    &#125;

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;$name onViewCreated&quot;)
        super.onViewCreated(view, savedInstanceState)
    &#125;

    override fun onActivityCreated(savedInstanceState: Bundle?) &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;$name onActivityCreated&quot;)
        super.onActivityCreated(savedInstanceState)
    &#125;

    override fun onStart() &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;$name onStart&quot;)
        super.onStart()
    &#125;

    override fun onResume() &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;$name onResume&quot;)
        super.onResume()
    &#125;

    override fun onPause() &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;$name onPause&quot;)
        super.onPause()
    &#125;

    override fun onStop() &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;$name onStop&quot;)
        super.onStop()
    &#125;

    override fun onDestroyView() &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;$name onDestroyView&quot;)
        super.onDestroyView()
    &#125;

    override fun onDestroy() &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;$name onDestroy&quot;)
        super.onDestroy()
    &#125;

    override fun onDetach() &#123;
        Log.d(&quot;swithun-xxxx&quot;, &quot;$name onDetach&quot;)
        super.onDetach()
    &#125;
&#125;
</code></pre>
<pre><code class="kotlin">class Fragment2: Fragment1() &#123;
    override val name: String = &quot;Fragment 2&quot;
&#125;
</code></pre>
<h3 id="通过xml文件添加Fragment-——-Fragment1"><a href="#通过xml文件添加Fragment-——-Fragment1" class="headerlink" title="通过xml文件添加Fragment —— Fragment1"></a>通过xml文件添加Fragment —— Fragment1</h3><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    ...

    &lt;fragment android:name=&quot;com.example.test_android.Fragment1&quot;
        android:id=&quot;@+id/prefill_fragment&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;0dp&quot;
        app:layout_constraintTop_toBottomOf=&quot;@id/f1&quot;
        app:layout_constraintStart_toStartOf=&quot;parent&quot;
        app:layout_constraintEnd_toEndOf=&quot;parent&quot;
        app:layout_constraintBottom_toTopOf=&quot;@id/content_fragment&quot;
        /&gt;
    ...

&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;
</code></pre>
<p>先从代码分析，从<code>FragmentActivity</code>.<code>onCreate</code> 开始看</p>
<ul>
<li><code>[T-1] MainActivity.onCreate</code><pre><code class="kotlin">    // MainActivity
class MainActivity : FragmentActivity() &#123;
    ...
    override fun onCreate(savedInstanceState: Bundle?) &#123;
   [:0] super.onCreate(savedInstanceState)
   [:1] setContentView(R.layout.activity_main)
</code></pre>
</li>
</ul>
<h4 id="关键节点-0-FragmentActivity-onCreate"><a href="#关键节点-0-FragmentActivity-onCreate" class="headerlink" title="关键节点 [:0] FragmentActivity.onCreate"></a>关键节点 [:0] FragmentActivity.onCreate</h4><ul>
<li><p><code>[:0] FragmentActivity.onCreate</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentActivity
    protected void onCreate(@Nullable Bundle savedInstanceState) &#123;
        ...
    [:0:1] mFragments.dispatchCreate();
    &#125;
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate</pre>

  <pre class="mermaid">    classDiagram

  class FragmentActivity {
      - FragmentController mFragments
  }
  class FragmentController

  FragmentActivity --> FragmentController: hold</pre>

<p>  可以看出  </p>
<ol>
<li><code>FragmentActivity</code>持有<code>FragmentController</code></li>
<li>通知<code>FragmentController</code>分发<code>create</code>事件</li>
</ol>
</li>
<li><p><code>[:0:1] mFragments.dispatchCreate()</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentController
    public void dispatchCreate() &#123;
   [:0:1:0] mHost.mFragmentManager.dispatchCreate();
    &#125;
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentController->>FragmentManager: dispatchCreate</pre>

  <pre class="mermaid">    classDiagram

  class FragmentActivity {
      - FragmentController mFragments
  }
  class FragmentController {
      - FragmentHostCallback<?> mHost
  }
  class FragmentManager {
      <<abstract>>
  }
  class FragmentManagerImpl
  class FragmentHostCallback {
      <<abstract>>
      - FragmentManager mFragmentManager
  }

  FragmentActivity --> FragmentController: hold
  FragmentController --> FragmentHostCallback: hold
  FragmentHostCallback --> FragmentManager: hold
  FragmentManagerImpl --|> FragmentManager: implements</pre>
<p>  可以看出</p>
<ol>
<li><code>FragmentController</code>持有<code>FragmentHostCallback</code>持有<code>FragmentManger</code></li>
<li>通知<code>FragmentManager</code>分发<code>create</code>事件</li>
</ol>
</li>
<li><p><code>[:0:1:0] mHost.mFragmentManager.dispatchCreate()</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentManager
    void dispatchCreate() &#123;
        ...
   [:0:1:0:0] dispatchStateChange(Fragment.CREATED);
        ...
    &#125;
</code></pre>
<pre><code class="java">public class Fragment implements ComponentCallbacks, OnCreateContextMenuListener, LifecycleOwner,
        ViewModelStoreOwner, HasDefaultViewModelProviderFactory, SavedStateRegistryOwner,
        ActivityResultCaller &#123;

    static final int INITIALIZING = -1;          // Not yet attached.
    static final int ATTACHED = 0;               // Attached to the host.
    static final int CREATED = 1;                // Created.
    static final int VIEW_CREATED = 2;           // View Created.
    static final int AWAITING_EXIT_EFFECTS = 3;  // Downward state, awaiting exit effects
    static final int ACTIVITY_CREATED = 4;       // Fully created, not started.
    static final int STARTED = 5;                // Created and started, not resumed.
    static final int AWAITING_ENTER_EFFECTS = 6; // Upward state, awaiting enter effects
    static final int RESUMED = 7;                // Created started and resumed.
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant FragmentManager

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentController->>FragmentManager: dispatchCreate
  FragmentManager->>FragmentManager: dispatchStateChange</pre>
<p>  可以看出</p>
<ol>
<li><code>FragmentManager</code>内部分发<code>Fragment.CREATED</code>事件——<em>Attached to the host</em></li>
</ol>
</li>
<li><p><code>[:0:1:0:0] dispatchStateChange(Fragment.CREATED)</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentManager
    private void dispatchStateChange(int nextState) &#123;
        ...
       [:0:1:0:0:0] mFragmentStore.dispatchStateChange(nextState);
       [:0:1:0:0:1] moveToState(nextState, false);
       ...
&#125;
</code></pre>
<pre><code class="java">public abstract class FragmentManager implements FragmentResultOwner &#123;
    ...
    private final FragmentStore mFragmentStore = new FragmentStore();
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant FragmentManager
  participant FragmentStore

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentController->>FragmentManager: dispatchCreate
  FragmentManager->>FragmentManager: dispatchStateChange
  FragmentManager->>FragmentStore: dispatchStateChange</pre>

  <pre class="mermaid">    classDiagram

  class FragmentActivity {
      - FragmentController mFragments
  }
  class FragmentController {
      - FragmentHostCallback<?> mHost
  }
  class FragmentManager {
      <<abstract>>
      FragmentStore mFragmentStore
  }
  class FragmentManagerImpl
  class FragmentHostCallback {
      <<abstract>>
      - FragmentManager mFragmentManager
  }
  class FragmentStore

  FragmentActivity --> FragmentController: hold
  FragmentController --> FragmentHostCallback: hold
  FragmentHostCallback --> FragmentManager: hold
  FragmentManagerImpl --|> FragmentManager: implements
  FragmentManager --> FragmentStore: hold</pre>
<p>  可以看出</p>
<ol>
<li><code>FragmentManager</code>持有一个<code>FragmentStore</code></li>
<li><code>FragmentStore</code>分发收到的状态<code>nextState</code>——<code>Fragment.CREATED</code></li>
</ol>
</li>
<li><p><code>[:0:1:0:0:0] mFragmentStore.dispatchStateChange(nextState)</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentStore
    void dispatchStateChange(int state) &#123;
        for (FragmentStateManager fragmentStateManager : mActive.values()) &#123;
            if (fragmentStateManager != null) &#123;
 [:0:1:0:0:0:0] fragmentStateManager.setFragmentManagerState(state);
            &#125;
        &#125;
    &#125;
</code></pre>
<p>  <code>mActive</code>是存储<code>FragmentStateManager</code>的<code>Map</code>:⬇️</p>
<pre><code class="java">// androidx.fragment.app.FragmentStore
class FragmentStore &#123;
    ...
    private final HashMap&lt;String, FragmentStateManager&gt; mActive = new HashMap&lt;&gt;();
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant FragmentManager
  participant FragmentStore
  participant FragmentStateManager

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentController->>FragmentManager: dispatchCreate
  FragmentManager->>FragmentManager: dispatchStateChange
  FragmentManager->>FragmentStore: dispatchStateChange
  FragmentStore->>FragmentStateManager: setFragmentManagerState</pre>

  <pre class="mermaid">    classDiagram

  class FragmentActivity {
      - FragmentController mFragments
  }
  class FragmentController {
      - FragmentHostCallback<?> mHost
  }
  class FragmentManager {
      <<abstract>>
      FragmentStore mFragmentStore
  }
  class FragmentManagerImpl
  class FragmentHostCallback {
      <<abstract>>
      - FragmentManager mFragmentManager
  }
  class FragmentStore {
      HashMap「String, FragmentStateManager」 mActive
  }
  class FragmentStateManager

  FragmentActivity --> FragmentController: hold
  FragmentController --> FragmentHostCallback: hold
  FragmentHostCallback --> FragmentManager: hold
  FragmentManagerImpl --|> FragmentManager: implements
  FragmentManager --> FragmentStore: hold
  FragmentStore "1" --> "n" FragmentStateManager: hold</pre>
<p>  可以看出</p>
<ol>
<li><code>FragmentStore</code>持有n个<code>FragmentStateManager</code></li>
<li><code>FragmentManager</code>将收到的状态分发给每一个<code>FragmentStateManager</code></li>
</ol>
<p>  <strong>[总结]</strong>: 由于<code>FragmentActivity</code>此时尚未<code>setContentView</code>，所以<code>FragmentManger</code>管理的<code>Fragment</code>数量实际上为0，<code>mActive</code>自然为0。但是我们仍然继续看下如果不为0会继续做什么。</p>
</li>
<li><p><code>[:0:1:0:0:0:0] fragmentStateManager.setFragmentManagerState(state)</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentStateManager
    void setFragmentManagerState(int state) &#123;
        mFragmentManagerState = state;
    &#125;
</code></pre>
<pre><code class="java">// androidx.fragment.app.FragmentStateManager
class FragmentStateManager &#123;
    ...
    private final Fragment mFragment;
    private int mFragmentManagerState = Fragment.INITIALIZING;
</code></pre>
  <pre class="mermaid">    classDiagram

  class FragmentActivity {
      - FragmentController mFragments
  }
  class FragmentController {
      - FragmentHostCallback<?> mHost
  }
  class FragmentManager {
      <<abstract>>
      FragmentStore mFragmentStore
  }
  class FragmentManagerImpl
  class FragmentHostCallback {
      <<abstract>>
      - FragmentManager mFragmentManager
  }
  class FragmentStore {
      HashMap「String, FragmentStateManager」 mActive
  }
  class FragmentStateManager {
      Fragment mFragment
      int mFragmentManagerState
  }
  class Fragment

  FragmentActivity --> FragmentController: hold
  FragmentController --> FragmentHostCallback: hold
  FragmentHostCallback --> FragmentManager: hold
  FragmentManagerImpl --|> FragmentManager: implements
  FragmentManager --> FragmentStore: hold
  FragmentStore "1" --> "n" FragmentStateManager: hold
  FragmentStateManager --> Fragment: hold</pre>
<p>  可以看出</p>
<ol>
<li><code>FragmentStateManager</code> 1:1 持有<code>Fragment</code></li>
<li><code>FragmentStateManaget</code>持有变量<code>mFragmentManagerState</code>——所属的FragmentManager的状态</li>
</ol>
<p>  至此，<code>FragmentActivity</code>将<code>CREATE</code>状态通知到<code>FragmentManager</code>进而通知到管理的每个<code>FragmentStateManager</code>——但是此时Fragment尚未更新。</p>
<p>  <strong>[总结]</strong>: （只关心重要的<code>FragmentActivity</code>,<code>FragmentManager</code>,<code>Fragment</code>）  </p>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentManager
  participant Fragment
  
  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentManager: dispatchCreate() 分发CREATE</pre>
</li>
<li><p><code>[:0:1:0:0:1] moveToState(nextState, false);</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentManager
    void moveToState(int newState, boolean always) &#123;
        ...
            mFragmentStore.moveToExpectedState();
        ...
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant FragmentManager
  participant FragmentStore

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentController->>FragmentManager: dispatchCreate
  FragmentManager->>FragmentManager: dispatchStateChange
  FragmentManager->>FragmentStore: dispatchStateChange
  FragmentManager->>FragmentManager: moveToState</pre>

<p>  <code>[:0:1:0:0:0:0]</code>只是将用来管理<code>Fragment</code>的<code>FragmentStateManager</code>的状态更新了，这里才是真正更新<code>Fragment</code>的状态——但是此时<code>FragmentManager</code>管理的<code>Fragment</code>数量实际上为0，所以这里先不继续看，后续流程下面<code>[:1:0:0:1]</code>会继续讲到。</p>
</li>
</ul>
<h4 id="关键节点-1-setContentView-R-layout-activity-main"><a href="#关键节点-1-setContentView-R-layout-activity-main" class="headerlink" title="关键节点 [:1] setContentView(R.layout.activity_main)"></a>关键节点 [:1] setContentView(R.layout.activity_main)</h4><ul>
<li><p><code>[:1] setContentView(R.layout.activity_main)</code><br>  执行<code>[:0] super.onCreate(savedInstanceState)</code>之后，setContentView</p>
<pre><code class="java">// androidx.activity.ComponentActivity
    @Override
    public void setContentView(@LayoutRes int layoutResID) &#123;
        ...
    [:1:0] super.setContentView(layoutResID);
    &#125;
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant Activity

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentActivity->>Activity: setContentView</pre>

  <pre class="mermaid">    classDiagram

  class FragmentActivity {
      - FragmentController mFragments
  }
  class FragmentController
  class Activity

  FragmentActivity --> FragmentController: hold
  FragmentActivity --|> Activity</pre>
</li>
<li><p><code>[:1:0] super.setContentView(layoutResID);</code><br>  <code>ComponentActivity</code>调用父类<code>Activity</code>.<code>setContentView</code></p>
<pre><code class="java">// android.app.Activity
    public void setContentView(@LayoutRes int layoutResID) &#123;
   [:1:0:0] getWindow().setContentView(layoutResID);
   ...
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant Activity
  participant Window

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentActivity->>Activity: setContentView
  Activity->>Window: setContentView</pre>

  <pre class="mermaid">    classDiagram

  class FragmentActivity {
      - FragmentController mFragments
  }
  class FragmentController
  class Activity {
      - Window mWindow
  }

  FragmentActivity --> FragmentController: hold
  FragmentActivity --|> Activity
  Activity --> Window: hold</pre>
</li>
<li><p><code>[:1:0:0] getWindow().setContentView(layoutResID);</code><br>  <code>Window</code>.<code>setContentView</code></p>
<pre><code class="java">// android.view.Window
    public abstract void setContentView(@LayoutRes int layoutResID);
</code></pre>
<p>  继续-跳过细节 根据传入的layout ResId 初始化 view</p>
<pre><code class="java">// com.android.internal.policy.PhoneWindow
    @Override
    public void setContentView(int layoutResID) &#123;
        ...
        [...]    mLayoutInflater.inflate(layoutResID, mContentParent);
        ...
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant Activity
  participant PhoneWindow
  participant LayoutInflater

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentActivity->>Activity: setContentView
  Activity->>PhoneWindow: setContentView
  PhoneWindow->>LayoutInflater: inflate</pre>

  <pre class="mermaid">    classDiagram

  class FragmentActivity {
      - FragmentController mFragments
  }
  class FragmentController
  class Activity {
      - Window mWindow
  }
  class PhoneWindow {
      - LayoutInflater mLayoutInflater
  }
  class LayoutInflater

  FragmentActivity --> FragmentController: hold
  FragmentActivity --|> Activity
  Activity --> Window: hold
  PhoneWindow --|> Window
  PhoneWindow --> LayoutInflater: hold</pre>

<p>  <code>mContentParent</code>为<code>PhoneWindow</code>的根View，下面会根据<code>layoutResID</code>构造<code>View</code>并add到<code>mContentParent</code><br>  继续-跳过细节 根据传入的layout ResId 初始化 view</p>
<pre><code class="java">// android.view.LayoutInflater
    public View inflate(@LayoutRes int resource, @Nullable ViewGroup root) &#123;
        return inflate(resource, root, root != null);
</code></pre>
<pre><code class="java">// android.view.LayoutInflater
    public View inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot) &#123;
        [...] return inflate(parser, root, attachToRoot);
        ...
    &#125;
</code></pre>
<p>  <code>attachToRoot</code>为true(<code>root != null</code>)  </p>
<pre><code class="java">    // android.view.LayoutInflater
    public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot) &#123;
        synchronized (mConstructorArgs) &#123;
            ...
                advanceToRootNode(parser); // 让parser移动到下一个要解析的&quot;结点&quot;
                final String name = parser.getName(); // 获取结点名字
                ...
                    // 根据名字构造xml的根view
                    final View temp = createViewFromTag(root, name, inflaterContext, attrs);
                ...
                    // 继续递归构造xml根view的子view，并addView到根view
                    rInflateChildren(parser, temp, attrs, true);
</code></pre>
<p>  根据<code>xml parser</code>构造<code>View</code>，<code>temp</code>是<code>xml</code>的根标签代表的view，根据<code>activity_main.xml</code><br>  <code>xml-1</code> ⬇️</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;androidx.constraintlayout.widget.ConstraintLayout     ...&gt;
    &lt;Button..&gt;

    &lt;fragment android:name=&quot;com.example.test_android.Fragment1&quot;...&gt;

    &lt;FrameLayout
        android:id=&quot;@+id/content_fragment&quot;...&gt;

&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;
</code></pre>
<p>  <code>name</code>则为根标签<code>androidx.constraintlayout.widget.ConstraintLayout</code>，<br>  <code>temp</code>相应的则是<code>androidx.constraintlayout.widget.ConstraintLayout</code>，<br>  下面<code>rInflateChildren</code>则是继续递归的构造<code>ConstraintLayout</code>中的子view。(开头的<code>r</code>代表的是<em>Recursive</em>–<em>递归</em>)</p>
<pre><code class="java">// android.view.LayoutInflater
    final void rInflateChildren(XmlPullParser parser, View parent, AttributeSet attrs,
            boolean finishInflate) throws XmlPullParserException, IOException &#123;
        rInflate(parser, parent, parent.getContext(), attrs, finishInflate);
</code></pre>
<pre><code class="java">// android.view.LayoutInflater
    void rInflate(XmlPullParser parser, View parent, Context context,
            AttributeSet attrs, boolean finishInflate) throws XmlPullParserException, IOException &#123;
        ...
            while (((type = parser.next()) != XmlPullParser.END_TAG ||
                ...
                final View view = createViewFromTag(parent, name, context, attrs);
        ...
</code></pre>
<p>  <code>rInflate</code>: 继续递归构造<code>temp</code>的子view<br>  <code>parser.next</code>: 不断的获取下一个要解析的标签，根据<code>xml-1</code>，会解析到 <code>&lt;fragment</code>标签——通过<code>createViewFromTag</code>构造Fragment</p>
<pre><code class="java">// android.view.LayoutInflater
    private View createViewFromTag(View parent, String name, Context context, AttributeSet attrs) &#123;
        return createViewFromTag(parent, name, context, attrs, false);
</code></pre>
<pre><code class="java">// android.view.LayoutInflater
    View createViewFromTag(View parent, String name, Context context, AttributeSet attrs,
        ...
            View view = tryCreateView(parent, name, context, attrs);
        ...
</code></pre>
<p>  构造fragment view</p>
<pre><code class="java">// android.view.LayoutInflater
    public final View tryCreateView(@Nullable View parent, @NonNull String name,
        ...
            view = mPrivateFactory.onCreateView(parent, name, context, attrs);
        ...
</code></pre>
<pre><code class="java">// android.view.LayoutInflater
    private Factory2 mPrivateFactory;
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant Activity
  participant PhoneWindow
  participant LayoutInflater
  participant `LayoutInflater-Factory2`

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentActivity->>Activity: setContentView
  Activity->>PhoneWindow: setContentView
  PhoneWindow->>LayoutInflater: inflate
  LayoutInflater->>`LayoutInflater-Factory2`: onCreateView</pre>

  <pre class="mermaid">    classDiagram

  class FragmentActivity {
      - FragmentController mFragments
  }
  class FragmentController
  class Activity {
      - Window mWindow
  }
  class PhoneWindow {
      - LayoutInflater mLayoutInflater
  }
  class LayoutInflater
  class `LayoutInflater-Factory2`

  FragmentActivity --> FragmentController: hold
  FragmentActivity --|> Activity
  Activity --> Window: hold
  PhoneWindow --|> Window
  PhoneWindow --> LayoutInflater: hold
  Activity --|> `LayoutInflater-Factory2`
  LayoutInflater --> `LayoutInflater-Factory2`: hold</pre>


<p>  <code>mPrivateFactory</code>实际上是我们写的的<code>MainActivity</code>，所以继续会走到<code>MainActivity.onCreateView</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentActivity
    public View onCreateView(@Nullable View parent, @NonNull String name, @NonNull Context context,
            @NonNull AttributeSet attrs) &#123;
        final View v = dispatchFragmentsOnCreateView(parent, name, context, attrs);
        if (v == null) &#123;
            return super.onCreateView(parent, name, context, attrs);
        &#125;
        return v;
    &#125;
</code></pre>
<p>  <code>@param View parent</code>: xml的根布局<code>ConstraintLayout</code><br>  <code>@param String name</code>: <code>fragment</code>，也就是<code>xml-1</code>中的<code>fragment</code>标签<br>  <code>dispatchFragmentsOnCreateView(</code>: 会先尝试通过该方法处理<code>fragment</code>标签对应的View，如果有返回结果则跳过<code>if (v == null)</code>中的逻辑，我们这里<code>name</code>为<code>framgment</code>，所以不应该返回null。</p>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant Activity
  participant PhoneWindow
  participant LayoutInflater
  participant LayoutInflater-Factory2

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentActivity->>Activity: setContentView
  Activity->>PhoneWindow: setContentView
  PhoneWindow->>LayoutInflater: inflate
  LayoutInflater->>LayoutInflater-Factory2: onCreateView
  LayoutInflater-Factory2->>FragmentActivity: onCreateView</pre>

  <pre class="mermaid">    classDiagram

  class FragmentActivity {
      - FragmentController mFragments
  }
  class FragmentController
  class Activity {
      - Window mWindow
  }
  class PhoneWindow {
      - LayoutInflater mLayoutInflater
  }
  class LayoutInflater
  class LayoutInflater-Factory2

  FragmentActivity --> FragmentController: hold
  FragmentActivity --|> Activity
  Activity --> Window: hold
  PhoneWindow --|> Window
  PhoneWindow --> LayoutInflater: hold
  Activity --|> LayoutInflater-Factory2
  LayoutInflater --> LayoutInflater-Factory2: hold</pre>

<pre><code class="java">// androidx.fragment.app.FragmentActivity
    @Nullable
    final View dispatchFragmentsOnCreateView(@Nullable View parent, @NonNull String name,
            @NonNull Context context, @NonNull AttributeSet attrs) &#123;
        return mFragments.onCreateView(parent, name, context, attrs);
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant Activity
  participant PhoneWindow
  participant LayoutInflater
  participant LayoutInflater-Factory2

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentActivity->>Activity: setContentView
  Activity->>PhoneWindow: setContentView
  PhoneWindow->>LayoutInflater: inflate
  LayoutInflater->>LayoutInflater-Factory2: onCreateView
  LayoutInflater-Factory2->>FragmentActivity: onCreateView
  FragmentActivity->>FragmentController: onCreateView</pre>

<pre><code class="java">// androidx.fragment.app.FragmentController
    public View onCreateView(@Nullable View parent, @NonNull String name, @NonNull Context context,
            @NonNull AttributeSet attrs) &#123;
        return mHost.mFragmentManager.getLayoutInflaterFactory()
                .onCreateView(parent, name, context, attrs);
    &#125;
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant Activity
  participant PhoneWindow
  participant LayoutInflater
  participant LayoutInflater-Factory2
  participant FragmentLayoutInflaterFactory

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentActivity->>Activity: setContentView
  Activity->>PhoneWindow: setContentView
  PhoneWindow->>LayoutInflater: inflate
  LayoutInflater->>LayoutInflater-Factory2: onCreateView
  LayoutInflater-Factory2->>FragmentActivity: onCreateView
  FragmentActivity->>FragmentController: onCreateView
  FragmentController->>FragmentLayoutInflaterFactory: onCreateView</pre>

  <pre class="mermaid">    classDiagram

  class FragmentActivity {
      - FragmentController mFragments
  }
  class FragmentController {
      FragmentHostCallback<?> mHost
  }
  class Activity {
      - Window mWindow
  }
  class PhoneWindow {
      - LayoutInflater mLayoutInflater
  }
  class LayoutInflater
  class `LayoutInflater-Factory2`
  class FragmentManager {
      FragmentLayoutInflaterFactory mLayoutInflaterFactory
  }
  class FragmentHostCallback {
      <<abstract>>
      FragmentManager mFragmentManager
  }
  class FragmentLayoutInflaterFactory

  FragmentActivity --> FragmentController: hold
  FragmentActivity --|> Activity
  Activity --> Window: hold
  PhoneWindow --|> Window
  PhoneWindow --> LayoutInflater: hold
  Activity --|> `LayoutInflater-Factory2`
  LayoutInflater --> `LayoutInflater-Factory2`: hold
  FragmentController --> FragmentHostCallback: hold
  FragmentHostCallback --> FragmentManager: hold
  FragmentManager --> FragmentLayoutInflaterFactory: hold</pre>

<p>  return <code>FragmentActivity.dispatchFragmentsOnCreateView</code> $\rightarrow$ return <code>FragmentController.onCreateView</code> $\rightarrow$ return <code>FragmentLayoutInflaterFactory.onCreateView</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentLayoutInflaterFactory
    public View onCreateView(@Nullable final View parent, @NonNull String name,
        ...
            // new Fragment
            fragment = mFragmentManager.getFragmentFactory().instantiate(
            context.getClassLoader(), fname);
            // fragment 的属性设置 begin
            fragment.mFromLayout = true;
            fragment.mFragmentId = id != 0 ? id : containerId;
            fragment.mContainerId = containerId;
            fragment.mTag = tag;
            fragment.mInLayout = true;
            fragment.mFragmentManager = mFragmentManager;
            fragment.mHost = mFragmentManager.getHost();
            fragment.onInflate(mFragmentManager.getHost().getContext(), attrs,
                    fragment.mSavedFragmentState);
            // fragment 的属性设置 end

            // 添加到mFragmentManager中，同时返回 持有Fragment的FragmentStateManager
            fragmentStateManager = mFragmentManager.addFragment(fragment);
            // 此时Fragment这个壳已经初始化，但是Fragment.mView实际上还没有构造
        ...
        // 通过FragmentStateManager更新他持有的一对一的Fragment的State
   [:1:0:0:1] fragmentStateManager.moveToExpectedState();
        // 确保走到这行代码是Fragment已经构造好view
   [B2] fragmentStateManager.ensureInflatedView();
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant Activity
  participant PhoneWindow
  participant LayoutInflater
  participant LayoutInflater-Factory2
  participant FragmentLayoutInflaterFactory
  participant Fragment
  participant FragmentStateManager

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentActivity->>Activity: setContentView
  Activity->>PhoneWindow: setContentView
  PhoneWindow->>LayoutInflater: inflate
  LayoutInflater->>LayoutInflater-Factory2: onCreateView
  LayoutInflater-Factory2->>FragmentActivity: onCreateView
  FragmentActivity->>FragmentController: onCreateView
  FragmentController->>FragmentLayoutInflaterFactory: onCreateView
  FragmentLayoutInflaterFactory->>Fragment: new
  FragmentLayoutInflaterFactory->>FragmentManager: addFragment
  FragmentManager->>FragmentLayoutInflaterFactory: addFragment return FragmentStateManager
  FragmentLayoutInflaterFactory->>FragmentStateManager: moveToExpectedState</pre>

  <pre class="mermaid">    classDiagram

  class FragmentActivity {
      - FragmentController mFragments
  }
  class FragmentController {
      FragmentHostCallback<?> mHost
  }
  class Activity {
      - Window mWindow
  }
  class PhoneWindow {
      - LayoutInflater mLayoutInflater
  }
  class LayoutInflater
  class `LayoutInflater-Factory2`
  class FragmentManager {
      FragmentLayoutInflaterFactory mLayoutInflaterFactory
  }
  class FragmentHostCallback {
      <<abstract>>
      FragmentManager mFragmentManager
  }
  class FragmentLayoutInflaterFactory {
      FragmentManager mFragmentManager
  }

  FragmentActivity --> FragmentController: hold
  FragmentActivity --|> Activity
  Activity --> Window: hold
  PhoneWindow --|> Window
  PhoneWindow --> LayoutInflater: hold
  Activity --|> `LayoutInflater-Factory2`
  LayoutInflater --> `LayoutInflater-Factory2`: hold
  FragmentController --> FragmentHostCallback: hold
  FragmentHostCallback --> FragmentManager: hold
  FragmentManager --> FragmentLayoutInflaterFactory: hold
  FragmentLayoutInflaterFactory --> FragmentManager: ref</pre>

<ul>
<li><code>fragmentStateManager = mFragmentManager.addFragment(fragment);</code>: 将新建的<code>Fragment</code>添加到<code>FragmentManager</code>中进行管理。</li>
</ul>
</li>
<li><p><code>[:1:0:0:1] fragmentStateManager.moveToExpectedState();</code><br>  通过FragmentStateManager更新他持有的一对一的Fragment的State  </p>
<pre><code class="java">// androidx.fragment.app.FragmentStateManager
    void moveToExpectedState() &#123;
        ...
            int newState;
     [:1:0:0:1:0] while ((newState = computeExpectedState()) != mFragment.mState) &#123;
                if (newState &gt; mFragment.mState) &#123;
                    // Moving upward
                    int nextStep = mFragment.mState + 1;
                    switch (nextStep) &#123;
                        case Fragment.ATTACHED:
                     [:1:0:0:1:1] attach();
                        case Fragment.CREATED:
                     [:1:0:0:1:2] create();
                            break;
                        case Fragment.VIEW_CREATED:
                     [:1:0:0:1:3] ensureInflatedView();
                     [:1:0:0:1:4] createView();
                            break;
</code></pre>
</li>
<li><p><code>[:1:0:0:1:0] while ((newState = computeExpectedState()) != mFragment.mState) &#123;</code></p>
<ul>
<li><code>computeExpectedState()</code>: 根据FragmentManager等等计算mFragment应该达到的状态，先不看这里的复杂计算，但是最终的结果是2，对应<code>Fragment.VIEW_CREATED</code>，即Fragment应该进行到构造好View的状态</li>
<li><code>while</code>: <code>mFragment</code>不断切换到下一个状态，直到达到目标状态——<code>VIEW_CREATED</code></li>
<li><code>mFragment.mState</code>: 当前<code>mFragment.mState</code>为<code>INITIALIZING</code>，则表示会依次执行<code>FragmentManager.attach()</code>、<code>FragmentManager.create()</code>、<code>FragmentManager.createView()</code></li>
</ul>
<pre><code class="java">    static final int INITIALIZING = -1;          // Not yet attached.
    static final int ATTACHED = 0;               // Attached to the host.
    static final int CREATED = 1;                // Created.
    static final int VIEW_CREATED = 2;           // View Created.
    static final int AWAITING_EXIT_EFFECTS = 3;  // Downward state, awaiting exit effects
    static final int ACTIVITY_CREATED = 4;       // Fully created, not started.
    static final int STARTED = 5;                // Created and started, not resumed.
    static final int AWAITING_ENTER_EFFECTS = 6; // Upward state, awaiting enter effects
    static final int RESUMED = 7;                // Created started and resumed.
</code></pre>
</li>
<li><p><code>[:1:0:0:1:1] attach();</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentStateManager
    void attach() &#123;
        ....
 [:1:0:0:1:1:0] mFragment.performAttach();
        mDispatcher.dispatchOnFragmentAttached(mFragment, false);
    &#125;
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant FragmentActivity
  participant FragmentController
  participant Activity
  participant PhoneWindow
  participant LayoutInflater
  participant LayoutInflater-Factory2
  participant FragmentLayoutInflaterFactory
  participant Fragment
  participant FragmentStateManager

  FragmentActivity->>FragmentActivity: onCreate begin
  FragmentActivity->>FragmentController: dispatchCreate
  FragmentActivity->>Activity: setContentView
  Activity->>PhoneWindow: setContentView
  PhoneWindow->>LayoutInflater: inflate
  LayoutInflater->>LayoutInflater-Factory2: onCreateView
  LayoutInflater-Factory2->>FragmentActivity: onCreateView
  FragmentActivity->>FragmentController: onCreateView
  FragmentController->>FragmentLayoutInflaterFactory: onCreateView
  FragmentLayoutInflaterFactory->>Fragment: new
  FragmentLayoutInflaterFactory->>FragmentManager: addFragment
  FragmentManager->>FragmentLayoutInflaterFactory: addFragment return FragmentStateManager
  FragmentLayoutInflaterFactory->>FragmentStateManager: moveToExpectedState
  FragmentStateManager->>Fragment: performAttach</pre>
</li>
<li><p><code>[:1:0:0:1:1:0] mFragment.performAttach()</code></p>
<pre><code class="java">// androidx.fragment.app.Fragment
    void performAttach() &#123;
        ...
        mState = ATTACHED;
        onAttach(mHost.getContext());
        ...
        mChildFragmentManager.dispatchAttach();
    &#125;
</code></pre>
<ul>
<li><code>mState = ATTACHED</code>: 更新<code>Fragment</code>状态为<code>ATTACHED</code></li>
</ul>
<pre><code class="java">// androidx.fragment.app.Fragment
    public void onAttach(@NonNull Context context) &#123;
        mCalled = true;
        final Activity hostActivity = mHost == null ? null : mHost.getActivity();
        if (hostActivity != null) &#123;
            mCalled = false;
            onAttach(hostActivity);
        &#125;
    &#125;
</code></pre>
<pre><code class="java">// androidx.fragment.app.Fragment
    public void onAttach(@NonNull Activity activity) &#123;
        mCalled = true;
    &#125;
</code></pre>
</li>
</ul>
<p><strong>至此，<code>Fragment</code>的状态由<code>INITIALIZING</code>切换到<code>ATTACHED</code>切换到<code>CREATED</code>切换到<code>VIEW_CREATED</code>，关键方法是<code>B1</code>-<code>fragmentStateManager.moveToExpectedState</code>，不断的将<code>FragmentStateManager</code>所管理的所有<code>Fragment</code>推动到应该达到的状态。</strong></p>
<pre class="mermaid">sequenceDiagram
autonumber

participant FragmentActivity
participant FragmentManager
participant Fragment

activate FragmentActivity
FragmentActivity->>FragmentActivity: onCreate begin
FragmentActivity->>FragmentManager: dispatchCreate() 分发CREATE
FragmentActivity->>FragmentActivity: setContentView begin
FragmentActivity->>FragmentActivity: onCreateView
FragmentActivity->>FragmentManager: moveToExpectedState
FragmentManager->>Fragment: performAttach
Fragment->>Fragment: onAttach
FragmentManager->>Fragment: performCreate
FragmentManager->>Fragment: performCreateView

FragmentActivity->>FragmentActivity: onCreate end 
deactivate FragmentActivity

FragmentActivity->>FragmentActivity: onStart</pre>

<p>以上以<code>Create</code>为例，了解了<code>FragmentActivity</code>的状态对<code>Fragment</code>的状态影响以及<code>FragmentActivity</code>, <code>FragmentController</code>, <code>FragmentManager</code>, <code>FragmentStateManager</code>, <code>Fragment</code>中间的关系。</p>
<pre><code>MainActivity onCreate
MainActivity onCreateView 2
MainActivity onCreateView 1
MainActivity onCreateView 2
MainActivity onCreateView 1
MainActivity onCreateView 2
MainActivity onCreateView 1
MainActivity onCreateView 2
MainActivity onCreateView 1
MainActivity onCreateView 2
MainActivity onCreateView 1
MainActivity onCreateView 2
fragment 1 onAttach
MainActivity onAttachFragment
fragment 1 onCreate
fragment 1 onCreateView
fragment 1 onViewCreated
MainActivity onCreateView 2
MainActivity onCreateView 1
MainActivity onCreate end
MainActivity onStart begin
fragment 1 onActivityCreated
fragment 1 onStart
MainActivity onStart end
MainActivity onResume
fragment 1 onResumek
</code></pre>
<p>简单总结：</p>
<table>
<thead>
<tr>
<th>Activity 生命周期回调</th>
<th>Fragment 生命周期回调</th>
</tr>
</thead>
<tbody><tr>
<td>onCreate</td>
<td>- onAttach <br> - onCreate <br> - onCreateView <br> - onViewCreated</td>
</tr>
<tr>
<td>onStart</td>
<td>- onActivityCreated <br> - onStart</td>
</tr>
<tr>
<td>onResume</td>
<td>- onResume</td>
</tr>
</tbody></table>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>总结以上，<code>FragmentActivity</code> <code>onCreate</code> 时将 <code>Create</code> 事件 $\xrightarrow{1:通知:1}$ <code>FragmentController</code> $\xrightarrow{1:通知:1}$ <code>FragmentManager</code> $\xrightarrow{1:通知:n}$ 持有的每个 <code>FragmentStateManager</code> $\xrightarrow{1:通知:1}$ <code>Fragment</code>。</p>
<h3 id="代码中动态添加Fragment"><a href="#代码中动态添加Fragment" class="headerlink" title="代码中动态添加Fragment"></a>代码中动态添加Fragment</h3><pre><code class="kotlin">// MainActivity
    private fun f1() &#123;
        f1?.setOnClickListener &#123;
       [:2] val transaction = supportFragmentManager.beginTransaction()
       [:3] transaction.add(R.id.content_fragment, Fragment2())
       [:4] transaction.commit()
        &#125;
    &#125;
</code></pre>
<ul>
<li><p><code>[:2] val transaction = supportFragmentManager.beginTransaction()</code></p>
<pre><code class="kotlin">// androidx.fragment.app.FragmentManager
    public FragmentTransaction beginTransaction() &#123;
        return new BackStackRecord(this);
    &#125;
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant MainActivity
  participant FragmentManager
  participant FragmentTransaction
  participant BackStackRecord

  MainActivity ->> FragmentManager: beginTransaction
  FragmentManager ->> FragmentTransaction: new
  FragmentManager ->> BackStackRecord: new
  FragmentManager ->> MainActivity: return (FragmentTransaction)BackStackRecord</pre>

  <pre class="mermaid">    classDiagram
  class FragmentTransaction
  class BackStackRecord
  class FragmentManager
  class `FragmentManager-BackStackEntry`
  class `FragmentManager-OpGenerator`

  BackStackRecord --|> FragmentTransaction: extends
  BackStackRecord --|> `FragmentManager-BackStackEntry`: impl
  BackStackRecord --|>` FragmentManager-OpGenerator`: impl
  FragmentManager --> BackStackRecord: create</pre></li>
<li><p><code>[:3] transaction.add(R.id.content_fragment, Fragment2())</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentTransaction
    public FragmentTransaction add(@IdRes int containerViewId, @NonNull Fragment fragment) &#123;
   [:3:0] doAddOp(containerViewId, fragment, null, OP_ADD);
        return this;
    &#125;
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant MainActivity
  participant FragmentManager
  participant FragmentTransaction
  participant BackStackRecord

  MainActivity ->> FragmentManager: beginTransaction
  FragmentManager ->> FragmentTransaction: new
  FragmentManager ->> BackStackRecord: new
  FragmentManager ->> MainActivity: return (FragmentTransaction)BackStackRecord
  MainActivity ->> FragmentTransaction: add</pre>

<p>  其中<code>OP_ADD</code>⬇️ &#x3D; 1</p>
<pre><code class="java">// androidx.fragment.app.FragmentTransaction
    static final int OP_NULL = 0;
    static final int OP_ADD = 1;
    static final int OP_REPLACE = 2;
    static final int OP_REMOVE = 3;
    static final int OP_HIDE = 4;
    static final int OP_SHOW = 5;
    static final int OP_DETACH = 6;
    static final int OP_ATTACH = 7;
    static final int OP_SET_PRIMARY_NAV = 8;
    static final int OP_UNSET_PRIMARY_NAV = 9;
    static final int OP_SET_MAX_LIFECYCLE = 10;
</code></pre>
</li>
<li><p><code>[:3:0] doAddOp(containerViewId, fragment, null, OP_ADD)</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentTransaction
    void doAddOp(int containerViewId, Fragment fragment, @Nullable String tag, int opcmd) &#123;
        ...
   [:3:0:1] addOp(new Op(opcmd, fragment));
    &#125;
</code></pre>
</li>
<li><p><code>[:3:0:1] addOp(new Op(opcmd, fragment))</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentTransaction
    void addOp(Op op) &#123;
        mOps.add(op);
        ...
    &#125;
</code></pre>
<pre><code class="java">// androidx.fragment.app.FragmentTransaction
    ArrayList&lt;Op&gt; mOps = new ArrayList&lt;&gt;();
</code></pre>
  <pre class="mermaid">    classDiagram
  class FragmentTransaction {
      mOps: ArrayList<OP>
  }
  class BackStackRecord
  class FragmentManager
  class `FragmentManager-BackStackEntry`
  class `FragmentManager-OpGenerator`
  class `FragmentTransaction-Op` {
      mCmd: int
      mFragment: Fragment
  }

  BackStackRecord --|> FragmentTransaction: extends
  BackStackRecord --|> `FragmentManager-BackStackEntry`: impl
  BackStackRecord --|> `FragmentManager-OpGenerator`: impl
  FragmentManager --> BackStackRecord: create
  FragmentTransaction --> `FragmentTransaction-Op`: holds</pre>

<p>  <code>FragmentTransaction</code> 中有一个 <code>Op</code> list记录我们添加的操作——<code>OP_ADD</code></p>
</li>
<li><p><code>[:4] transaction.commit()</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentTransaction
    public abstract int commit();
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant MainActivity
  participant FragmentManager
  participant FragmentTransaction
  participant BackStackRecord

  MainActivity ->> FragmentManager: beginTransaction
  FragmentManager ->> FragmentTransaction: new
  FragmentManager ->> BackStackRecord: new
  FragmentManager ->> MainActivity: return (FragmentTransaction)BackStackRecord
  MainActivity ->> FragmentTransaction: add
  MainActivity ->> FragmentTransaction: commit</pre>

<pre><code class="java">// androidx.fragment.app.BackStackRecord
    @Override
    public int commit() &#123;
        return commitInternal(false);
    &#125;
</code></pre>
<pre><code class="java">    // androidx.fragment.app.BackStackRecord
    int commitInternal(boolean allowStateLoss) &#123;
        ...
    [:4:0] mManager.enqueueAction(this, allowStateLoss);
        ...
    &#125;
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant MainActivity
  participant FragmentManager
  participant FragmentTransaction
  participant BackStackRecord

  MainActivity ->> FragmentManager: beginTransaction
  FragmentManager ->> FragmentTransaction: new
  FragmentManager ->> BackStackRecord: new
  FragmentManager ->> MainActivity: return (FragmentTransaction)BackStackRecord
  MainActivity ->> FragmentTransaction: add
  MainActivity ->> FragmentTransaction: commit
  FragmentTransaction ->> FragmentManager: enqueueAction</pre>
</li>
<li><p><code>[:4:0] mManager.enqueueAction(this, allowStateLoss);</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentManager
    void enqueueAction(@NonNull OpGenerator action, boolean allowStateLoss) &#123;
        ...
            mPendingActions.add(action);
   [:4:0:0] scheduleCommit();
        ...
    &#125;
</code></pre>
<pre><code class="java">// androidx.fragment.app.FragmentManager
    private final ArrayList&lt;OpGenerator&gt; mPendingActions = new ArrayList&lt;&gt;();
</code></pre>
<pre><code class="java">// androidx.fragment.app.FragmentManager
    interface OpGenerator &#123;
        /**
         * Generate transactions to add to &#123;@code records&#125; and whether or not the transaction is
         * an add or pop to &#123;@code isRecordPop&#125;.
         *
         * records and isRecordPop must be added equally so that each transaction in records
         * matches the boolean for whether or not it is a pop in isRecordPop.
         *
         * @param records A list to add transactions to.
         * @param isRecordPop A list to add whether or not the transactions added to records is
         *                    a pop transaction.
         * @return true if something was added or false otherwise.
         */
        boolean generateOps(@NonNull ArrayList&lt;BackStackRecord&gt; records,
                @NonNull ArrayList&lt;Boolean&gt; isRecordPop);
    &#125;
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant MainActivity
  participant FragmentManager
  participant FragmentTransaction
  participant BackStackRecord

  MainActivity ->> FragmentManager: beginTransaction
  FragmentManager ->> FragmentTransaction: new
  FragmentManager ->> BackStackRecord: new
  FragmentManager ->> MainActivity: return (FragmentTransaction)BackStackRecord
  MainActivity ->> FragmentTransaction: add
  MainActivity ->> FragmentTransaction: commit
  FragmentTransaction ->> FragmentManager: enqueueAction
  FragmentManager ->> FragmentManager: mPendingActions.add</pre>

  <pre class="mermaid">    classDiagram
  class FragmentTransaction {
      mOps: ArrayList"OP"
  }
  class BackStackRecord
  class FragmentManager {
      mPendingActions: ArrayList"OpGenerator"
  }
  class `FragmentManager-BackStackEntry`
  class `FragmentManager-OpGenerator`
  class `FragmentTransaction-Op` {
      mCmd: int
      mFragment: Fragment
  }

  BackStackRecord --|> FragmentTransaction: extends
  BackStackRecord --|> `FragmentManager-BackStackEntry`: impl
  BackStackRecord --|> `FragmentManager-OpGenerator`: impl
  FragmentManager --> BackStackRecord: create
  FragmentTransaction --> `FragmentTransaction-Op`: holds
  FragmentManager --> `FragmentManager-OpGenerator`: holds</pre>
</li>
<li><p><code>[:4:0:0] scheduleCommit();</code></p>
<pre><code class="java">// androidx.fragment.app.FragmentManager
    void scheduleCommit() &#123;
        synchronized (mPendingActions) &#123;
                ...
      [:4:0:0:0] mHost.getHandler().post(mExecCommit);
                ...
    &#125;
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant MainActivity
  participant FragmentManager
  participant FragmentTransaction
  participant BackStackRecord

  MainActivity ->> FragmentManager: beginTransaction
  FragmentManager ->> FragmentTransaction: new
  FragmentManager ->> BackStackRecord: new
  FragmentManager ->> MainActivity: return (FragmentTransaction)BackStackRecord
  MainActivity ->> FragmentTransaction: add
  MainActivity ->> FragmentTransaction: commit
  FragmentTransaction ->> FragmentManager: enqueueAction
  FragmentManager ->> FragmentManager: mPendingActions.add
  FragmentManager ->> FragmentManager: scheduleCommit</pre></li>
<li><p><code>[:4:0:0:0] mHost.getHandler().post(mExecCommit)</code><br>  <code>mExecCommit</code> ⬇️被放入消息队列，之后会被执行。</p>
<pre><code class="java">    // androidx.fragment.app.FragmentManager
    private Runnable mExecCommit = new Runnable() &#123;
        @Override
        public void run() &#123;
  [:4:0:0:0:0] execPendjingActions(true);
        &#125;
    &#125;;
</code></pre>
</li>
<li><p><code>[:4:0:0:0:0] execPendjingActions(true);</code></p>
<pre><code class="java">    // androidx.fragment.app.FragmentManager
    boolean execPendingActions(boolean allowStateLoss) &#123;
        ensureExecReady(allowStateLoss);

[:4:0:0:0:0:0]while (generateOpsForPendingActions(mTmpRecords, mTmpIsPop)) &#123;
            mExecutingActions = true;
            try &#123;
 [:4:0:0:0:0:1] removeRedundantOperationsAndExecute(mTmpRecords, mTmpIsPop);
                ...
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant MainActivity
  participant FragmentManager
  participant FragmentTransaction
  participant BackStackRecord

  MainActivity ->> FragmentManager: beginTransaction
  FragmentManager ->> FragmentTransaction: new
  FragmentManager ->> BackStackRecord: new
  FragmentManager ->> MainActivity: return (FragmentTransaction)BackStackRecord
  MainActivity ->> FragmentTransaction: add
  MainActivity ->> FragmentTransaction: commit
  FragmentTransaction ->> FragmentManager: enqueueAction
  FragmentManager ->> FragmentManager: mPendingActions.add
  FragmentManager ->> FragmentManager: scheduleCommit
  FragmentManager ->> FragmentManager: execPendingActions</pre></li>
<li><p><code>[:4:0:0:0:0:0] generateOpsForPendingActions(mTmpRecords, mTmpIsPop)</code></p>
<pre><code class="java">    // androidx.fragment.app.FragmentManager
    private boolean generateOpsForPendingActions(@NonNull ArrayList&lt;BackStackRecord&gt; records,
            @NonNull ArrayList&lt;Boolean&gt; isPop) &#123;
            ...
            for (int i = 0; i &lt; numActions; i++) &#123;
  [:4:0:0:0:0:0:0] didSomething |= mPendingActions.get(i).generateOps(records, isPop);
            &#125;
            ...
    &#125;
</code></pre>
<p>  这里对<code>mPendingActions</code>中的每一个Action都调用<code>generateOps</code>——会处理到之前在<code>[:4:0]</code>添加的Action</p>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant MainActivity
  participant FragmentManager
  participant FragmentTransaction
  participant BackStackRecord
  participant OpGenerator

  MainActivity ->> FragmentManager: beginTransaction
  FragmentManager ->> FragmentTransaction: new
  FragmentManager ->> BackStackRecord: new
  FragmentManager ->> MainActivity: return (FragmentTransaction)BackStackRecord
  MainActivity ->> FragmentTransaction: add
  MainActivity ->> FragmentTransaction: commit
  FragmentTransaction ->> FragmentManager: enqueueAction
  FragmentManager ->> FragmentManager: mPendingActions.add
  FragmentManager ->> FragmentManager: scheduleCommit
  FragmentManager ->> FragmentManager: execPendingActions
  FragmentManager ->> OpGenerator: generateOps
  OpGenerator ->> BackStackRecord: generateOps</pre>

  <pre class="mermaid">    classDiagram
  class FragmentTransaction {
      mOps: ArrayList"OP"
  }
  class BackStackRecord
  class FragmentManager {
      mPendingActions: ArrayList"OpGenerator"
  }
  class `FragmentManager-BackStackEntry`
  class `FragmentManager-OpGenerator` {
      boolean generateOps()
  }
  class `FragmentTransaction-Op` {
      mCmd: int
      mFragment: Fragment
  }

  BackStackRecord --|> FragmentTransaction: extends
  BackStackRecord --|> `FragmentManager-BackStackEntry`: impl
  BackStackRecord --|> `FragmentManager-OpGenerator`: impl
  FragmentManager --> BackStackRecord: create
  FragmentTransaction --> `FragmentTransaction-Op`: holds
  FragmentManager --> `FragmentManager-OpGenerator`: holds</pre>
</li>
<li><p><code>[:4:0:0:0:0:0:0] mPendingActions.get(i).generateOps(records, isPop)</code></p>
<pre><code class="java">    // androidx.fragment.app.BackStackRecord
    public boolean generateOps(@NonNull ArrayList&lt;BackStackRecord&gt; records,
            @NonNull ArrayList&lt;Boolean&gt; isRecordPop) &#123;

        ...
        records.add(this);
        ...
    &#125;
</code></pre>
<p>  <code>BackStackRecord</code>将自己添加到传入的<code>records</code>中</p>
</li>
<li><p><code>[:4:0:0:0:0:1] removeRedundantOperationsAndExecute(mTmpRecords, mTmpIsPop)</code><br>  遍历<code>[:4:0:0:0:0:0]</code>返回的每一个record，对其处理</p>
<pre><code class="java">    // androidx.fragment.app.FragmentManager
    private void removeRedundantOperationsAndExecute(@NonNull ArrayList&lt;BackStackRecord&gt; records,
            @NonNull ArrayList&lt;Boolean&gt; isRecordPop) &#123;
        ...
        final int numRecords = records.size();

        for (int recordNum = 0; recordNum &lt; numRecords; recordNum++) &#123;
            ...
                   int reorderingEnd = recordNum + 1;
  [:4:0:0:0:0:1:0] executeOpsTogether(records, isRecordPop, recordNum, reorderingEnd);
            ...
        &#125;
    &#125;
</code></pre>
<p>  遍历执行record，<code>executeOpsTogether(records</code>传入了整个<code>records</code>——只有一个<code>OP_ADD</code>，通过后面两个参数指定要执行的 record的开始位置和结束位置——recordNum(0)和reorderingEnd(recordNum + 1 &#x3D; 0 + 1 &#x3D; 1)，也就相当于挨个执行。</p>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant MainActivity
  participant FragmentManager
  participant FragmentTransaction
  participant BackStackRecord
  participant OpGenerator

  MainActivity ->> FragmentManager: beginTransaction
  FragmentManager ->> FragmentTransaction: new
  FragmentManager ->> BackStackRecord: new
  FragmentManager ->> MainActivity: return (FragmentTransaction)BackStackRecord
  MainActivity ->> FragmentTransaction: add
  MainActivity ->> FragmentTransaction: commit
  FragmentTransaction ->> FragmentManager: enqueueAction
  FragmentManager ->> FragmentManager: mPendingActions.add
  FragmentManager ->> FragmentManager: scheduleCommit
  FragmentManager ->> FragmentManager: execPendingActions
  FragmentManager ->> OpGenerator: generateOps
  OpGenerator ->> BackStackRecord: generateOps
  FragmentManager ->> FragmentManager: removeRedundantOperationsAndExecute</pre>
</li>
<li><p><code>[:4:0:0:0:0:1:0] executeOpsTogether(records, isRecordPop, recordNum, reorderingEnd)</code></p>
<pre><code class="java">    // androidx.fragment.app.FragmentManager
    private void executeOpsTogether(@NonNull ArrayList&lt;BackStackRecord&gt; records,
            @NonNull ArrayList&lt;Boolean&gt; isRecordPop, int startIndex, int endIndex) &#123;
        ...
[:4:0:0:0:0:1:0:0] executeOps(records, isRecordPop, startIndex, endIndex);
        ...
         [:4:0:0:0:0:1:0:1] fragmentStateManager.moveToExpectedState();
        ...
        
        ...
</code></pre>
<p>  <code>startIndex</code>: <code>recordNum</code> &#x3D; 0<br>  <code>endIndex</code>: <code>reorderingEnd</code> &#x3D; 1  </p>
</li>
<li><p><code>[:4:0:0:0:0:1:0:0] executeOps(records, isRecordPop, startIndex, endIndex);</code></p>
<pre><code class="java">    // androidx.fragment.app.FragmentManager
    private static void executeOps(@NonNull ArrayList&lt;BackStackRecord&gt; records,
        @NonNull ArrayList&lt;Boolean&gt; isRecordPop, int startIndex, int endIndex) &#123;
        for (int i = startIndex; i &lt; endIndex; i++) &#123;
 [:4:0:0:0:0:1:0:0:0] record.executeOps();
            &#125;
        &#125;
    &#125;
</code></pre>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant MainActivity
  participant FragmentManager
  participant FragmentTransaction
  participant BackStackRecord
  participant OpGenerator

  MainActivity ->> FragmentManager: beginTransaction
  FragmentManager ->> FragmentTransaction: new
  FragmentManager ->> BackStackRecord: new
  FragmentManager ->> MainActivity: return (FragmentTransaction)BackStackRecord
  MainActivity ->> FragmentTransaction: add
  MainActivity ->> FragmentTransaction: commit
  FragmentTransaction ->> FragmentManager: enqueueAction
  FragmentManager ->> FragmentManager: mPendingActions.add
  FragmentManager ->> FragmentManager: scheduleCommit
  FragmentManager ->> FragmentManager: execPendingActions
  FragmentManager ->> OpGenerator: generateOps
  OpGenerator ->> BackStackRecord: generateOps
  FragmentManager ->> FragmentManager: removeRedundantOperationsAndExecute
  FragmentManager ->> FragmentManager: executeOpsTogether
  FragmentManager ->> FragmentManager: executeOps
  FragmentManager ->> BackStackRecord: executeOps</pre>

  <pre class="mermaid">    classDiagram
  class FragmentTransaction {
      mOps: ArrayList"OP"
  }
  class BackStackRecord {
      executeOps(): void
  }
  class FragmentManager {
      mPendingActions: ArrayList"OpGenerator"
  }
  class `FragmentManager-BackStackEntry`
  class `FragmentManager-OpGenerator` {
      boolean generateOps()
  }
  class `FragmentTransaction-Op` {
      mCmd: int
      mFragment: Fragment
  }

  BackStackRecord --|> FragmentTransaction: extends
  BackStackRecord --|> `FragmentManager-BackStackEntry`: impl
  BackStackRecord --|> `FragmentManager-OpGenerator`: impl
  FragmentManager --> BackStackRecord: create
  FragmentTransaction --> `FragmentTransaction-Op`: holds
  FragmentManager --> `FragmentManager-OpGenerator`: holds</pre>
</li>
<li><p><code>[:4:0:0:0:0:1:0:0:0] record.executeOps();</code></p>
<pre><code class="java">    // androidx.fragment.app.BackStackRecord
    void executeOps() &#123;
        final int numOps = mOps.size();
        for (int opNum = 0; opNum &lt; numOps; opNum++) &#123;
            switch (op.mCmd) &#123;
                case OP_ADD:
                    f.setAnimations(op.mEnterAnim, op.mExitAnim, op.mPopEnterAnim, op.mPopExitAnim);
                    mManager.setExitAnimationOrder(f, false);
[:4:0:0:0:0:1:0:0:0:0] mManager.addFragment(f);
                    break;
</code></pre>
<p>  <code>mOps</code>的数量为1——<code>[:3:0:1]</code> 添加的OP_ADD</p>
  <pre class="mermaid">    sequenceDiagram
  autonumber

  participant MainActivity
  participant FragmentManager
  participant FragmentTransaction
  participant BackStackRecord
  participant OpGenerator

  MainActivity ->> FragmentManager: beginTransaction
  FragmentManager ->> FragmentTransaction: new
  FragmentManager ->> BackStackRecord: new
  FragmentManager ->> MainActivity: return (FragmentTransaction)BackStackRecord
  MainActivity ->> FragmentTransaction: add
  MainActivity ->> FragmentTransaction: commit
  FragmentTransaction ->> FragmentManager: enqueueAction
  FragmentManager ->> FragmentManager: mPendingActions.add
  FragmentManager ->> FragmentManager: scheduleCommit
  FragmentManager ->> FragmentManager: execPendingActions
  FragmentManager ->> OpGenerator: generateOps
  OpGenerator ->> BackStackRecord: generateOps
  FragmentManager ->> FragmentManager: removeRedundantOperationsAndExecute
  FragmentManager ->> FragmentManager: executeOpsTogether
  FragmentManager ->> FragmentManager: executeOps
  FragmentManager ->> BackStackRecord: executeOps
  BackStackRecord ->> FragmentManager: addFragment</pre>
</li>
<li><p><code>[:4:0:0:0:0:1:0:0:0:0] mManager.addFragment(f);</code></p>
<pre><code class="java">    // androidx.fragment.app.FragmentManager
    FragmentStateManager addFragment(@NonNull Fragment fragment) &#123;
        if (isLoggingEnabled(Log.VERBOSE)) Log.v(TAG, &quot;add: &quot; + fragment);
        FragmentStateManager fragmentStateManager = createOrGetFragmentStateManager(fragment);
        fragment.mFragmentManager = this;
        mFragmentStore.makeActive(fragmentStateManager);
        if (!fragment.mDetached) &#123;
            mFragmentStore.addFragment(fragment);
            fragment.mRemoving = false;
            if (fragment.mView == null) &#123;
                fragment.mHiddenChanged = false;
            &#125;
            if (isMenuAvailable(fragment)) &#123;
                mNeedMenuInvalidate = true;
            &#125;
        &#125;
        return fragmentStateManager;
    &#125;
</code></pre>
</li>
<li><p><code>[:4:0:0:0:0:1:0:1] fragmentStateManager.moveToExpectedState()</code><br>  这里回到上面说过的 <code>[:1:0:0:1]</code></p>
</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6970998913754988552">Android Jetpack 开发套件 #7 AndroidX Fragment 核心原理分析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.51cto.com/article/672135.html">详细聊聊Fragment的实现原理</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/JMW1407/article/details/114069742">Android：Fragment详细介绍 &amp; 使用方法解析</a></li>
</ul>

</article>

<script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<div id="paginator">
  
</div>

      </div>
    </div>

  </div>

  <!-- 底部信息 -->
  <div id="bottom-outer">
    <div id="bottom-inner">
      Site by Swithun Liu using
      <a target="_blank" rel="noopener" href="http://hexo.io">hexo blog framework</a>.
      <br>
      <a href="/">Home</a>
    </div>
  </div>


  
  <!-- scripts list from theme config.yml -->
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.0-alpha1/highlight.min.js"></script>
  
  <script src="/lib/jquery-3.4.1.min.js"></script>
  
  <script src="/lib/jquery.pjax.js"></script>
  
  <script src="/js/again.js"></script>
  
  


  <!-- 高亮脚本启动 -->
  <script>hljs.initHighlightingOnLoad();</script>

    <!-- 如果设置中mermaid选项打开 -->
    
    <!-- 引入mermaid脚本 -->
    <div class=".pjax-reload">
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.0.0-alpha.4/mermaid.min.js'></script>
    </div>
    <!-- mermaid启动 -->
    <script>
      if (window.mermaid) {
        mermaid.initialize({ theme: 'dark' });
      }
    </script>
    

</body>

</html>