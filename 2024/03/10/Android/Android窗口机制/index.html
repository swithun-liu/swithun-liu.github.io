

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Android窗口机制 [ Swithun Blog ]</title>

  
  <!-- stylesheets list from _config.yml -->
  
  <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css">
  
  <link rel="stylesheet" href="/lib/highlight-11-9-0/src/styles/atom-one-dark.css">
  
  <link rel="stylesheet" href="/css/again.css">
  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>

  <!-- menu -->
  <div id="menu-outer">
    <div id="menu-inner">
      
      <a class="menu-button" href="/">Home</a>
      
      <a class="menu-button" href="/about">About</a>
      
      <a class="menu-button" href="/contact">Contact</a>
      
      <a class="menu-button" href="/archives">Archives</a>
      
      <a class="menu-button" href="/categories">Category</a>
      
    </div>
  </div>

  <!-- 中间主体 -->
  <div id="main">
    <!-- 侧边栏 -->
    <div id="aside-outer">
      <aside>
        <!-- 搜索栏 -->
<div id="search">
    <input class="search-input" type="text" placeholder="search">
    <i id="search-icon" class="fa fa-bars" title="切换目录与索引"></i>
</div>

<!-- 侧边目录栏 -->
<div id="tree">
    

    

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            Android
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/18/Android/Fragment原理/">
                            <i class="fa fa-file"></i>
                            Fragment原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/Android/viewmodel原理/">
                            <i class="fa fa-file"></i>
                            viewmodel原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/03/03/Android/view绘制原理/">
                            <i class="fa fa-file"></i>
                            view绘制原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/03/09/Android/自定义View实现拖拽展开面板/">
                            <i class="fa fa-file"></i>
                            自定义View实现拖拽展开面板
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file active">
                        <a href="/2024/03/10/Android/Android窗口机制/">
                            <i class="fa fa-file"></i>
                            Android窗口机制
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/05/12/Android/NestedScrolling原理/">
                            <i class="fa fa-file"></i>
                            NestedScrolling原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/05/25/Android/自己实现一个NestedScrollView/">
                            <i class="fa fa-file"></i>
                            自己实现一个NestedScrollView
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            主题演示
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/主题演示/demo1/">
                            <i class="fa fa-file"></i>
                            demo1
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/22/主题演示/temp/">
                            <i class="fa fa-file"></i>
                            temp
                        </a>
                    </li>
                </ul>

              

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            demo_folder_level2
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/主题演示/demo_folder_level2/demo2/">
                            <i class="fa fa-file"></i>
                            demo2
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 
</div>

<div id="toc" style="display: none;"></div>
      </aside>
    </div>
    <!-- 文章内容 -->
    <div id="content-outer">
      <div id="content-inner">
        
<article id="post">
  <h1>Android窗口机制</h1>
  <img src="/2024/03/10/Android/Android%E7%AA%97%E5%8F%A3%E6%9C%BA%E5%88%B6/image.png" class="" title="alt text">

<h2 id="window"><a href="#window" class="headerlink" title="window"></a>window</h2><pre><code class="java">// frameworks/base/core/java/android/view/Window.java

/**
 * Abstract base class for a top-level window look and behavior policy.  An
 * instance of this class should be used as the top-level view added to the
 * window manager. It provides standard UI policies such as a background, title
 * area, default key processing, etc.
 *
 * &lt;p&gt;The framework will instantiate an implementation of this class on behalf of the application.
 */
public abstract class Window &#123;
</code></pre>
<h2 id="PhoneWindow"><a href="#PhoneWindow" class="headerlink" title="PhoneWindow"></a>PhoneWindow</h2><pre><code class="java">// frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java

/**
 * Android-specific Window.
 * &lt;p&gt;
 * todo: need to pull the generic functionality out into a base class
 * in android.widget.
 *
 * @hide
 */
public class PhoneWindow extends Window implements MenuBuilder.Callback &#123;
    ...
    // This is the top-level view of the window, containing the window decor.
    [1710064978] private DecorView mDecor;
    ...
</code></pre>
<p>Window的唯一实现类</p>
<h2 id="1710064978-private-DecorView-mDecor"><a href="#1710064978-private-DecorView-mDecor" class="headerlink" title="[1710064978] private DecorView mDecor;"></a><code>[1710064978] private DecorView mDecor;</code></h2><pre><code class="java">public class DecorView extends FrameLayout implements RootViewSurfaceTaker, WindowCallbacks &#123;
</code></pre>
<p>继承自 <code>FrameLayout</code></p>
<h2 id="1710065490-installDecor"><a href="#1710065490-installDecor" class="headerlink" title="[1710065490] installDecor"></a><code>[1710065490] installDecor</code></h2><pre><code class="java">// frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java
    private void installDecor() &#123;
        mForceDecorInstall = false;
        if (mDecor == null) &#123;
            [1710065561] mDecor = generateDecor(-1);
            mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);
            mDecor.setIsRootNamespace(true);
            if (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != 0) &#123;
                mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);
            &#125;
        &#125; else &#123;
            mDecor.setWindow(this);
        &#125;
        if (mContentParent == null) &#123;
            [1710065911] mContentParent = generateLayout(mDecor);
            ...
</code></pre>
<h2 id="1710065561-mDecor-generateDecor-1"><a href="#1710065561-mDecor-generateDecor-1" class="headerlink" title="[1710065561] mDecor = generateDecor(-1);"></a><code>[1710065561] mDecor = generateDecor(-1);</code></h2><pre><code class="java">// frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java
    protected DecorView generateDecor(int featureId) &#123;
        ...
        return new DecorView(context, featureId, this, getAttributes());
    &#125;
</code></pre>
<p>那么谁会调用 <code>[1710065490] installDecor</code>，调用处有多处，比如⬇️ [1710065801] setContentView</p>
<h2 id="1710065801-setContentView"><a href="#1710065801-setContentView" class="headerlink" title="[1710065801] setContentView"></a><code>[1710065801] setContentView</code></h2><pre><code class="java">// frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java
    @Override
    public void setContentView(int layoutResID) &#123;
        // Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window
        // decor, when theme attributes and the like are crystalized. Do not check the feature
        // before this happens.
        [1710066153] if (mContentParent == null) &#123;
            installDecor();
        &#125; else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;
            mContentParent.removeAllViews();
        &#125;

        if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;
            final Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,
                    getContext());
            transitionTo(newScene);
        &#125; else &#123;
            mLayoutInflater.inflate(layoutResID, mContentParent);
        &#125;
        mContentParent.requestApplyInsets();
        final Callback cb = getCallback();
        if (cb != null &amp;&amp; !isDestroyed()) &#123;
            cb.onContentChanged();
        &#125;
        mContentParentExplicitlySet = true;
    &#125;
</code></pre>
<p><code>[1710066153] mContentParent</code> 为空，则会调用 <code>[1710065490] installDecork</code></p>
<p>那么 <code>mContentParent</code> 由谁赋值</p>
<pre><code class="java">// frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java

    // This is the view in which the window contents are placed. It is either
    // mDecor itself, or a child of mDecor where the contents go.
    [1710066794] ViewGroup mContentParent;
</code></pre>
<h2 id="1710065911-mContentParent-generateLayout-mDecor"><a href="#1710065911-mContentParent-generateLayout-mDecor" class="headerlink" title="[1710065911] mContentParent = generateLayout(mDecor);"></a><code>[1710065911] mContentParent = generateLayout(mDecor);</code></h2><pre><code class="java">// frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java

    protected ViewGroup generateLayout(DecorView decor) &#123;
        ...
                [1710066593] ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);

        [1710066603] return contentParent;
</code></pre>
<p>[1710066593]创建 <code>contentParent</code>，然后[1710066603]返回其作为返回值，也就是mContentParent</p>
<h2 id="1710066593-ViewGroup-contentParent-ViewGroup-findViewById-ID-ANDROID-CONTENT"><a href="#1710066593-ViewGroup-contentParent-ViewGroup-findViewById-ID-ANDROID-CONTENT" class="headerlink" title="[1710066593] ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);"></a><code>[1710066593] ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</code></h2><pre><code class="java">    @Nullable
    public &lt;T extends View&gt; T findViewById(@IdRes int id) &#123;
        return [1710066709] getDecorView().findViewById(id);
    &#125;
</code></pre>
<p><code>[1710066709] getDecorView()</code>返回的实际上就是 <code>[1710064978] mDecor</code>，然后找到其中id为<code>content</code>的view</p>
<p>以上，也即是说 <code>[1710064978] mDecor</code>的创建会导致 <code>[1710066794] mContentParent</code> 的创建，所以 <code>[1710066153]</code>这里就可以用 <code>mContentParent</code> 为null作为是否需要 <code>[1710065490] installDecor</code>的判断。</p>
<h2 id="总结以上"><a href="#总结以上" class="headerlink" title="总结以上"></a>总结以上</h2><pre class="mermaid">sequenceDiagram
Activity ->> Window: setContentView
Window ->> PhoneWindow: (impl) setContentView
PhoneWindow ->> PhoneWindow: installDecor
Note right of PhoneWindow: 初始化 mDecor
PhoneWindow ->> DecoreView: mDecor = generateDecor(-1)
PhoneWindow ->> PhoneWindow: mContentParent = generateLayout(mDecor)
Note right of PhoneWindow: 同时初始化 mContentParent</pre>

<h2 id="ViewManager"><a href="#ViewManager" class="headerlink" title="ViewManager"></a>ViewManager</h2><p>Interface to let you add and remove child views to an Activity.</p>
<pre><code class="java">/** Interface to let you add and remove child views to an Activity. To get an instance
  * of this class, call &#123;@link android.content.Context#getSystemService(java.lang.String) Context.getSystemService()&#125;.
  */
public interface ViewManager
&#123;
    /**
     * Assign the passed LayoutParams to the passed View and add the view to the window.
     * &lt;p&gt;Throws &#123;@link android.view.WindowManager.BadTokenException&#125; for certain programming
     * errors, such as adding a second view to a window without removing the first view.
     * &lt;p&gt;Throws &#123;@link android.view.WindowManager.InvalidDisplayException&#125; if the window is on a
     * secondary &#123;@link Display&#125; and the specified display can&#39;t be found
     * (see &#123;@link android.app.Presentation&#125;).
     * @param view The view to be added to this window.
     * @param params The LayoutParams to assign to view.
     */
    public void addView(View view, ViewGroup.LayoutParams params);
    public void updateViewLayout(View view, ViewGroup.LayoutParams params);
    public void removeView(View view);
&#125;
</code></pre>
<h2 id="WindowManager"><a href="#WindowManager" class="headerlink" title="WindowManager"></a>WindowManager</h2><p>The interface that apps use to talk to the window manager.</p>
<pre><code class="java">/**
 * The interface that apps use to talk to the window manager.
 * &lt;p&gt;
 * Each window manager instance is bound to a &#123;@link Display&#125;. To obtain the
 * &lt;code&gt;WindowManager&lt;/code&gt; associated with a display,
 * call &#123;@link Context#createWindowContext(Display, int, Bundle)&#125; to get the display&#39;s UI context,
 * then call &#123;@link Context#getSystemService(String)&#125; or &#123;@link Context#getSystemService(Class)&#125; on
 * the UI context.
 * &lt;p&gt;
 * The simplest way to show a window on a particular display is to create a &#123;@link Presentation&#125;,
 * which automatically obtains a &lt;code&gt;WindowManager&lt;/code&gt; and context for the display.
 */
@SystemService(Context.WINDOW_SERVICE)
public interface WindowManager extends ViewManager &#123;
</code></pre>
<h2 id="WindowManagerImpl"><a href="#WindowManagerImpl" class="headerlink" title="WindowManagerImpl"></a>WindowManagerImpl</h2><pre><code class="java">// android.view.WindowManagerImpl
public final class WindowManagerImpl implements WindowManager &#123;
</code></pre>
<h2 id="1710680968-startActivity"><a href="#1710680968-startActivity" class="headerlink" title="[1710680968] startActivity"></a>[1710680968] startActivity</h2><pre><code class="java">// android.app.Activity
    @Override
    public void startActivity(Intent intent) &#123;
        [1710681027] this.startActivity(intent, null);
    &#125;
</code></pre>
<h2 id="1710680968-1710681027-this-startActivity-intent-null"><a href="#1710680968-1710681027-this-startActivity-intent-null" class="headerlink" title="[1710680968]#[1710681027] this.startActivity(intent, null);"></a>[1710680968]#[1710681027] this.startActivity(intent, null);</h2><pre><code class="java">// android.app.Activity
    @Override
    public void startActivity(Intent intent, @Nullable Bundle options) &#123;
        ..
            [1710681049] startActivityForResult(intent, -1);
</code></pre>
<h2 id="1710681027-1710681049-startActivityForResult-intent-1"><a href="#1710681027-1710681049-startActivityForResult-intent-1" class="headerlink" title="[1710681027]#[1710681049] startActivityForResult(intent, -1);"></a>[1710681027]#[1710681049] startActivityForResult(intent, -1);</h2><pre><code class="java">    public void startActivityForResult(@RequiresPermission Intent intent, int requestCode,
            @Nullable Bundle options) &#123;
            ...
            Instrumentation.ActivityResult ar =
                [1710684070] mInstrumentation.execStartActivity(
                    this, mMainThread.getApplicationThread(), mToken, this,
                    intent, requestCode, options);
</code></pre>
<h2 id="1710681049-1710684070-mInstrumentation-execStartActivity"><a href="#1710681049-1710684070-mInstrumentation-execStartActivity" class="headerlink" title="[1710681049]#[1710684070] mInstrumentation.execStartActivity("></a>[1710681049]#[1710684070] mInstrumentation.execStartActivity(</h2><pre><code class="java">// android.app.ActivityTaskManager
    public ActivityResult execStartActivity(
            Context who, IBinder contextThread, IBinder token, Activity target,
            Intent intent, int requestCode, Bundle options) &#123;
        IApplicationThread whoThread = (IApplicationThread) contextThread;
        Uri referrer = target != null ? target.onProvideReferrer() : null;
        if (referrer != null) &#123;
            intent.putExtra(Intent.EXTRA_REFERRER, referrer);
        &#125;
        if (mActivityMonitors != null) &#123;
            synchronized (mSync) &#123;
                final int N = mActivityMonitors.size();
                for (int i=0; i&lt;N; i++) &#123;
                    final ActivityMonitor am = mActivityMonitors.get(i);
                    ActivityResult result = null;
                    if (am.ignoreMatchingSpecificIntents()) &#123;
                        if (options == null) &#123;
                            options = ActivityOptions.makeBasic().toBundle();
                        &#125;
                        result = am.onStartActivity(who, intent, options);
                    &#125;
                    if (result != null) &#123;
                        am.mHits++;
                        return result;
                    &#125; else if (am.match(who, null, intent)) &#123;
                        am.mHits++;
                        if (am.isBlocking()) &#123;
                            return requestCode &gt;= 0 ? am.getResult() : null;
                        &#125;
                        break;
                    &#125;
                &#125;
            &#125;
        &#125;
        try &#123;
            intent.migrateExtraStreamToClipData(who);
            intent.prepareToLeaveProcess(who);
            int result = ActivityTaskManager.[1710684185]getService().[1710684660]startActivity(whoThread,
                    who.getOpPackageName(), who.getAttributionTag(), intent,
                    intent.resolveTypeIfNeeded(who.getContentResolver()), token,
                    target != null ? target.mEmbeddedID : null, requestCode, 0, null, options);
            checkStartActivityResult(result, intent);
        &#125; catch (RemoteException e) &#123;
            throw new RuntimeException(&quot;Failure from system&quot;, e);
        &#125;
        return null;
    &#125;
</code></pre>
<h2 id="1710684070-1710684185-getService"><a href="#1710684070-1710684185-getService" class="headerlink" title="[1710684070]#[1710684185]getService()"></a>[1710684070]#[1710684185]getService()</h2><pre><code class="java">// android.app.ActivityTaskManager
    public static IActivityTaskManager getService() &#123;
        return [1710684283]IActivityTaskManagerSingleton.[1710684319]get();
    &#125;
</code></pre>
<h2 id="1710684185-1710684283-IActivityTaskManagerSingleton"><a href="#1710684185-1710684283-IActivityTaskManagerSingleton" class="headerlink" title="[1710684185]#[1710684283]IActivityTaskManagerSingleton"></a>[1710684185]#[1710684283]IActivityTaskManagerSingleton</h2><pre><code class="java">    @UnsupportedAppUsage(trackingBug = 129726065)
    private static final Singleton&lt;IActivityTaskManager&gt; IActivityTaskManagerSingleton =
            new Singleton&lt;IActivityTaskManager&gt;() &#123;
                @Override
                protected IActivityTaskManager create() &#123;
                    final IBinder b = ServiceManager.getService(Context.ACTIVITY_TASK_SERVICE);
                    return [1710684357] IActivityTaskManager.Stub.asInterface(b);
                &#125;
            &#125;;
</code></pre>
<h2 id="1710684357-1710684283-IActivityTaskManager-Stub-asInterface-b"><a href="#1710684357-1710684283-IActivityTaskManager-Stub-asInterface-b" class="headerlink" title="[1710684357]#[1710684283] IActivityTaskManager.Stub.asInterface(b);"></a>[1710684357]#[1710684283] IActivityTaskManager.Stub.asInterface(b);</h2><h2 id="1710684283-1710684660-startActivity-whoThread"><a href="#1710684283-1710684660-startActivity-whoThread" class="headerlink" title="[1710684283]#[1710684660]startActivity(whoThread,"></a>[1710684283]#[1710684660]startActivity(whoThread,</h2><p>夸进程调用</p>
<p>&#x2F;&#x2F; android.server.wm.ActivityTaskManagerService</p>
<pre><code class="java">    @Override
    public final int startActivity(IApplicationThread caller, String callingPackage,
            String callingFeatureId, Intent intent, String resolvedType, IBinder resultTo,
            String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo,
            Bundle bOptions) &#123;
        return [1710684705] startActivityAsUser(caller, callingPackage, callingFeatureId, intent, resolvedType,
                resultTo, resultWho, requestCode, startFlags, profilerInfo, bOptions,
                UserHandle.getCallingUserId());
    &#125;
</code></pre>
<h2 id="1710684660-1710684705-startActivityAsUser-caller-callingPackage-callingFeatureId-intent-resolvedType"><a href="#1710684660-1710684705-startActivityAsUser-caller-callingPackage-callingFeatureId-intent-resolvedType" class="headerlink" title="[1710684660]#[1710684705] startActivityAsUser(caller, callingPackage, callingFeatureId, intent, resolvedType,"></a>[1710684660]#[1710684705] startActivityAsUser(caller, callingPackage, callingFeatureId, intent, resolvedType,</h2><pre><code class="java">    @Override
    public int startActivityAsUser(IApplicationThread caller, String callingPackage,
            String callingFeatureId, Intent intent, String resolvedType, IBinder resultTo,
            String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo,
            Bundle bOptions, int userId) &#123;
        return [1710684754] startActivityAsUser(caller, callingPackage, callingFeatureId, intent, resolvedType,
                resultTo, resultWho, requestCode, startFlags, profilerInfo, bOptions, userId,
                true /*validateIncomingUser*/);
    &#125;
</code></pre>
<h2 id="1710684705-1710684754-startActivityAsUser-caller-callingPackage-callingFeatureId-intent-resolvedType"><a href="#1710684705-1710684754-startActivityAsUser-caller-callingPackage-callingFeatureId-intent-resolvedType" class="headerlink" title="[1710684705]#[1710684754] startActivityAsUser(caller, callingPackage, callingFeatureId, intent, resolvedType,"></a>[1710684705]#[1710684754] startActivityAsUser(caller, callingPackage, callingFeatureId, intent, resolvedType,</h2><pre><code class="java">    private int startActivityAsUser(IApplicationThread caller, String callingPackage,
            @Nullable String callingFeatureId, Intent intent, String resolvedType,
            IBinder resultTo, String resultWho, int requestCode, int startFlags,
            ProfilerInfo profilerInfo, Bundle bOptions, int userId, boolean validateIncomingUser) &#123;
        assertPackageMatchesCallingUid(callingPackage);
        enforceNotIsolatedCaller(&quot;startActivityAsUser&quot;);
        if (Process.isSdkSandboxUid(Binder.getCallingUid())) &#123;
            SdkSandboxManagerLocal sdkSandboxManagerLocal = LocalManagerRegistry.getManager(
                    SdkSandboxManagerLocal.class);
            if (sdkSandboxManagerLocal == null) &#123;
                throw new IllegalStateException(&quot;SdkSandboxManagerLocal not found when starting&quot;
                        + &quot; an activity from an SDK sandbox uid.&quot;);
            &#125;
            sdkSandboxManagerLocal.enforceAllowedToStartActivity(intent);
        &#125;

        userId = getActivityStartController().checkTargetUser(userId, validateIncomingUser,
                Binder.getCallingPid(), Binder.getCallingUid(), &quot;startActivityAsUser&quot;);

        // TODO: Switch to user app stacks here.
        return getActivityStartController().obtainStarter(intent, &quot;startActivityAsUser&quot;)
                .setCaller(caller)
                .setCallingPackage(callingPackage)
                .setCallingFeatureId(callingFeatureId)
                .setResolvedType(resolvedType)
                .setResultTo(resultTo)
                .setResultWho(resultWho)
                .setRequestCode(requestCode)
                .setStartFlags(startFlags)
                .setProfilerInfo(profilerInfo)
                .setActivityOptions(bOptions)
                .setUserId(userId)
                .[1710685003]execute();

    &#125;
</code></pre>
<h2 id="1710684754-1710685003-execute"><a href="#1710684754-1710685003-execute" class="headerlink" title="[1710684754]#[1710685003]execute()"></a>[1710684754]#[1710685003]execute()</h2><pre><code class="java">// android.server.wm.ActivityStarter
    int execute() &#123;
        try &#123;
            // Refuse possible leaked file descriptors
            if (mRequest.intent != null &amp;&amp; mRequest.intent.hasFileDescriptors()) &#123;
                throw new IllegalArgumentException(&quot;File descriptors passed in Intent&quot;);
            &#125;

            final LaunchingState launchingState;
            synchronized (mService.mGlobalLock) &#123;
                final ActivityRecord caller = ActivityRecord.forTokenLocked(mRequest.resultTo);
                final int callingUid = mRequest.realCallingUid == Request.DEFAULT_REAL_CALLING_UID
                        ?  Binder.getCallingUid() : mRequest.realCallingUid;
                launchingState = mSupervisor.getActivityMetricsLogger().notifyActivityLaunching(
                        mRequest.intent, caller, callingUid);
            &#125;

            // If the caller hasn&#39;t already resolved the activity, we&#39;re willing
            // to do so here. If the caller is already holding the WM lock here,
            // and we need to check dynamic Uri permissions, then we&#39;re forced
            // to assume those permissions are denied to avoid deadlocking.
            if (mRequest.activityInfo == null) &#123;
                mRequest.resolveActivity(mSupervisor);
            &#125;

            // Add checkpoint for this shutdown or reboot attempt, so we can record the original
            // intent action and package name.
            if (mRequest.intent != null) &#123;
                String intentAction = mRequest.intent.getAction();
                String callingPackage = mRequest.callingPackage;
                if (intentAction != null &amp;&amp; callingPackage != null
                        &amp;&amp; (Intent.ACTION_REQUEST_SHUTDOWN.equals(intentAction)
                                || Intent.ACTION_SHUTDOWN.equals(intentAction)
                                || Intent.ACTION_REBOOT.equals(intentAction))) &#123;
                    ShutdownCheckPoints.recordCheckPoint(intentAction, callingPackage, null);
                &#125;
            &#125;

            int res;
            synchronized (mService.mGlobalLock) &#123;
                final boolean globalConfigWillChange = mRequest.globalConfig != null
                        &amp;&amp; mService.getGlobalConfiguration().diff(mRequest.globalConfig) != 0;
                final Task rootTask = mRootWindowContainer.getTopDisplayFocusedRootTask();
                if (rootTask != null) &#123;
                    rootTask.mConfigWillChange = globalConfigWillChange;
                &#125;
                ProtoLog.v(WM_DEBUG_CONFIGURATION, &quot;Starting activity when config &quot;
                        + &quot;will change = %b&quot;, globalConfigWillChange);

                final long origId = Binder.clearCallingIdentity();

                res = resolveToHeavyWeightSwitcherIfNeeded();
                if (res != START_SUCCESS) &#123;
                    return res;
                &#125;
                [1710685731] res = executeRequest(mRequest);

                Binder.restoreCallingIdentity(origId);

                if (globalConfigWillChange) &#123;
                    // If the caller also wants to switch to a new configuration, do so now.
                    // This allows a clean switch, as we are waiting for the current activity
                    // to pause (so we will not destroy it), and have not yet started the
                    // next activity.
                    mService.mAmInternal.enforceCallingPermission(
                            android.Manifest.permission.CHANGE_CONFIGURATION,
                            &quot;updateConfiguration()&quot;);
                    if (rootTask != null) &#123;
                        rootTask.mConfigWillChange = false;
                    &#125;
                    ProtoLog.v(WM_DEBUG_CONFIGURATION,
                                &quot;Updating to new configuration after starting activity.&quot;);

                    mService.updateConfigurationLocked(mRequest.globalConfig, null, false);
                &#125;

                // The original options may have additional info about metrics. The mOptions is not
                // used here because it may be cleared in setTargetRootTaskIfNeeded.
                final ActivityOptions originalOptions = mRequest.activityOptions != null
                        ? mRequest.activityOptions.getOriginalOptions() : null;
                // If the new record is the one that started, a new activity has created.
                final boolean newActivityCreated = mStartActivity == mLastStartActivityRecord;
                // Notify ActivityMetricsLogger that the activity has launched.
                // ActivityMetricsLogger will then wait for the windows to be drawn and populate
                // WaitResult.
                mSupervisor.getActivityMetricsLogger().notifyActivityLaunched(launchingState, res,
                        newActivityCreated, mLastStartActivityRecord, originalOptions);
                if (mRequest.waitResult != null) &#123;
                    mRequest.waitResult.result = res;
                    res = waitResultIfNeeded(mRequest.waitResult, mLastStartActivityRecord,
                            launchingState);
                &#125;
                return getExternalResult(res);
            &#125;
        &#125; finally &#123;
            onExecutionComplete();
        &#125;
    &#125;
</code></pre>
<h2 id="1710685003-1710685731-res-executeRequest-mRequest"><a href="#1710685003-1710685731-res-executeRequest-mRequest" class="headerlink" title="[1710685003]#[1710685731] res &#x3D; executeRequest(mRequest);"></a>[1710685003]#[1710685731] res &#x3D; executeRequest(mRequest);</h2><pre><code class="java">// android.server.wm.ActivityStarter
    private int executeRequest(Request request) &#123;
        ...
        [1710685907] final ActivityRecord r = new ActivityRecord.Builder(mService)
                .setCaller(callerApp)
                .setLaunchedFromPid(callingPid)
                .setLaunchedFromUid(callingUid)
                .setLaunchedFromPackage(callingPackage)
                .setLaunchedFromFeature(callingFeatureId)
                .setIntent(intent)
                .setResolvedType(resolvedType)
                .setActivityInfo(aInfo)
                .setConfiguration(mService.getGlobalConfiguration())
                .setResultTo(resultRecord)
                .setResultWho(resultWho)
                .setRequestCode(requestCode)
                .setComponentSpecified(request.componentSpecified)
                .setRootVoiceInteraction(voiceSession != null)
                .setActivityOptions(checkedOptions)
                .setSourceRecord(sourceRecord)
                .build();
        ...
        mLastStartActivityResult = [1710685981] startActivityUnchecked(r, sourceRecord, voiceSession,
                request.voiceInteractor, startFlags, true /* doResume */, checkedOptions,
                inTask, inTaskFragment, restrictedBgActivity, intentGrants);
</code></pre>
<h2 id="1710685731-1710685907-final-ActivityRecord-r-new-ActivityRecord-Builder-mService"><a href="#1710685731-1710685907-final-ActivityRecord-r-new-ActivityRecord-Builder-mService" class="headerlink" title="[1710685731]#[1710685907] final ActivityRecord r &#x3D; new ActivityRecord.Builder(mService)"></a>[1710685731]#[1710685907] final ActivityRecord r &#x3D; new ActivityRecord.Builder(mService)</h2><p>创建 <code>ActivityRecord</code>，记录 <code>Activity</code> 的关键信息</p>
<h2 id="1710685731-1710685981-startActivityUnchecked-r-sourceRecord-voiceSession"><a href="#1710685731-1710685981-startActivityUnchecked-r-sourceRecord-voiceSession" class="headerlink" title="[1710685731]#[1710685981] startActivityUnchecked(r, sourceRecord, voiceSession,"></a>[1710685731]#[1710685981] startActivityUnchecked(r, sourceRecord, voiceSession,</h2><pre><code class="java">// android.server.wm.ActivityStarter
    private int startActivityUnchecked(final ActivityRecord r, ActivityRecord sourceRecord,
            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,
            int startFlags, boolean doResume, ActivityOptions options, Task inTask,
            TaskFragment inTaskFragment, boolean restrictedBgActivity,
            NeededUriGrants intentGrants) &#123;
        ...
            result = [1710686083] startActivityInner(r, sourceRecord, voiceSession, voiceInteractor,
                    startFlags, doResume, options, inTask, inTaskFragment, restrictedBgActivity,
                    intentGrants);
        ...
    &#125;
</code></pre>
<h2 id="1710685981-1710686083-startActivityInner-r-sourceRecord-voiceSession-voiceInteractor"><a href="#1710685981-1710686083-startActivityInner-r-sourceRecord-voiceSession-voiceInteractor" class="headerlink" title="[1710685981]#[1710686083] startActivityInner(r, sourceRecord, voiceSession, voiceInteractor,"></a>[1710685981]#[1710686083] startActivityInner(r, sourceRecord, voiceSession, voiceInteractor,</h2><pre><code class="java">// android.server.wm.ActivityStarter
    int startActivityInner(final ActivityRecord r, ActivityRecord sourceRecord,
            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,
            int startFlags, boolean doResume, ActivityOptions options, Task inTask,
            TaskFragment inTaskFragment, boolean restrictedBgActivity,
            NeededUriGrants intentGrants) &#123;
            ...
                [1710686250] mRootWindowContainer.resumeFocusedTasksTopActivities(
                        mTargetRootTask, mStartActivity, mOptions, mTransientLaunch);
</code></pre>
<h2 id="1710686083-1710686250-mRootWindowContainer-resumeFocusedTasksTopActivities"><a href="#1710686083-1710686250-mRootWindowContainer-resumeFocusedTasksTopActivities" class="headerlink" title="[1710686083]#[1710686250] mRootWindowContainer.resumeFocusedTasksTopActivities("></a>[1710686083]#[1710686250] mRootWindowContainer.resumeFocusedTasksTopActivities(</h2><pre><code class="java">// android.server.wm.RootWindowContainer
    boolean resumeFocusedTasksTopActivities(
            Task targetRootTask, ActivityRecord target, ActivityOptions targetOptions,
            boolean deferPause) &#123;
                ...
                    result |= [1710686434] focusedRoot.resumeTopActivityUncheckedLocked(target, targetOptions);
</code></pre>
<h2 id="1710686250-1710686434-focusedRoot-resumeTopActivityUncheckedLocked-target-targetOptions"><a href="#1710686250-1710686434-focusedRoot-resumeTopActivityUncheckedLocked-target-targetOptions" class="headerlink" title="[1710686250]#[1710686434] focusedRoot.resumeTopActivityUncheckedLocked(target, targetOptions);"></a>[1710686250]#[1710686434] focusedRoot.resumeTopActivityUncheckedLocked(target, targetOptions);</h2><pre><code class="java">// android.server.wm.Task
    boolean resumeTopActivityUncheckedLocked(ActivityRecord prev, ActivityOptions options) &#123;
        return [1710686479] resumeTopActivityUncheckedLocked(prev, options, false /* skipPause */);
    &#125;
</code></pre>
<h2 id="1710686434-1710686479-resumeTopActivityUncheckedLocked-prev-options-false-skipPause"><a href="#1710686434-1710686479-resumeTopActivityUncheckedLocked-prev-options-false-skipPause" class="headerlink" title="[1710686434]#[1710686479] resumeTopActivityUncheckedLocked(prev, options, false &#x2F;* skipPause *&#x2F;);"></a>[1710686434]#[1710686479] resumeTopActivityUncheckedLocked(prev, options, false &#x2F;* skipPause *&#x2F;);</h2><pre><code class="java">// android.server.wm.Task
    boolean resumeTopActivityUncheckedLocked(ActivityRecord prev, ActivityOptions options,
            boolean deferPause) &#123;
        ...
                            someActivityResumed = [1710686767]resumeTopActivityInnerLocked(prev, options, deferPause);
</code></pre>
<h2 id="1710686479-1710686767-resumeTopActivityInnerLocked-prev-options-deferPause"><a href="#1710686479-1710686767-resumeTopActivityInnerLocked-prev-options-deferPause" class="headerlink" title="[1710686479]#[1710686767]resumeTopActivityInnerLocked(prev, options, deferPause);"></a>[1710686479]#[1710686767]resumeTopActivityInnerLocked(prev, options, deferPause);</h2><pre><code class="java">// android.server.wm.Task
    private boolean resumeTopActivityInnerLocked(ActivityRecord prev, ActivityOptions options,
            boolean deferPause) &#123;
            ...
            resumed[0] |= [1710686819]f.resumeTopActivity(prev, options, deferPause);
    &#125;
</code></pre>
<h2 id="1710686767-1710686819-f-resumeTopActivity-prev-options-deferPause"><a href="#1710686767-1710686819-f-resumeTopActivity-prev-options-deferPause" class="headerlink" title="[1710686767]#[1710686819]f.resumeTopActivity(prev, options, deferPause);"></a>[1710686767]#[1710686819]f.resumeTopActivity(prev, options, deferPause);</h2><pre><code class="java">// android.server.wm.TaskFragment
    final boolean resumeTopActivity(ActivityRecord prev, ActivityOptions options,
            boolean deferPause) &#123;
            ...
            [1710686992]mTaskSupervisor.startSpecificActivity(next, true, true);
</code></pre>
<h2 id="1710686819-1710686992-mTaskSupervisor-startSpecificActivity-next-true-true"><a href="#1710686819-1710686992-mTaskSupervisor-startSpecificActivity-next-true-true" class="headerlink" title="[1710686819]#[1710686992]mTaskSupervisor.startSpecificActivity(next, true, true);"></a>[1710686819]#[1710686992]mTaskSupervisor.startSpecificActivity(next, true, true);</h2><pre><code class="java">// android.server.wm.ActivityTaskSupervisor
    void startSpecificActivity(ActivityRecord r, boolean andResume, boolean checkConfig) &#123;
        // Is this activity&#39;s application already running?
        ...
                [1710687088]realStartActivityLocked(r, wpc, andResume, checkConfig);
</code></pre>
<h2 id="1710686992-1710687088-realStartActivityLocked-r-wpc-andResume-checkConfig"><a href="#1710686992-1710687088-realStartActivityLocked-r-wpc-andResume-checkConfig" class="headerlink" title="[1710686992]#[1710687088]realStartActivityLocked(r, wpc, andResume, checkConfig);"></a>[1710686992]#[1710687088]realStartActivityLocked(r, wpc, andResume, checkConfig);</h2><pre><code class="java">// android.server.wm.ActivityTaskSupervisor
    boolean realStartActivityLocked(ActivityRecord r, WindowProcessController proc,
            boolean andResume, boolean checkConfig) throws RemoteException &#123;
                ...
                // Create activity launch transaction.
                [1710687197] final ClientTransaction clientTransaction = ClientTransaction.obtain(
                        proc.getThread(), r.token);
                ...
                [1710687306] mService.getLifecycleManager().scheduleTransaction(clientTransaction);

</code></pre>
<h2 id="1710687088-1710687197-final-ClientTransaction-clientTransaction-ClientTransaction-obtain"><a href="#1710687088-1710687197-final-ClientTransaction-clientTransaction-ClientTransaction-obtain" class="headerlink" title="[1710687088]#[1710687197] final ClientTransaction clientTransaction &#x3D; ClientTransaction.obtain("></a>[1710687088]#[1710687197] final ClientTransaction clientTransaction &#x3D; ClientTransaction.obtain(</h2><p>创建启动 Activity 的事务</p>
<h2 id="1710687088-1710687306-mService-getLifecycleManager-scheduleTransaction-clientTransaction"><a href="#1710687088-1710687306-mService-getLifecycleManager-scheduleTransaction-clientTransaction" class="headerlink" title="[1710687088]#[1710687306] mService.getLifecycleManager().scheduleTransaction(clientTransaction);"></a>[1710687088]#[1710687306] mService.getLifecycleManager().scheduleTransaction(clientTransaction);</h2><pre><code class="java">// android.server.wm.ActivityTaskManagerService
    ClientLifecycleManager getLifecycleManager() &#123;
        return mLifecycleManager;
    &#125;
</code></pre>
<pre><code class="java">// android.server.wm.ClientLifecycleManager
    void scheduleTransaction(ClientTransaction transaction) throws RemoteException &#123;
        final IApplicationThread client = transaction.getClient();
        [1710687541] transaction.schedule();
        if (!(client instanceof Binder)) &#123;
            // If client is not an instance of Binder - it&#39;s a remote call and at this point it is
            // safe to recycle the object. All objects used for local calls will be recycled after
            // the transaction is executed on client in ActivityThread.
            transaction.recycle();
        &#125;
    &#125;
</code></pre>
<h2 id="1710687306-1710687541-transaction-schedule"><a href="#1710687306-1710687541-transaction-schedule" class="headerlink" title="[1710687306]#[1710687541] transaction.schedule();"></a>[1710687306]#[1710687541] transaction.schedule();</h2><pre><code class="java">// android.app.servertransaction.ClientTransaction
    public void schedule() throws RemoteException &#123;
        [1710687621]mClient.scheduleTransaction(this);
    &#125;
</code></pre>
<h2 id="1710687541-1710687621-mClient-scheduleTransaction-this"><a href="#1710687541-1710687621-mClient-scheduleTransaction-this" class="headerlink" title="[1710687541]#[1710687621]mClient.scheduleTransaction(this);"></a>[1710687541]#[1710687621]mClient.scheduleTransaction(this);</h2><p>通过夸进程调用回到客户端</p>
<pre><code class="java">// android.app.ActivityThread.ApplicationThread
        public void scheduleTransaction(ClientTransaction transaction) throws RemoteException &#123;
            [1710687752] ActivityThread.this.scheduleTransaction(transaction);
        &#125;
</code></pre>
<h2 id="1710687621-1710687752-ActivityThread-this-scheduleTransaction-transaction"><a href="#1710687621-1710687752-ActivityThread-this-scheduleTransaction-transaction" class="headerlink" title="[1710687621]#[1710687752] ActivityThread.this.scheduleTransaction(transaction);"></a>[1710687621]#[1710687752] ActivityThread.this.scheduleTransaction(transaction);</h2><p>由 ActivityThread 的父类 ClientTransactionHandler 实现</p>
<pre><code class="java">// android.app.ClientTransactionHandler
    void scheduleTransaction(ClientTransaction transaction) &#123;
        transaction.preExecute(this);
        [1710688032] sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);
    &#125;
</code></pre>
<h2 id="1710687752-1710688032-sendMessage-ActivityThread-H-EXECUTE-TRANSACTION-transaction"><a href="#1710687752-1710688032-sendMessage-ActivityThread-H-EXECUTE-TRANSACTION-transaction" class="headerlink" title="[1710687752]#[1710688032] sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);"></a>[1710687752]#[1710688032] sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);</h2><pre><code class="java">// android.app.ActivityThread
    void sendMessage(int what, Object obj) &#123;
        sendMessage(what, obj, 0, 0, false);
    &#125;

    private void sendMessage(int what, Object obj, int arg1) &#123;
        sendMessage(what, obj, arg1, 0, false);
    &#125;

    private void sendMessage(int what, Object obj, int arg1, int arg2) &#123;
        sendMessage(what, obj, arg1, arg2, false);
    &#125;

    private void sendMessage(int what, Object obj, int arg1, int arg2, boolean async) &#123;
        if (DEBUG_MESSAGES) &#123;
            Slog.v(TAG,
                    &quot;SCHEDULE &quot; + what + &quot; &quot; + mH.codeToString(what) + &quot;: &quot; + arg1 + &quot; / &quot; + obj);
        &#125;
        Message msg = Message.obtain();
        msg.what = what;
        msg.obj = obj;
        msg.arg1 = arg1;
        msg.arg2 = arg2;
        if (async) &#123;
            msg.setAsynchronous(true);
        &#125;
        [1710688095]mH.sendMessage(msg);
    &#125;
</code></pre>
<h2 id="1710688032-1710688095-mH-sendMessage-msg"><a href="#1710688032-1710688095-mH-sendMessage-msg" class="headerlink" title="[1710688032]#[1710688095]mH.sendMessage(msg);"></a>[1710688032]#[1710688095]mH.sendMessage(msg);</h2><p>mH是个handler，直接看如果处理 message</p>
<pre><code class="java">// android.app.ActivityThread.H
    class H extends Handler &#123;
        ...
            public void handleMessage(Message msg) &#123;
                ...
                case EXECUTE_TRANSACTION:
                    final ClientTransaction transaction = (ClientTransaction) msg.obj;
                    [1710688254] mTransactionExecutor.execute(transaction);
                    if (isSystem()) &#123;
                        // Client transactions inside system process are recycled on the client side
                        // instead of ClientLifecycleManager to avoid being cleared before this
                        // message is handled.
                        transaction.recycle();
                    &#125;
                    // TODO(lifecycler): Recycle locally scheduled transactions.
                    break;
</code></pre>
<h2 id="1710688095-1710688254-mTransactionExecutor-execute-transaction"><a href="#1710688095-1710688254-mTransactionExecutor-execute-transaction" class="headerlink" title="[1710688095]#[1710688254] mTransactionExecutor.execute(transaction);"></a>[1710688095]#[1710688254] mTransactionExecutor.execute(transaction);</h2><pre><code class="java">
</code></pre>
<h2 id="总结以上-1"><a href="#总结以上-1" class="headerlink" title="总结以上"></a>总结以上</h2><pre class="mermaid">sequenceDiagram
Activity -> Activity: startActivity
activate Activity
Activity -> Activity: startActivityForResult
activate Activity
Activity -> Instrumentation: execStartActivity
note right of Instrumentation: 负责Application<br>和Activity的<br>创建和生命周期控制
activate Instrumentation
note right of Instrumentation: 夸进程调用
Instrumentation -> ActivityTaskManagerService: startActivity
activate ActivityTaskManagerService
ActivityTaskManagerService -> ActivityTaskManagerService: startActivityAsUser
note right of ActivityTaskManagerService: 构造ActivityStarter
ActivityTaskManagerService -> ActivityStarter: execute
note right of ActivityStarter: 专门负责<br>一个 Activity 的启动操作。<br> 它的主要作用包括<br>解析 Intent、<br>创建 ActivityRecord、<br>如果有可能<br>还要创建 TaskRecord
activate ActivityStarter
ActivityStarter -> ActivityStarter: executeRequest
ActivityStarter -> ActivityRecord: new
ActivityStarter -> ActivityStarter: startActivityUnchecked
ActivityStarter -> ActivityStarter: startActivityInner
ActivityStarter -> RootWindowContainer: resumeFocusedTasksTopActivities
activate RootWindowContainer
RootWindowContainer -> Task: resumeTopActivityUncheckedLocked
activate Task
Task -> Task: resumeTopActivityInnerLocked
Task -> TaskFragment: resumeTopActivity
activate TaskFragment
TaskFragment -> ActivityTaskSupervisor: startSpecificActivity
activate ActivityTaskSupervisor
ActivityTaskSupervisor -> ClientTransaction: new
ActivityTaskSupervisor -> ClientLifecycleManager: scheduleTransaction
activate ClientLifecycleManager
ClientLifecycleManager -> ApplicationThread: scheduleTransaction
activate ApplicationThread
ApplicationThread -> ActivityThread: scheduleTransaction
ActivityThread-> ActivityThread.H: handleMessage
activate ActivityThread.H
ActivityThread.H -> TransactionExecutor: execute
activate TransactionExecutor
TransactionExecutor -> TransactionExecutor: executeCallbacks
TransactionExecutor -> TransactionExecutor: cycleToPath
TransactionExecutor -> TransactionExecutor: performLifecycleSequence
TransactionExecutor -> TransactionExecutor: handleLaunchActivity
deactivate TransactionExecutor
deactivate ActivityThread.H
deactivate ApplicationThread
deactivate ClientLifecycleManager
deactivate ActivityTaskSupervisor
deactivate TaskFragment
deactivate Task
deactivate RootWindowContainer
deactivate ActivityStarter
deactivate ActivityTaskManagerService
deactivate Instrumentation
deactivate Activity
deactivate Activity</pre>

<h2 id="1710583837-handleRelaunchActivity"><a href="#1710583837-handleRelaunchActivity" class="headerlink" title="[1710583837] handleRelaunchActivity"></a>[1710583837] handleRelaunchActivity</h2><pre><code class="java">    public Activity handleLaunchActivity(ActivityClientRecord r,
            PendingTransactionActions pendingActions, Intent customIntent) &#123;
        ...
        [1710583987] WindowManagerGlobal.initialize();
        ...
        [1710583914] final Activity a = performLaunchActivity(r, customIntent);

        if (a != null) &#123;
            r.createdConfig = new Configuration(mConfigurationController.getConfiguration());
            reportSizeConfigurations(r);
            if (!r.activity.mFinished &amp;&amp; pendingActions != null) &#123;
                pendingActions.setOldState(r.state);
                pendingActions.setRestoreInstanceState(true);
                pendingActions.setCallOnPostCreate(true);
            &#125;
        &#125; else &#123;
            // If there was an error, for any reason, tell the activity manager to stop us.
            ActivityClient.getInstance().finishActivity(r.token, Activity.RESULT_CANCELED,
                    null /* resultData */, Activity.DONT_FINISH_TASK_WITH_ACTIVITY);
        &#125;

        return a;
    &#125;
</code></pre>
<h2 id="1710583837-1710583987-WindowManagerGlobal-initialize"><a href="#1710583837-1710583987-WindowManagerGlobal-initialize" class="headerlink" title="[1710583837]#[1710583987] WindowManagerGlobal.initialize();"></a>[1710583837]#[1710583987] WindowManagerGlobal.initialize();</h2><pre><code class="java">// android.view.WindowManager
public final class WindowManagerGlobal &#123;
    ...
    @UnsupportedAppUsage
    public static void initialize() &#123;
        [1710584110] getWindowManagerService();
    &#125;
</code></pre>
<h2 id="1710583987-1710584110-getWindowManagerService"><a href="#1710583987-1710584110-getWindowManagerService" class="headerlink" title="[1710583987]#[1710584110] getWindowManagerService();"></a>[1710583987]#[1710584110] getWindowManagerService();</h2><pre><code class="java">// android.view.WindowManager
    @UnsupportedAppUsage
    public static IWindowManager getWindowManagerService() &#123;
        synchronized (WindowManagerGlobal.class) &#123;
                [1710584184] sWindowManagerService = IWindowManager.Stub.asInterface(
                        ServiceManager.getService(&quot;window&quot;));
                        ...
            return sWindowManagerService;
        &#125;
    &#125;
</code></pre>
<h2 id="1710584110-1710584184-sWindowManagerService-IWindowManager-Stub-asInterface"><a href="#1710584110-1710584184-sWindowManagerService-IWindowManager-Stub-asInterface" class="headerlink" title="[1710584110]#[1710584184] sWindowManagerService &#x3D; IWindowManager.Stub.asInterface("></a>[1710584110]#[1710584184] sWindowManagerService &#x3D; IWindowManager.Stub.asInterface(</h2><p>将 <code>sWindowManagerService</code> 作为 <code>WindowManagerGlobal</code> 的静态变量保存</p>
<pre><code class="java">// android.view.WindowManagerGlobal
    private static IWindowManager sWindowManagerService;
</code></pre>
<h2 id="1710583837-1710583914-final-Activity-a-performLaunchActivity-r-customIntent"><a href="#1710583837-1710583914-final-Activity-a-performLaunchActivity-r-customIntent" class="headerlink" title="[1710583837]#[1710583914] final Activity a &#x3D; performLaunchActivity(r, customIntent);"></a>[1710583837]#[1710583914] final Activity a &#x3D; performLaunchActivity(r, customIntent);</h2><p>创建<code>Activity</code>，</p>
<pre><code class="java">// android.app.ActivityThread
    /**  Core implementation of activity launch. */
    private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;
        ...
        [1710592951] ContextImpl appContext = createBaseContextForActivity(r);
        ...
            [1710584434] activity = mInstrumentation.newActivity(
                    cl, component.getClassName(), r.intent);
                ...
                [1710584653] activity.attach(appContext, this, getInstrumentation(), r.token,
                        r.ident, app, r.intent, r.activityInfo, title, r.parent,
                        r.embeddedID, r.lastNonConfigurationInstances, config,
                        r.referrer, r.voiceInteractor, window, r.activityConfigCallback,
                        r.assistToken, r.shareableActivityToken);
                ...
                   [1710680290] mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);
        ...
        return activity;
    &#125;
</code></pre>
<h2 id="1710583914-1710592951-ContextImpl-appContext-createBaseContextForActivity-r"><a href="#1710583914-1710592951-ContextImpl-appContext-createBaseContextForActivity-r" class="headerlink" title="[1710583914]#[1710592951] ContextImpl appContext &#x3D; createBaseContextForActivity(r);"></a>[1710583914]#[1710592951] ContextImpl appContext &#x3D; createBaseContextForActivity(r);</h2><pre><code class="java">// android.app.ActivityThread
    private ContextImpl createBaseContextForActivity(ActivityClientRecord r) &#123;
        final int displayId = ActivityClient.getInstance().getDisplayId(r.token);
        [1710593100] ContextImpl appContext = ContextImpl.createActivityContext(
                this, r.packageInfo, r.activityInfo, r.token, displayId, r.overrideConfig);
        ...
        return appContext;
    &#125;
</code></pre>
<h2 id="1710592951-1710593100-ContextImpl-appContext-ContextImpl-createActivityContext"><a href="#1710592951-1710593100-ContextImpl-appContext-ContextImpl-createActivityContext" class="headerlink" title="[1710592951]#[1710593100] ContextImpl appContext &#x3D; ContextImpl.createActivityContext("></a>[1710592951]#[1710593100] ContextImpl appContext &#x3D; ContextImpl.createActivityContext(</h2><pre><code class="java">// android.app.ContextImpl
    static ContextImpl createActivityContext(ActivityThread mainThread,
            LoadedApk packageInfo, ActivityInfo activityInfo, IBinder activityToken, int displayId,
            Configuration overrideConfiguration) &#123;
        ...
        [1710596093] ContextImpl context = new ContextImpl(null, mainThread, packageInfo, ContextParams.EMPTY,
                attributionTag, null, activityInfo.splitName, activityToken, null, 0, classLoader,
                null);
</code></pre>
<p><code>[1710596093] ContextImpl context = new ContextImpl</code> 这里新建一个 <code>ContextImpl</code></p>
<h2 id="1710583914-1710584434-activity-mInstrumentation-newActivity"><a href="#1710583914-1710584434-activity-mInstrumentation-newActivity" class="headerlink" title="[1710583914]#[1710584434] activity &#x3D; mInstrumentation.newActivity("></a>[1710583914]#[1710584434] activity &#x3D; mInstrumentation.newActivity(</h2><pre><code class="java">// android.app.Instrumentation
    public Activity newActivity(ClassLoader cl, String className,
            Intent intent)
            throws InstantiationException, IllegalAccessException,
            ClassNotFoundException &#123;
        String pkg = intent != null &amp;&amp; intent.getComponent() != null
                ? intent.getComponent().getPackageName() : null;
        return [1710584537] getFactory(pkg).instantiateActivity(cl, className, intent);
    &#125;
</code></pre>
<pre><code class="java">// android.app.AppComponentFactory
    public @NonNull Activity instantiateActivity(@NonNull ClassLoader cl, @NonNull String className,
            @Nullable Intent intent)
            throws InstantiationException, IllegalAccessException, ClassNotFoundException &#123;
        return (Activity) cl.loadClass(className).newInstance();
    &#125;
</code></pre>
<p>通过 <code>ClassLoader</code> 加载 <code>Activity</code></p>
<h2 id="1710583914-1710584653-activity-attach-appContext-this-getInstrumentation-r-token"><a href="#1710583914-1710584653-activity-attach-appContext-this-getInstrumentation-r-token" class="headerlink" title="[1710583914]#[1710584653] activity.attach(appContext, this, getInstrumentation(), r.token,"></a>[1710583914]#[1710584653] activity.attach(appContext, this, getInstrumentation(), r.token,</h2><pre><code class="java">// android.app.Activity
    final void attach(Context context, ActivityThread aThread,
            Instrumentation instr, IBinder token, int ident,
            Application application, Intent intent, ActivityInfo info,
            CharSequence title, Activity parent, String id,
            NonConfigurationInstances lastNonConfigurationInstances,
            Configuration config, String referrer, IVoiceInteractor voiceInteractor,
            Window window, ActivityConfigCallback activityConfigCallback, IBinder assistToken,
            IBinder shareableActivityToken) &#123;
        [1710661255] attachBaseContext(context);
        ...
        [1710584779] mWindow = new PhoneWindow(this, window, activityConfigCallback);
        ...
        [1710591610] mWindow.setWindowManager(
                [1710591904] (WindowManager)context.getSystemService([1710595218]Context.WINDOW_SERVICE),
                mToken, mComponent.flattenToString(),
                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0);
        if (mParent != null) &#123;
            mWindow.setContainer(mParent.getWindow());
        &#125;
        [1710596714] mWindowManager = mWindow.getWindowManager();
        mCurrentConfig = config;

        mWindow.setColorMode(info.colorMode);
        mWindow.setPreferMinimalPostProcessing(
                (info.flags &amp; ActivityInfo.FLAG_PREFER_MINIMAL_POST_PROCESSING) != 0);

        getAutofillClientController().onActivityAttached(application);
        setContentCaptureOptions(application.getContentCaptureOptions());
    &#125;
</code></pre>
<pre><code class="java">// android.app.Activity
    @UnsupportedAppUsage
    [1710596612] private Window mWindow;
</code></pre>
<pre><code class="java">// android.app.Activity
    @UnsupportedAppUsage
    [1710596656] private WindowManager mWindowManager;
</code></pre>
<h2 id="1710584653-1710661255-attachBaseContext-context"><a href="#1710584653-1710661255-attachBaseContext-context" class="headerlink" title="[1710584653]#[1710661255] attachBaseContext(context);"></a>[1710584653]#[1710661255] attachBaseContext(context);</h2><p>给 <code>Activity</code> 设置 <code>mBase</code>(base context)</p>
<pre><code class="java">// android.app.Activity
    @Override
    protected void attachBaseContext(Context newBase) &#123;
        [1710661335] super.attachBaseContext(newBase);
        ...
</code></pre>
<h2 id="1710661255-1710661335-super-attachBaseContext-newBase"><a href="#1710661255-1710661335-super-attachBaseContext-newBase" class="headerlink" title="[1710661255]#[1710661335] super.attachBaseContext(newBase);"></a>[1710661255]#[1710661335] super.attachBaseContext(newBase);</h2><pre><code class="java">// android.view.ContextThemeWrapper
    @Override
    protected void attachBaseContext(Context newBase) &#123;
        [1710661397] super.attachBaseContext(newBase);
    &#125;
</code></pre>
<h2 id="1710661335-1710661397-super-attachBaseContext-newBase"><a href="#1710661335-1710661397-super-attachBaseContext-newBase" class="headerlink" title="[1710661335]#[1710661397] super.attachBaseContext(newBase);"></a>[1710661335]#[1710661397] super.attachBaseContext(newBase);</h2><p>Set the base context for this ContextWrapper.  All calls will then be delegated to the base context.</p>
<pre><code class="java">// android.content.ContextWrapper
    protected void attachBaseContext(Context base) &#123;
        if (mBase != null) &#123;
            throw new IllegalStateException(&quot;Base context already set&quot;);
        &#125;
        mBase = base;
    &#125;
</code></pre>
<p>所以 <code>ContextWrapper</code>是什么</p>
<h2 id="1710661397-1710662024-ContextWrapper"><a href="#1710661397-1710662024-ContextWrapper" class="headerlink" title="[1710661397]#[1710662024] ContextWrapper"></a>[1710661397]#[1710662024] ContextWrapper</h2><p>Proxying implementation of Context that simply delegates all of its calls to another Context</p>
<pre><code class="java">public class ContextWrapper extends Context &#123;
</code></pre>
<pre class="mermaid">classDiagram
class Context
class ContextWrapper {
    mBase Context
}
class ContextThemeWrapper
class Activity

ContextWrapper --|> Context
Context --o ContextWrapper
ContextThemeWrapper --|> ContextWrapper
Activity --|> ContextThemeWrapper</pre>

<h2 id="1710591904-WindowManager-context-getSystemService-Context-WINDOW-SERVICE"><a href="#1710591904-WindowManager-context-getSystemService-Context-WINDOW-SERVICE" class="headerlink" title="[1710591904] (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),"></a>[1710591904] (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</h2><p><code>context</code> 来自 <code>[1710596093]</code>，也就是 <code>Activity.mBase (Context)</code>(see [1710661255])</p>
<pre><code class="java">// frameworks/base/core/java/android/app/ContextImpl.java
    @Override
    public Object getSystemService(String name) &#123;
        ...
        return [1710594900] SystemServiceRegistry.getSystemService(this, name);
    &#125;
</code></pre>
<h2 id="1710591904-1710594900-SystemServiceRegistry-getSystemService-this-name"><a href="#1710591904-1710594900-SystemServiceRegistry-getSystemService-this-name" class="headerlink" title="[1710591904]#[1710594900] SystemServiceRegistry.getSystemService(this, name)"></a>[1710591904]#[1710594900] SystemServiceRegistry.getSystemService(this, name)</h2><pre><code class="java">    /**
     * Gets a system service from a given context.
     * @hide
     */
    public static Object getSystemService(ContextImpl ctx, String name) &#123;
        ..
        final ServiceFetcher&lt;?&gt; fetcher = [1710595007] SYSTEM_SERVICE_FETCHERS.get(name);
        ..
        final Object ret = fetcher.getService(ctx);
        ..
        return ret;
    &#125;
</code></pre>
<p>从 <code>[1710595007] SYSTEM_SERVICE_FETCHERS</code> 中获取先前通过 <code>[1710592455] registerService</code> 注册的 fetcher,也就是个 Factory，使用其创建 <code>Service</code>, 而对于传入的 Key(<code>[1710595218]Context.WINDOW_SERVICE</code>)，返回的 Fetcher 会创建 <code>[1710595130] WindowManagerImpl(ctx)</code>, 也就是 <code>WindowManager</code> 的实现类</p>
<h2 id="1710594900-1710592317-SystemServiceRegistry"><a href="#1710594900-1710592317-SystemServiceRegistry" class="headerlink" title="[1710594900]#[1710592317] SystemServiceRegistry"></a>[1710594900]#[1710592317] SystemServiceRegistry</h2><p>Manages all of the system services that can be returned by {@link Context#getSystemService}</p>
<pre><code class="java">// android.app.SystemServiceRegistry
public final class SystemServiceRegistry &#123;
    static &#123;
        ...
        [1710592455] registerService(Context.WINDOW_SERVICE, WindowManager.class,
                new CachedServiceFetcher&lt;WindowManager&gt;() &#123;
            @Override
            public WindowManager createService(ContextImpl ctx) &#123;
                return new [1710595130] WindowManagerImpl(ctx);
            &#125;&#125;);
</code></pre>
<h2 id="1710592317-1710592455-registerService-Context-WINDOW-SERVICE-WindowManager-class"><a href="#1710592317-1710592455-registerService-Context-WINDOW-SERVICE-WindowManager-class" class="headerlink" title="[1710592317]#[1710592455] registerService(Context.WINDOW_SERVICE, WindowManager.class,"></a>[1710592317]#[1710592455] registerService(Context.WINDOW_SERVICE, WindowManager.class,</h2><pre><code class="java">// android.app.SystemServiceRegistry
    private static &lt;T&gt; void registerService(@NonNull String serviceName,
            @NonNull Class&lt;T&gt; serviceClass, @NonNull ServiceFetcher&lt;T&gt; serviceFetcher) &#123;
        SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);
        SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);
        SYSTEM_SERVICE_CLASS_NAMES.put(serviceName, serviceClass.getSimpleName());
    &#125;
</code></pre>
<h2 id="1710584653-1710584779-mWindow-new-PhoneWindow-this-window-activityConfigCallback"><a href="#1710584653-1710584779-mWindow-new-PhoneWindow-this-window-activityConfigCallback" class="headerlink" title="[1710584653]#[1710584779] mWindow &#x3D; new PhoneWindow(this, window, activityConfigCallback);"></a>[1710584653]#[1710584779] mWindow &#x3D; new PhoneWindow(this, window, activityConfigCallback);</h2><p>在当前 <code>Activity</code> 创建 <code>Window</code>，并且赋值给 <code>Activity.mWindow</code></p>
<pre><code class="java">// android.app.Activity
    @UnsupportedAppUsage
    private Window mWindow;
</code></pre>
<h2 id="1710584653-1710591610-mWindow-setWindowManager"><a href="#1710584653-1710591610-mWindow-setWindowManager" class="headerlink" title="[1710584653]#[1710591610] mWindow.setWindowManager("></a>[1710584653]#[1710591610] mWindow.setWindowManager(</h2><p>为 <code>Window</code> 设置 <code>WindowManager</code></p>
<p>此时 <code>mWindow</code> 就是 <code>Activity.mWindow</code>(see [1710662024])，</p>
<pre><code class="java">// android.view.Window
    public void setWindowManager(WindowManager wm, IBinder appToken, String appName,
            boolean hardwareAccelerated) &#123;
        ...
        [1710596387] mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(this);
    &#125;
</code></pre>
<pre><code class="java">// android.view.Window
    @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P, trackingBug = 115609023)
    [1710596791] private WindowManager mWindowManager;
</code></pre>
<p>给 Window#<code>[1710596791] private WindowManager mWindowManager;</code> 赋值</p>
<h2 id="1710591610-1710596387-mWindowManager-WindowManagerImpl-wm-createLocalWindowManager-this"><a href="#1710591610-1710596387-mWindowManager-WindowManagerImpl-wm-createLocalWindowManager-this" class="headerlink" title="[1710591610]#[1710596387] mWindowManager &#x3D; ((WindowManagerImpl)wm).createLocalWindowManager(this);"></a>[1710591610]#[1710596387] mWindowManager &#x3D; ((WindowManagerImpl)wm).createLocalWindowManager(this);</h2><pre><code class="java">// android.view.WindowManagerImpl
    public WindowManagerImpl createLocalWindowManager(Window parentWindow) &#123;
        return new WindowManagerImpl(mContext, parentWindow, mWindowContextToken);
    &#125;
</code></pre>
<pre><code class="java">    private WindowManagerImpl(Context context, Window parentWindow,
            @Nullable IBinder windowContextToken) &#123;
        mContext = context;
        mParentWindow = parentWindow;
        mWindowContextToken = windowContextToken;
    &#125;
</code></pre>
<pre class="mermaid">classDiagram
class Window {
    <<interface>>
}
class WindowManager {
    <<interface>>
}
class WindowManagerImpl {
    mParentWindow Window
}

WindowManagerImpl --|> WindowManager: impl
Window --o WindowManagerImpl</pre>

<h2 id="1710584653-1710596714-mWindowManager-mWindow-getWindowManager"><a href="#1710584653-1710596714-mWindowManager-mWindow-getWindowManager" class="headerlink" title="[1710584653]#[1710596714] mWindowManager &#x3D; mWindow.getWindowManager();"></a>[1710584653]#[1710596714] mWindowManager &#x3D; mWindow.getWindowManager();</h2><p>给 <code>[1710596656] private WindowManager mWindowManager;</code> 赋值</p>
<pre><code class="java">// android.view.window
    @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P, trackingBug = 115609023)
    private WindowManager mWindowManager;

    ...

    public WindowManager getWindowManager() &#123;
        return mWindowManager;
    &#125;
</code></pre>
<h2 id="1710583837-1710680290-mInstrumentation-callActivityOnCreate-activity-r-state-r-persistentState"><a href="#1710583837-1710680290-mInstrumentation-callActivityOnCreate-activity-r-state-r-persistentState" class="headerlink" title="[1710583837]#[1710680290] mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);"></a>[1710583837]#[1710680290] mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</h2><p><code>mWindowManager</code> 在 <code>[1710591610]</code> -&gt; <code>[1710596387]</code> 处赋值</p>
<h2 id="总结以上-2"><a href="#总结以上-2" class="headerlink" title="总结以上"></a>总结以上</h2><pre class="mermaid">sequenceDiagram
ActivityThread -> ActivityThread: handleLaunchActivity
activate ActivityThread
ActivityThread -> ActivityThread: performLaunchActivity
activate ActivityThread
ActivityThread -> ActivityThread: 创建Activity的base Context
ActivityThread -> Instrumentation: newActivity
ActivityThread -> Activity: attach
activate Activity
Activity -> Activity: attachBaseContext(ContextImpl绑定-装饰者模式)
Activity -> Activity: 新建PhoneWindow赋值给Activity.mWindow
Activity -> Window: 创建WindowManager赋值给Activity.mWindowManager
deactivate Activity
ActivityThread -> Instrumentation: callActivityOnCreate
activate Instrumentation
Instrumentation -> Activity: performCreate
Activity -> Activity: onCreate
deactivate Instrumentation
deactivate ActivityThread
deactivate ActivityThread</pre>

<pre class="mermaid">classDiagram
class ViewManager {
    <<interface>>
}
class WindowManager {
    <<interface>>
}
class Window {
    <<abstract>>
    WindowManager mWindowManager
}
class Activity {
    Window mWindow
    WindowManager mWindowManager
}
class ViewGroup
class WindowManagerImpl

WindowManager --|> ViewManager: extend
ViewGroup --|> ViewManager: impl
WindowManagerImpl --|> WindowManager: impl
Window --> WindowManager
Activity --> Window
Activity --> WindowManager</pre>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/40a9c93b5a8d">Android窗口机制（一）初识Android的窗口结构</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/csdn_of_coder/article/details/78147399">Android – Activity启动过程中的上下文环境初始化分析</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6994823348190445604#heading-1">Android 11源码分析： Activity的启动流程</a></li>
</ul>

</article>

<script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<div id="paginator">
  
</div>

      </div>
    </div>

  </div>

  <!-- 底部信息 -->
  <div id="bottom-outer">
    <div id="bottom-inner">
      Site by Swithun Liu using
      <a target="_blank" rel="noopener" href="http://hexo.io">hexo blog framework</a>.
      <br>
      <a href="/">Home</a>
    </div>
  </div>


  
  <!-- scripts list from theme config.yml -->
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.0-alpha1/highlight.min.js"></script>
  
  <script src="/lib/jquery-3.4.1.min.js"></script>
  
  <script src="/lib/jquery.pjax.js"></script>
  
  <script src="/js/again.js"></script>
  
  


  <!-- 高亮脚本启动 -->
  <script>hljs.initHighlightingOnLoad();</script>

    <!-- 如果设置中mermaid选项打开 -->
    
    <!-- 引入mermaid脚本 -->
    <div class=".pjax-reload">
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.0.0-alpha.4/mermaid.min.js'></script>
    </div>
    <!-- mermaid启动 -->
    <script>
      if (window.mermaid) {
        mermaid.initialize({ theme: 'dark' });
      }
    </script>
    

</body>

</html>