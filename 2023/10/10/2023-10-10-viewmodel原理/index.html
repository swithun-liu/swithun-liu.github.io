

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>ViewModel配置变更后仍然存在原理 [ Hexo ]</title>

  
  <!-- stylesheets list from _config.yml -->
  
  <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css">
  
  <link rel="stylesheet" href="/lib/highlight/styles/atom-one-dark">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  
  <link rel="stylesheet" href="/css/again.css">
  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>

  <!-- menu -->
  <div id="menu-outer">
    <div id="menu-inner">
      
      <a class="menu-button" href="/">Home</a>
      
      <a class="menu-button" href="/about">About</a>
      
      <a class="menu-button" href="/contact">Contact</a>
      
      <a class="menu-button" href="/archives">Archives</a>
      
      <a class="menu-button" href="/categories">Category</a>
      
    </div>
  </div>

  <!-- 中间主体 -->
  <div id="main">
    <!-- 侧边栏 -->
    <div id="aside-outer">
      <aside>
        <!-- 搜索栏 -->
<div id="search">
    <input class="search-input" type="text" placeholder="search">
    <i id="search-icon" class="fa fa-bars" title="切换目录与索引"></i>
</div>

<!-- 侧边目录栏 -->
<div id="tree">
    

    
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/11/hello-world/">
                            <i class="fa fa-file"></i>
                            hello-world
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file active">
                        <a href="/2023/10/10/2023-10-10-viewmodel原理/">
                            <i class="fa fa-file"></i>
                            2023-10-10-viewmodel原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/test/">
                            <i class="fa fa-file"></i>
                            test
                        </a>
                    </li>
                </ul>

              
</div>

<div id="toc" style="display: none;"></div>
      </aside>
    </div>
    <!-- 文章内容 -->
    <div id="content-outer">
      <div id="content-inner">
        
<article id="post">
  <h1>ViewModel配置变更后仍然存在原理</h1>
  <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="##Activity%E5%88%9B%E5%BB%BAViewModel">Activity创建ViewModel</a></li>
<li><a href="##Activity%E9%87%8D%E5%BB%BAViewModel%E4%BF%9D%E6%8C%81%E5%AD%98%E5%9C%A8%E7%9A%84%E5%AE%9E%E7%8E%B0">Activity重建ViewModel保持存在的实现</a><ul>
<li><a href="###relaunch%E4%B9%8B%E5%90%8E%E6%96%B0%E7%9A%84Activity%E8%8E%B7%E5%8F%96%E4%B9%8B%E5%89%8D%E7%9A%84viewModel">relaunch之后新的Activity获取之前的viewModel</a></li>
<li><a href="###relaunch%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BF%9D%E5%AD%98%E6%97%A7Activity%E7%9A%84viewModel">relaunch过程中保存旧Activity的viewModel</a></li>
</ul>
</li>
<li><a href="##reference">reference</a></li>
</ul>
<blockquote>
<p>2022&#x2F;08&#x2F;21</p>
</blockquote>
<h2 id="Activity创建ViewModel"><a href="#Activity创建ViewModel" class="headerlink" title="Activity创建ViewModel"></a>Activity创建ViewModel</h2><ul>
<li><p>创建ViewModel</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyActivity#onCreate()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> mainViewModel = </span><br><span class="line">            [V1]   ViewModelProvider(<span class="keyword">this</span>)</span><br><span class="line">              [V2]       .<span class="keyword">get</span>(MainViewModel::<span class="keyword">class</span>.java)</span><br></pre></td></tr></table></figure></li>
<li><p><code>[V1]</code></p>
<p>ViewModelProvider构造函数</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// androidx.lifecycle.ViewModelProvider#get(java.lang.Class&lt;T&gt;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">constructor</span>(</span><br><span class="line">        owner: ViewModelStoreOwner</span><br><span class="line">    ) : <span class="keyword">this</span>(owner.viewModelStore, defaultFactory(owner), defaultCreationExtras(owner))</span><br></pre></td></tr></table></figure>

<p>this指MyActivity，即MyActivity应该是<code>[I]ViewModelStoreOwner</code>类型</p>
<p>MyActivity继承<code>[C]ComponentActivity]</code>，ComponentActivity实现了<code>[I]ViewModelStoreOwner</code>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CompnentActivity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ComponentActivity</span> <span class="keyword">extends</span> <span class="title class_">androidx</span>.core.app.ComponentActivity implements</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        ViewModelStoreOwner,</span><br><span class="line">        <span class="comment">// ... &#123;</span></span><br></pre></td></tr></table></figure>

<p><code>this(owner.viewModelStore, defaultFactory(owner), defaultCreationExtras(owner))</code> ，这里使用 <code>owner.viewModelStore</code>从ViewModelStoreOwner中取出<code>[OC]ViewModelStore]</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewModelStoreOwner</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ViewModelStoreOwner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The owned [ViewModelStore]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> viewModelStore: ViewModelStore</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后调用下面的构造函数</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewModelStoreOwner</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a ViewModelProvider</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> store `ViewModelStore` where ViewModels will be stored.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> factory factory a `Factory` which will be used to instantiate new `ViewModels`</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> defaultCreationExtras extras to pass to a factory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@JvmOverloads</span></span><br><span class="line"><span class="keyword">constructor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> store: ViewModelStore,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> factory: Factory,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> defaultCreationExtras: CreationExtras = CreationExtras.Empty,</span><br><span class="line">) &#123;</span><br></pre></td></tr></table></figure></li>
<li><p><code>[V2]</code></p>
<p>调用了get方法⬇️</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// androidx.lifecycle.ViewModelProvider#get(java.lang.Class&lt;T&gt;)</span></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel&gt;</span> <span class="title">get</span><span class="params">(modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: T &#123;</span><br><span class="line">        <span class="keyword">val</span> canonicalName = modelClass.canonicalName</span><br><span class="line">            ?: <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Local and anonymous classes can not be ViewModels&quot;</span>)</span><br><span class="line">   [W1]  <span class="keyword">return</span> <span class="keyword">get</span>(<span class="string">&quot;<span class="variable">$DEFAULT_KEY</span>:<span class="variable">$canonicalName</span>&quot;</span>, modelClass)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>[W1]</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// androidx.lifecycle.ViewModelProvider#get(java.lang.String, java.lang.Class&lt;T&gt;)</span></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel&gt;</span> <span class="title">get</span><span class="params">(key: <span class="type">String</span>, modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: T &#123;</span><br><span class="line">    [X1]<span class="keyword">val</span> viewModel = store[key]</span><br><span class="line">    [X1]<span class="keyword">if</span> (modelClass.isInstance(viewModel)) &#123;</span><br><span class="line">            ....</span><br><span class="line">    [X1]    <span class="keyword">return</span> viewModel <span class="keyword">as</span> T</span><br><span class="line">        ....</span><br><span class="line">    [X2]<span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">    [X2]     factory.create(modelClass, extras)</span><br><span class="line">    [X2] <span class="keyword">catch</span> (e: AbstractMethodError) &#123;</span><br><span class="line">    [X2]    factory.create(modelClass)</span><br><span class="line">    [X2]&#125;.also &#123; store.put(key, it) &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>[X1]</code>⬅️<code>[W1]</code></p>
<p>从store(<code>[OC]ViewModelStore</code>)中能找到viewmodel则直接返回</p>
</li>
<li><p><code>[X2]</code>⬅️<code>[W1]</code></p>
<p>store中找不到则需要新创建一个viewmodel并放入store，这里说明只要使用同一个ViewModelStore获取ViewModel则不同地方获取到的都是同一个ViewModel</p>
<p><code>[OC]ViewModelStore</code>看起来是个Map，事实上他的实现就是维护一个map，放出get和put方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">ViewModelStore</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> map = mutableMapOf&lt;String, ViewModel&gt;()</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">put</span><span class="params">(key: <span class="type">String</span>, viewModel: <span class="type">ViewModel</span>)</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(key: <span class="type">String</span>)</span></span>: ViewModel? &#123;</span><br><span class="line">        <span class="keyword">return</span> map[key]</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>总结上面，Activity在onCreate时创建viewModel，Activity是一个ViewModelStoreOwner其中有一个ViewModelStore其中维护一个map，ViewModelProvier作为一个工具类在使用默认的&#x2F;我们提供的Factory（为了适配构造函数有参的ViewModel）创建ViewModel的同时会将其存入这个map。</p>
<p>所以，在relaunch过程中，销毁旧的Activity时如果能保存它的mViewModelStore，然后将其赋值新的Activity的mViewModelStore就能实现配置变更viewModel不变更的效果。</p>
<h2 id="Activity重建ViewModel保持存在的实现"><a href="#Activity重建ViewModel保持存在的实现" class="headerlink" title="Activity重建ViewModel保持存在的实现"></a>Activity重建ViewModel保持存在的实现</h2><h3 id="relaunch之后新的Activity获取之前的viewModel"><a href="#relaunch之后新的Activity获取之前的viewModel" class="headerlink" title="relaunch之后新的Activity获取之前的viewModel"></a>relaunch之后新的Activity获取之前的viewModel</h3><p>viewModel存在ViewModelStore中，说明ViewModelStore在Activity重建的过程中能保持存在，看下<code>[C]ComponentActivity</code>如何如何获取<code>[OC]ViewModelStore</code>的</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> ViewModelStore getViewModelStore() &#123;</span><br><span class="line">     <span class="keyword">if</span> (getApplication() == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> new IllegalStateException(<span class="string">&quot;Your activity is not yet attached to the &quot;</span></span><br><span class="line">                 + <span class="string">&quot;Application instance. You can&#x27;t request ViewModel before onCreate call.&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">[T1] ensureViewModelStore();</span><br><span class="line">     <span class="keyword">return</span> mViewModelStore;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>[T1]</code></p>
<p>在getViewModelStore()方法中调用了ensureViewModelStore()确保mViewModelStore不为空</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(<span class="string">&quot;WeakerAccess&quot;</span>)</span> <span class="comment">/* synthetic access */</span></span><br><span class="line">void ensureViewModelStore() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mViewModelStore == <span class="literal">null</span>) &#123;</span><br><span class="line">    [U1] NonConfigurationInstances nc =</span><br><span class="line">                (NonConfigurationInstances) getLastNonConfigurationInstance();</span><br><span class="line">        <span class="keyword">if</span> (nc != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Restore the ViewModelStore from NonConfigurationInstances</span></span><br><span class="line">    [U2]    mViewModelStore = nc.viewModelStore;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mViewModelStore == <span class="literal">null</span>) &#123;</span><br><span class="line">            mViewModelStore = new ViewModelStore();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>[U1]</code>⬅️<code>[T1]</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Activity</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> Object getLastNonConfigurationInstance() &#123;</span><br><span class="line">        <span class="keyword">return</span> mLastNonConfigurationInstances != <span class="literal">null</span></span><br><span class="line">                ? mLastNonConfigurationInstances.activity : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Activirty.mLastNonConfigurationInstances类型为<code>[C]Activity.NonConfigurationInstances</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.app.Activity.NonConfigurationInstances</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonConfigurationInstances</span> &#123;</span><br><span class="line">        Object activity;</span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>mLastNonConfigurationInstances.activity在<code>[U1]</code>处被强转为<code>[C]ComponentActivity.NonConfigurationInstances</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// androidx.activity.ComponentActivity.NonConfigurationInstances</span></span><br><span class="line">    static <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonConfigurationInstances</span> &#123;</span><br><span class="line">        Object custom;</span><br><span class="line">        ViewModelStore viewModelStore;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>[U2]</code>⬅️<code>[T1]</code></p>
<p>如果<code>[U1]</code>获取的nc不为空，则将mViewModelStore赋值为nc.viewModelStore 即Activity.mLastNonConfigurationInstances.activity.viewModelStore</p>
<p>所以想要保存给新Activity使用原来的viewModel，重点就是要在relaunch过程中保存旧的Activity.mLastNonConfigurationInstances然后再赋值给新Activity.mLastNonConfigurationInstances</p>
</li>
</ul>
<h3 id="relaunch过程中保存旧Activity的viewModel"><a href="#relaunch过程中保存旧Activity的viewModel" class="headerlink" title="relaunch过程中保存旧Activity的viewModel"></a>relaunch过程中保存旧Activity的viewModel</h3><p>设备变更，系统调用AMS的updateConfiguration 方法</p>
<p><a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java;l=462?q=ActivityManagerService&sq=&ss=android/platform/superproject" title="ActivityManagerService.java - Android Code Search">ActivityManagerService.java - Android Code Search</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityManagerService</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updateConfiguration</span><span class="params">(Configuration values)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mActivityTaskManager.updateConfiguration(values);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityTaskManagerService</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updateConfiguration</span><span class="params">(Configuration values)</span> &#123;</span><br><span class="line">           ....</span><br><span class="line">                updateConfigurationLocked(values, <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">false</span> <span class="comment">/* persistent */</span>,</span><br><span class="line">           ....</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityTaskManagerService</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">updateConfigurationLocked</span><span class="params">(Configuration values, ActivityRecord starting,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> initLocale, <span class="type">boolean</span> persistent, <span class="type">int</span> userId, <span class="type">boolean</span> deferResume,</span></span><br><span class="line"><span class="params">            ActivityTaskManagerService.UpdateConfigurationResult result)</span> &#123;</span><br><span class="line">            ....</span><br><span class="line">            「I1」  changes = updateGlobalConfigurationLocked(values, initLocale, persistent, userId);</span><br><span class="line">            ....</span><br><span class="line">            「I2」 kept = ensureConfigAndVisibilityAfterUpdate(starting, changes);</span><br><span class="line">            ....</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>「I1」</code></p>
<p>updateGlobalConfigurationLocked 更新当前配置信息</p>
</li>
<li><p><code>「I2」</code></p>
<p>ensureConfigAndVisibilityAfterUpdate 确保给定的activity更新使用的配置</p>
<p>这里starting传入的是null，需要ensureConfigAndVisibilityAfterUpdate中自己获取</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityTaskManagerService</span></span><br><span class="line">    boolean ensureConfigAndVisibilityAfterUpdate(ActivityRecord starting, int changes) &#123;</span><br><span class="line">        boolean kept = <span class="literal">true</span>;</span><br><span class="line">     「J1」   <span class="keyword">final</span> Task mainRootTask = mRootWindowContainer.getTopDisplayFocusedRootTask();</span><br><span class="line">        ....</span><br><span class="line">             「J2」 starting = mainRootTask.topRunningActivity();</span><br><span class="line">        ....</span><br><span class="line">             「J3」 kept = starting.ensureActivityConfiguration(changes,</span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>「J1」</code>⬅️<code>「I2」</code></p>
<p>获取根窗口容器中当前具有焦点的顶级任务（root task）</p>
</li>
<li><p><code>「J2」</code>⬅️<code>「I2」</code></p>
<p>获取顶级任务（root task）中当前正在运行的顶级Activity（top running Activity）的ActivityRecord赋值给starting</p>
</li>
<li><p><code>「J3」</code>⬅️<code>「I2」</code></p>
<p>ActivityRecord对应的Activity更新Configuration</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.wm.ActivityRecord#ensureActivityConfiguration(int, boolean)</span></span><br><span class="line">    boolean ensureActivityConfiguration(int globalChanges, boolean preserveWindow) &#123;</span><br><span class="line">        <span class="keyword">return</span> ensureActivityConfiguration(globalChanges, preserveWindow,</span><br><span class="line">                <span class="literal">false</span> <span class="comment">/* ignoreVisibility */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.wm.ActivityRecord#ensureActivityConfiguration(int, boolean, boolean)</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">ensureActivityConfiguration</span><span class="params">(<span class="type">int</span> globalChanges, <span class="type">boolean</span> preserveWindow,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> ignoreVisibility)</span> &#123;</span><br><span class="line">            ....</span><br><span class="line">                relaunchActivityLocked(preserveWindow);</span><br><span class="line">            ....</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.wm.ActivityRecord#relaunchActivityLocked</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">relaunchActivityLocked</span><span class="params">(<span class="type">boolean</span> preserveWindow)</span> &#123;</span><br><span class="line">           ....</span><br><span class="line">      「K2」  <span class="keyword">final</span> <span class="type">ClientTransactionItem</span> <span class="variable">callbackItem</span> <span class="operator">=</span> ActivityRelaunchItem.obtain(pendingResults,</span><br><span class="line">           ....</span><br><span class="line">      「K1」  <span class="keyword">final</span> <span class="type">ClientTransaction</span> <span class="variable">transaction</span> <span class="operator">=</span> ClientTransaction.obtain(app.getThread(), token);</span><br><span class="line">      「K2」  transaction.addCallback(callbackItem);</span><br><span class="line">           ....</span><br><span class="line">      「K3」  mAtmService.getLifecycleManager().scheduleTransaction(transaction);</span><br><span class="line">           ....</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>「K1」</code>⬅️<code>「J3」</code></p>
<p>token来自<code>[C]ActivityRecord</code>继承的<code>[C]WindowToken</code>中的token</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WindowToken</span> <span class="title">extends</span> <span class="title">WindowContainer</span>&lt;<span class="type">WindowState</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> String TAG = TAG_WITH_CLASS_NAME ? <span class="string">&quot;WindowToken&quot;</span> : TAG_WM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The actual token */</span></span><br><span class="line">    <span class="keyword">final</span> IBinder token;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The type of window this token is for, as per &#123;<span class="doctag">@link</span> WindowManager.LayoutParams&#125; */</span></span><br><span class="line">    <span class="keyword">final</span> int windowType;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ClientTransaction</span></span><br><span class="line">   <span class="comment">/** Obtain an instance initialized with provided params. */</span></span><br><span class="line">   <span class="keyword">public</span> static ClientTransaction obtain(IApplicationThread client, IBinder activityToken) &#123;</span><br><span class="line">       ClientTransaction instance = ObjectPool.obtain(ClientTransaction.<span class="keyword">class</span>);</span><br><span class="line">       <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">           instance = new ClientTransaction();</span><br><span class="line">       &#125;</span><br><span class="line">       instance.mClient = client;</span><br><span class="line">       instance.mActivityToken = activityToken;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> instance;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>将transaction.mActivityToken设置为ActivityRecord.token</p>
</li>
<li><p><code>「K2」</code>⬅️<code>「J3」</code></p>
<p>给transaction放入callback：<code>[C]ActivityRelaunchItem</code></p>
</li>
<li><p><code>「K3」</code>⬅️<code>「J3」</code></p>
<p>执行transaction</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.wm.ClientLifecycleManager#scheduleTransaction(ClientTransaction)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        ....</span><br><span class="line">        transaction.schedule();</span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ClientTransaction</span></span><br><span class="line">    <span class="keyword">public</span> void schedule() throws RemoteException &#123;</span><br><span class="line">   「L1」  mClient.scheduleTransaction(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>「L1」</code>⬅️<code>「K3」</code></p>
<p><code>[C]ClientTransaction</code>使用mClient执行自己</p>
<ul>
<li>mClient是什么?&#x20;<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ClientTransaction</span></span><br><span class="line">    <span class="comment">/** Target client. */</span></span><br><span class="line">    <span class="keyword">private</span> IApplicationThread mClient;</span><br></pre></td></tr></table></figure>
这里是使用AIDL(基于Binder)进行进程间通信，对应文件<code>IApplicationThread.aidl</code>⬇️<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">oneway <span class="keyword">interface</span> <span class="title class_">IApplicationThread</span> &#123;</span><br><span class="line">    ....</span><br><span class="line">    void scheduleTransaction(<span class="keyword">in</span> ClientTransaction transaction);</span><br></pre></td></tr></table></figure>
这里mClient是客户端，对应的客户端为<code>[c]ApplicationThread</code><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ApplicationThread</span> <span class="title">extends</span> <span class="title">IApplicationThread</span>.<span class="title">Stub</span> &#123;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><code>「M1」</code>⬅️<code>「L1」</code></p>
<p>所以下面从 android.app.ActivityThread.ApplicationThread#scheduleTransaction方法继续</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.app.ActivityThread.ApplicationThread#scheduleTransaction</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void scheduleTransaction(ClientTransaction transaction) throws RemoteException &#123;</span><br><span class="line">            ActivityThread.<span class="keyword">this</span>.scheduleTransaction(transaction);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里scheduleTransaction是调用的ActivityThread的基类ClientTransactonHandler中的scheduleTransaction方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.app.ClientTransactionHandler#scheduleTransaction</span></span><br><span class="line">    void scheduleTransaction(ClientTransaction transaction) &#123;</span><br><span class="line"> 「N1」  transaction.preExecute(<span class="keyword">this</span>);</span><br><span class="line"> 「N2」  sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>「N1」</code>⬅️<code>「M1」</code></p>
<p>为后面transaction的执行做些准备，这里this传入的是<code>[C]ActivityThread</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preExecute</span><span class="params">(android.app.ClientTransactionHandler clientTransactionHandler)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mActivityCallbacks != <span class="literal">null</span>) &#123;</span><br><span class="line">        ....</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">        「O1」  mActivityCallbacks.get(i).preExecute(clientTransactionHandler, mActivityToken);</span><br><span class="line">        ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>「O1」</code>⬅️<code>「N1」</code></p>
<p>执行每个callback的preExecute方法，callback只有一个之前在<code>「K2」</code>处放入的ActivityRelaunchItem</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.app.servertransaction.ActivityRelaunchItem#preExecute</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preExecute</span><span class="params">(ClientTransactionHandler client, IBinder token)</span> &#123;</span><br><span class="line">   「P1」 mActivityClientRecord = client.prepareRelaunchActivity(token, mPendingResults,</span><br><span class="line">               mPendingNewIntents, mConfigChanges, mConfig, mPreserveWindow);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>「P1」</code>⬅️ <code>「O1」</code></p>
<p>从ActivityThread(即client)获取要relaunch的ActivityRecord存入ActivityRelaunchItem.mActivityClientRecord</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ActivityClientRecord <span class="title function_">prepareRelaunchActivity</span><span class="params">(IBinder token,</span></span><br><span class="line"><span class="params">        List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> configChanges, MergedConfiguration config, <span class="type">boolean</span> preserveWindow)</span> &#123;</span><br><span class="line">「Q1」     ....</span><br><span class="line"></span><br><span class="line">「Q2」     target = <span class="keyword">new</span> <span class="title class_">ActivityClientRecord</span>();</span><br><span class="line">「Q2」     target.token = token;</span><br><span class="line">            ....</span><br><span class="line">「Q3」     mRelaunchingActivities.add(target);</span><br><span class="line">            ....</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ....target....;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>「Q1」</code>⬅️<code>「P1」</code></p>
<p>检查是否目标activity是否已经正在relaunch了，如果是则返回</p>
</li>
<li><p><code>「Q2」</code>⬅️<code>「P1」</code></p>
<p>目标activity没有已经正在relaunch（这里认为是没有，这个判断只是为了防止relaunch正在relaunch的activity），则构造一个<code>[sC]ActivityClientRecord</code>记录要relaunch的Activity的token等信息</p>
</li>
<li><p><code>「Q3」</code>⬅️<code>「P1」</code>使用ActivityThread.mRelaunchingActivities记录所有要准备重启的ActivityClientRecord</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------------------------------+</span><br><span class="line">|                                                     |</span><br><span class="line">|                 ActivityThread                      |</span><br><span class="line">|                                                     |</span><br><span class="line">|       +-----------------------------------+         |</span><br><span class="line">|       |    mRelaunchingActivities         |         |</span><br><span class="line">|       |                                   |         |</span><br><span class="line">|       |   +------------------------+      |         |</span><br><span class="line">|       |   | ActivityClientRecord   |      |         |</span><br><span class="line">|       |   +------------------------+      |         |</span><br><span class="line">|       |                                   |         |</span><br><span class="line">|       |   +------------------------+      |         |</span><br><span class="line">|       |   | ActivityClientRecord   |      |         |</span><br><span class="line">|       |   +------------------------+      |         |</span><br><span class="line">|       |                                   |         |</span><br><span class="line">|       |           ....                    |         |</span><br><span class="line">|       |                                   |         |</span><br><span class="line">|       |                                   |         |</span><br><span class="line">|       +-----------------------------------+         |</span><br><span class="line">|                                                     |</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>「N2」</code>⬅️<code>「M1」</code></p>
<p>这里使用Handler去真正执行transaction，obj传入的就是transaction</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.app.ClientTransactionHandler#sendMessage</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(<span class="type">int</span> what, Object obj)</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.app.ActivityThread#sendMessage(int, java.lang.Object)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(<span class="type">int</span> what, Object obj)</span> &#123;</span><br><span class="line">        sendMessage(what, obj, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>⬇️构造Message</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.app.ActivityThread#sendMessage(int, java.lang.Object, int, int, boolean)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(<span class="type">int</span> what, Object obj, <span class="type">int</span> arg1, <span class="type">int</span> arg2, <span class="type">boolean</span> async)</span> &#123;</span><br><span class="line">        ....</span><br><span class="line">        msg.what = what;</span><br><span class="line">        msg.obj = obj;</span><br><span class="line">        ....</span><br><span class="line">        mH.sendMessage(msg);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>⬇️handler：ActivityThread.H 收到消息并处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.app.ActivityThread.H#handleMessage</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">             <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">case</span> EXECUTE_TRANSACTION:</span><br><span class="line">              「R1」  <span class="keyword">final</span> <span class="type">ClientTransaction</span> <span class="variable">transaction</span> <span class="operator">=</span> (ClientTransaction) msg.obj;</span><br><span class="line">              「R2」  mTransactionExecutor.execute(transaction);</span><br><span class="line">                    ....</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>「R1」</code>⬅️<code>「N2」</code>从message中取出transaction</p>
</li>
<li><p><code>「R2」</code>⬅️<code>「N2」</code>交给mTransactionExecutor执行</p>
<p>mTransactionHandler 是谁？是<code>[C]ActivityThread</code>，从TransactionExecutor的构造函数⬇️中可以看出</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityThread</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TransactionExecutor mTransactionExecutor = new TransactionExecutor(<span class="keyword">this</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Initialize an instance with transaction handler, that will execute all requested actions. */</span></span><br><span class="line"><span class="keyword">public</span> TransactionExecutor(ClientTransactionHandler clientTransactionHandler) &#123;</span><br><span class="line">    mTransactionHandler = clientTransactionHandler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>TransactionExecutor.mTransactionHandler是对持有该TransactionExecutor的ActivityThread的引用</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------------------------------------------------------------------+</span><br><span class="line">|                                    ActivityThread &lt;-------+                         |</span><br><span class="line">|                                                           |                         |</span><br><span class="line">|                                                           |                         |</span><br><span class="line">|      +-----------------------------------------------------------------+            |</span><br><span class="line">|      |  mTransactionExecutor: TransactionExecutor         |            |            |</span><br><span class="line">|      |                                                    |            |            |</span><br><span class="line">|      |                                                    |            |            |</span><br><span class="line">|      |  +-------------------------------------------------+---------+  |            |</span><br><span class="line">|      |  |   mTransactionHandler: ClientTransactionHandler           |  |            |</span><br><span class="line">|      |  |                                                           |  |            |</span><br><span class="line">|      |  |                                                           |  |            |</span><br><span class="line">|      |  +-----------------------------------------------------------+  |            |</span><br><span class="line">|      |                                                                 |            |</span><br><span class="line">|      |                                                                 |            |</span><br><span class="line">|      +-----------------------------------------------------------------+            |</span><br><span class="line">|                                                                                     |</span><br><span class="line">+-------------------------------------------------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.app.servertransaction.TransactionExecutor#execute</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(ClientTransaction transaction)</span> &#123;</span><br><span class="line">        ....</span><br><span class="line">        executeCallbacks(transaction);</span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.app.servertransaction.TransactionExecutor#executeCallbacks</span></span><br><span class="line">    <span class="keyword">public</span> void executeCallbacks(ClientTransaction transaction) &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;ClientTransactionItem&gt; callbacks = transaction.getCallbacks();</span><br><span class="line">        ....</span><br><span class="line">  「S1」 <span class="keyword">final</span> IBinder token = transaction.getActivityToken();</span><br><span class="line">        ....</span><br><span class="line">        <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">            <span class="keyword">final</span> ClientTransactionItem item = callbacks.<span class="keyword">get</span>(i);</span><br><span class="line">            ....</span><br><span class="line">    「S2」  item.execute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">            ....</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>「S1」</code>⬅️<code>「R2」</code></p>
<p>从transaction中获取activityToken<code>「K1」</code>⬅️<code>「J3」</code></p>
</li>
<li><p><code>「S2」</code>⬅️<code>「R2」</code></p>
<p>callback（为ActivityRelaunchItem）执行，execute方法来自ActivityRelaunchItem 实现的接口BaseClientRequest的execute方法</p>
<p>至于mTransactionHandler是谁，在<code>「R2」</code>已经解释</p>
<p>execute方法来自ActivityRelaunchItem实现的接口BaseClientRequest中的execute方法⬇️</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BaseClientRequest</span> <span class="title">extends</span> <span class="title">ObjectPoolItem</span> &#123;</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line">    void execute(ClientTransactionHandler client, IBinder token,</span><br><span class="line">            PendingTransactionActions pendingActions);</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ActivityRelaunchItem和BaseClientRequest的关系⬇️</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ClientTransactionItem</span> <span class="title">implements</span> <span class="title">BaseClientRequest</span></span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ActivityTransactionItem</span> <span class="title">extends</span> <span class="title">ClientTransactionItem</span></span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityRelaunchItem</span> <span class="title">extends</span> <span class="title">ActivityTransactionItem</span></span><br></pre></td></tr></table></figure>

<pre class="mermaid">    classDiagram
      class ClientTransactionItem {
      }
      class ActivityTransactionItem {
      }
      class ActivityRelaunchItem {
      }
      class BaseClientRequest {
         <<interface>>
         + execute(ClientTransactionHandler client, IBinder token,PendingTransactionActions pendingActions)
      }
      ClientTransactionItem <|-- ActivityTransactionItem
      ActivityTransactionItem <|-- ActivityRelaunchItem
      BaseClientRequest <|-- ClientTransactionItem: implements</pre>

<p>该execute方法由<code>[C]ActivityRelaunchItem</code>的基类ActivityTransactionItem实现</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityTransactionItem</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> void execute(ClientTransactionHandler client, IBinder token,</span><br><span class="line">            PendingTransactionActions pendingActions) &#123;</span><br><span class="line">   「A1」  <span class="keyword">final</span> ActivityClientRecord r = getActivityClientRecord(client, token);</span><br><span class="line"></span><br><span class="line">   「A2」  execute(client, r, pendingActions);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>「A1」</code>根据token获取ActivityClientRecord</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityTransactionItem</span></span><br><span class="line">    <span class="meta">@NonNull</span> ActivityClientRecord getActivityClientRecord(</span><br><span class="line">            <span class="meta">@NonNull</span> ClientTransactionHandler client, IBinder token) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityClientRecord r = client.getActivityClient(token);</span><br><span class="line">        ....</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>client是 TransactionExecutor.mTransactionHandler，也就是持有TransactionExecutor的ActivityThread</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityThread </span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ActivityClientRecord <span class="title function_">getActivityClient</span><span class="params">(IBinder token)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mActivities.get(token);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>「A2」</code>继续执行 ⬇️</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityRelaunchItem</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(ClientTransactionHandler client, ActivityClientRecord r,</span></span><br><span class="line"><span class="params">            PendingTransactionActions pendingActions)</span> &#123;</span><br><span class="line">        ....</span><br><span class="line">  「B1」  client.handleRelaunchActivity(mActivityClientRecord, pendingActions);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>「B1」</code>mActivityClientRecord从哪里来？之前🔗<code>「P1」</code>⬅️ <code>「O1」</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityThread</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void handleRelaunchActivity(ActivityClientRecord tmp,</span><br><span class="line">            PendingTransactionActions pendingActions) &#123;</span><br><span class="line">        ...</span><br><span class="line">    「C1」 ActivityClientRecord r = mActivities.<span class="keyword">get</span>(tmp.token);</span><br><span class="line">        ...</span><br><span class="line">    「C2」handleRelaunchActivityInner(r, configChanges, tmp.pendingResults, tmp.pendingIntents,</span><br><span class="line">                pendingActions, tmp.startsNotResumed, tmp.overrideConfig, <span class="string">&quot;handleRelaunchActivity&quot;</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>「C1」</code>⬅️<code>「B1」</code></p>
<p>这里从<code>mActivities</code>中根据token获取<code>[sC]ActivityClientRecord</code></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------------------------------------+</span><br><span class="line">|   ActivityThread                                               |</span><br><span class="line">|                                                                |</span><br><span class="line">|                                                                |</span><br><span class="line">|    +------------------------------------------------------+    |</span><br><span class="line">|    |  mActivities                                         |    |</span><br><span class="line">|    |             +--------------------------------------+ |    |</span><br><span class="line">|    |             |      +---------------+               | |    |</span><br><span class="line">|    |             |      |    Activity   |               | |    |</span><br><span class="line">|    |             |      +---------------+               | |    |</span><br><span class="line">|    |             |                                      | |    |</span><br><span class="line">|    |             |   +-------------------------------+  | |    |</span><br><span class="line">|    |             |   | lastNonConfigurationInstances |  | |    |</span><br><span class="line">|    |             |   +-------------------------------+  | |    |</span><br><span class="line">|    |             |                                      | |    |</span><br><span class="line">|    |             +--------------------------------------+ |    |</span><br><span class="line">|    |             +--------------------------------------+ |    |</span><br><span class="line">|    |             |                                      | |    |</span><br><span class="line">|    |             |                                      | |    |</span><br><span class="line">|    |             +--------------------------------------+ |    |</span><br><span class="line">|    |             +--------------------------------------+ |    |</span><br><span class="line">|    |             |                                      | |    |</span><br><span class="line">|    |             |                                      | |    |</span><br><span class="line">|    |             +--------------------------------------+ |    |</span><br><span class="line">|    |                                                      |    |</span><br><span class="line">|    |                           ...                        |    |</span><br><span class="line">|    |                                                      |    |</span><br><span class="line">|    +------------------------------------------------------+    |</span><br><span class="line">+----------------------------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>「C2」</code>⬅️<code>「B1」</code></p>
<p>传递r给</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityThread</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleRelaunchActivityInner</span><span class="params">(ActivityClientRecord r, <span class="type">int</span> configChanges,</span></span><br><span class="line"><span class="params">            List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingIntents,</span></span><br><span class="line"><span class="params">            PendingTransactionActions pendingActions, <span class="type">boolean</span> startsNotResumed,</span></span><br><span class="line"><span class="params">            Configuration overrideConfig, String reason)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">「D1」        handleDestroyActivity(r, <span class="literal">false</span>, configChanges, <span class="literal">true</span>, reason);</span><br><span class="line">        ...</span><br><span class="line">「D2」        handleLaunchActivity(r, pendingActions, customIntent);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>「D1」</code>⬅️<code>「C2」</code></p>
<p>⬇️Destroy原来的Activity，其中getNonConfigInstance传入了true</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityThread</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDestroyActivity</span><span class="params">(ActivityClientRecord r, <span class="type">boolean</span> finishing, <span class="type">int</span> configChanges,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> getNonConfigInstance, String reason)</span> &#123;</span><br><span class="line">        performDestroyActivity(r, finishing, configChanges, getNonConfigInstance, reason);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>⬇️将原来的activity的nonConfigurationInstances存入ActivityRecord.lastNonConfigurationInstances</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityThread</span></span><br><span class="line">    <span class="comment">/** Core implementation of activity destroy call. */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">performDestroyActivity</span><span class="params">(ActivityClientRecord r, <span class="type">boolean</span> finishing,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> configChanges, <span class="type">boolean</span> getNonConfigInstance, String reason)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    「E1」 <span class="keyword">if</span> (getNonConfigInstance) &#123;</span><br><span class="line">            ....</span><br><span class="line">            「E2」  r.lastNonConfigurationInstances = r.activity.retainNonConfigurationInstances();</span><br><span class="line">            ....</span><br></pre></td></tr></table></figure></li>
<li><p><code>「E1」</code>这里如果是getNonConfigInstance为true（前面传的是true），</p>
</li>
<li><p><code>「E2」</code></p>
<p>则️将retainNonConfigurationInstances的结果放入<code>[sC]ActivityClientRecord</code>.lastNonConfigurationInstances，其中就包含viewModelStore</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// Activity</span></span><br><span class="line">    NonConfigurationInstances <span class="title function_">retainNonConfigurationInstances</span><span class="params">()</span> &#123;</span><br><span class="line">「F1」 <span class="type">Object</span> <span class="variable">activity</span> <span class="operator">=</span> onRetainNonConfigurationInstance();</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">NonConfigurationInstances</span> <span class="variable">nci</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NonConfigurationInstances</span>();</span><br><span class="line">        nci.activity = activity;</span><br><span class="line">        ....</span><br><span class="line">        <span class="keyword">return</span> nci;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>「F1」</code>Activity默认实现中只返回了null，但是<code>[C]ComponentActivity</code>重写了这个方法⬇️</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// ComponentActivity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">onRetainNonConfigurationInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Maintain backward compatibility.</span></span><br><span class="line">「G1」  <span class="type">Object</span> <span class="variable">custom</span> <span class="operator">=</span> onRetainCustomNonConfigurationInstance();</span><br><span class="line"></span><br><span class="line">        <span class="type">ViewModelStore</span> <span class="variable">viewModelStore</span> <span class="operator">=</span> mViewModelStore;</span><br><span class="line">「G2」  <span class="keyword">if</span> (viewModelStore == <span class="literal">null</span>) &#123;</span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line">        ....</span><br><span class="line"></span><br><span class="line">「G3」   <span class="type">NonConfigurationInstances</span> <span class="variable">nci</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NonConfigurationInstances</span>();</span><br><span class="line">        nci.custom = custom;</span><br><span class="line">        nci.viewModelStore = viewModelStore;</span><br><span class="line">        <span class="keyword">return</span> nci;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>「G1」</code>我们可以通过重写onRetainCustomNonConfigurationInstance()创建custom即自定义的在configuration改变后仍然想要保存的数据。</p>
</li>
<li><p><code>「G2」</code>这里当viewModelStore为空的时候会查看<code>[C]ComponentActivity.NonConfigurationInstances</code>中是否有viewModelStore，这里对应从来没有地方调用过getViewModelStore，也就不会初始化ComponentActivity.mVieModelStore，但是我们这里情况是之前有创建viewmodel，<code>this(owner.viewModelStore, defaultFactory(owner), defaultCreationExtras(owner))</code> ，这里使用 <code>owner.viewModelStore</code>从ViewModelStoreOwner中取出<code>[OC]ViewModelStore</code>调用过，所有不会走到viewModelStore &#x3D;&#x3D; null的分支</p>
</li>
<li><p><code>「G3」</code>这里创建了<code>[C]ComponentActivity.NonConfigurationInstances</code>存入 custom和viewModelStore并返回。</p>
</li>
<li><p><code>「D2」</code>⬅️<code>「C2」</code>执行LaunchActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.app.ActivityThread#handleLaunchActivity</span></span><br><span class="line">    <span class="keyword">public</span> Activity <span class="title function_">handleLaunchActivity</span><span class="params">(ActivityClientRecord r,</span></span><br><span class="line"><span class="params">            PendingTransactionActions pendingActions, Intent customIntent)</span> &#123;</span><br><span class="line">        ....</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Activity</span> <span class="variable">a</span> <span class="operator">=</span> performLaunchActivity(r, customIntent);</span><br><span class="line">        ....</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.app.ActivityThread#performLaunchActivity</span></span><br><span class="line">    <span class="keyword">private</span> Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">        ....</span><br><span class="line">        Activity activity = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">      「H1」 activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">            ....</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ....</span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">                ....</span><br><span class="line">        「H2」   activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                        r.referrer, r.voiceInteractor, window, r.activityConfigCallback,</span><br><span class="line">                        r.assistToken, r.shareableActivityToken);</span><br><span class="line">        ....</span><br><span class="line">        <span class="keyword">return</span> activity;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>「H1」</code></p>
<p>实例化一个Activity</p>
</li>
<li><p><code>「H2」</code></p>
<p>使用原来的ActivityRecord给Activity设置参数，其中第12个参数就是在<code>「E2」</code>处保存的lastNonConfigurationInstances，其中就有viewModel</p>
<p>这里就回答了上面<code>[U2]</code>处的问题，串起来了</p>
</li>
</ul>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p>code</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6976025197333708837" title="Android 面试总结 - ViewModel 是怎么保存和恢复？ - 掘金 (juejin.cn)">Android 面试总结 - ViewModel 是怎么保存和恢复？ - 掘金 (juejin.cn)</a></li>
<li><a target="_blank" rel="noopener" href="https://pomelojiang.github.io/android_framework_start_activity_1" title="Android Framework之Activity启动流程(一) | 柚子 | pomeloJiang">Android Framework之Activity启动流程(一) | 柚子 | pomeloJiang</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904179299778567" title="Zygote的启动流程 - 掘金 (juejin.cn)">Zygote的启动流程 - 掘金 (juejin.cn)</a></li>
<li><a target="_blank" rel="noopener" href="https://benzblog.site/2017-06-19-all-about-rotations/" title="Android屏幕旋转源码探索及应用实践 | 奔哲明的博客 (benzblog.site)">Android屏幕旋转源码探索及应用实践 | 奔哲明的博客 (benzblog.site)</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903869814669319" title="Configuration 变更时Activity的生命周期探究 - 掘金 (juejin.cn)">Configuration 变更时Activity的生命周期探究 - 掘金 (juejin.cn)</a></li>
</ul>

</article>

<div id="paginator">
  
</div>

      </div>
    </div>

  </div>

  <!-- 底部信息 -->
  <div id="bottom-outer">
    <div id="bottom-inner">
      Site by John Doe using
      <a target="_blank" rel="noopener" href="http://hexo.io">hexo blog framework</a>.
      <br>
      <a href="/">Home</a>
    </div>
  </div>


  
  <!-- scripts list from theme config.yml -->
  
  <script src="/lib/highlight/highlight.pack.js"></script>
  
  <script src="/lib/jquery-3.4.1.min.js"></script>
  
  <script src="/lib/jquery.pjax.js"></script>
  
  <script src="/js/again.js"></script>
  
  


  <!-- 高亮脚本启动 -->
  <script>hljs.initHighlightingOnLoad();</script>

    <!-- 如果设置中mermaid选项打开 -->
    
    <!-- 引入mermaid脚本 -->
    <div class=".pjax-reload">
      <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
    </div>
    <!-- mermaid启动 -->
    <script>
      if (window.mermaid) {
        mermaid.initialize({ theme: 'dark' });
      }
    </script>
    

</body>

</html>