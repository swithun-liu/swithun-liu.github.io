

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>ViewModelé…ç½®å˜æ›´åä»ç„¶å­˜åœ¨åŸç† [ Swithun Blog ]</title>

  
  <!-- stylesheets list from _config.yml -->
  
  <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css">
  
  <link rel="stylesheet" href="/lib/highlight-11-9-0/src/styles/atom-one-dark.css">
  
  <link rel="stylesheet" href="/css/again.css">
  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>

  <!-- menu -->
  <div id="menu-outer">
    <div id="menu-inner">
      
      <a class="menu-button" href="/">Home</a>
      
      <a class="menu-button" href="/about">About</a>
      
      <a class="menu-button" href="/contact">Contact</a>
      
      <a class="menu-button" href="/archives">Archives</a>
      
      <a class="menu-button" href="/categories">Category</a>
      
    </div>
  </div>

  <!-- ä¸­é—´ä¸»ä½“ -->
  <div id="main">
    <!-- ä¾§è¾¹æ  -->
    <div id="aside-outer">
      <aside>
        <!-- æœç´¢æ  -->
<div id="search">
    <input class="search-input" type="text" placeholder="search">
    <i id="search-icon" class="fa fa-bars" title="åˆ‡æ¢ç›®å½•ä¸ç´¢å¼•"></i>
</div>

<!-- ä¾§è¾¹ç›®å½•æ  -->
<div id="tree">
    

    

                <!--å¦‚æœæ˜¯æ–‡ä»¶å¤¹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            Android
                        </a>
                        
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2023/10/18/Android/FragmentåŸç†/">
                            <i class="fa fa-file"></i>
                            FragmentåŸç†
                        </a>
                    </li>
                </ul>

              
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file active">
                        <a href="/2023/10/10/Android/viewmodelåŸç†/">
                            <i class="fa fa-file"></i>
                            viewmodelåŸç†
                        </a>
                    </li>
                </ul>

              
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2024/03/03/Android/viewç»˜åˆ¶åŸç†/">
                            <i class="fa fa-file"></i>
                            viewç»˜åˆ¶åŸç†
                        </a>
                    </li>
                </ul>

              
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2024/03/09/Android/è‡ªå®šä¹‰Viewå®ç°æ‹–æ‹½å±•å¼€é¢æ¿/">
                            <i class="fa fa-file"></i>
                            è‡ªå®šä¹‰Viewå®ç°æ‹–æ‹½å±•å¼€é¢æ¿
                        </a>
                    </li>
                </ul>

              
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2024/03/10/Android/Androidçª—å£æœºåˆ¶/">
                            <i class="fa fa-file"></i>
                            Androidçª—å£æœºåˆ¶
                        </a>
                    </li>
                </ul>

              
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2024/05/12/Android/NestedScrollingåŸç†/">
                            <i class="fa fa-file"></i>
                            NestedScrollingåŸç†
                        </a>
                    </li>
                </ul>

              
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2024/05/25/Android/è‡ªå·±å®ç°ä¸€ä¸ªNestedScrollView/">
                            <i class="fa fa-file"></i>
                            è‡ªå·±å®ç°ä¸€ä¸ªNestedScrollView
                        </a>
                    </li>
                </ul>

              
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2024/06/02/Android/EditTextå…‰æ ‡å®šä½åŸç†/">
                            <i class="fa fa-file"></i>
                            EditTextå…‰æ ‡å®šä½åŸç†
                        </a>
                    </li>
                </ul>

              
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2024/06/02/Android/ä¸€æ­¥æ­¥è§£å†³NestedScrollViewåµŒå¥—EditTextçš„å†²çª/">
                            <i class="fa fa-file"></i>
                            ä¸€æ­¥æ­¥è§£å†³NestedScrollViewåµŒå¥—EditTextçš„å†²çª
                        </a>
                    </li>
                </ul>

              
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2024/06/11/Android/DialogåŸç†/">
                            <i class="fa fa-file"></i>
                            DialogåŸç†
                        </a>
                    </li>
                </ul>

              
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2024/07/20/Android/ä»0å®ç°ä¸€ä¸ªBottomSheetDialog/">
                            <i class="fa fa-file"></i>
                            ä»0å®ç°ä¸€ä¸ªBottomSheetDialog
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--å¦‚æœæ˜¯æ–‡ä»¶å¤¹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            ä¸»é¢˜æ¼”ç¤º
                        </a>
                        
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/ä¸»é¢˜æ¼”ç¤º/demo1/">
                            <i class="fa fa-file"></i>
                            demo1
                        </a>
                    </li>
                </ul>

              
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2023/10/22/ä¸»é¢˜æ¼”ç¤º/temp/">
                            <i class="fa fa-file"></i>
                            temp
                        </a>
                    </li>
                </ul>

              

                <!--å¦‚æœæ˜¯æ–‡ä»¶å¤¹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            demo_folder_level2
                        </a>
                        
                <!--å¦‚æœæ˜¯æ–‡ç« -->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/ä¸»é¢˜æ¼”ç¤º/demo_folder_level2/demo2/">
                            <i class="fa fa-file"></i>
                            demo2
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 
</div>

<div id="toc" style="display: none;"></div>
      </aside>
    </div>
    <!-- æ–‡ç« å†…å®¹ -->
    <div id="content-outer">
      <div id="content-inner">
        
<article id="post">
  <h1>ViewModelé…ç½®å˜æ›´åä»ç„¶å­˜åœ¨åŸç†</h1>
  <h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul>
<li><a href="##Activity%E5%88%9B%E5%BB%BAViewModel">Activityåˆ›å»ºViewModel</a></li>
<li><a href="##Activity%E9%87%8D%E5%BB%BAViewModel%E4%BF%9D%E6%8C%81%E5%AD%98%E5%9C%A8%E7%9A%84%E5%AE%9E%E7%8E%B0">Activityé‡å»ºViewModelä¿æŒå­˜åœ¨çš„å®ç°</a><ul>
<li><a href="###relaunch%E4%B9%8B%E5%90%8E%E6%96%B0%E7%9A%84Activity%E8%8E%B7%E5%8F%96%E4%B9%8B%E5%89%8D%E7%9A%84viewModel">relaunchä¹‹åæ–°çš„Activityè·å–ä¹‹å‰çš„viewModel</a></li>
<li><a href="###relaunch%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BF%9D%E5%AD%98%E6%97%A7Activity%E7%9A%84viewModel">relaunchè¿‡ç¨‹ä¸­ä¿å­˜æ—§Activityçš„viewModel</a></li>
</ul>
</li>
<li><a href="##reference">reference</a></li>
</ul>
<blockquote>
<p>2022&#x2F;08&#x2F;21</p>
</blockquote>
<h2 id="Activityåˆ›å»ºViewModel"><a href="#Activityåˆ›å»ºViewModel" class="headerlink" title="Activityåˆ›å»ºViewModel"></a>Activityåˆ›å»ºViewModel</h2><ul>
<li><p>åˆ›å»ºViewModel</p>
<pre><code class="kotlin">// MyActivity#onCreate()

val mainViewModel = 
            [V1]   ViewModelProvider(this)
              [V2]       .get(MainViewModel::class.java)
</code></pre>
</li>
<li><p><code>[V1]</code></p>
<p>ViewModelProvideræ„é€ å‡½æ•°</p>
<pre><code class="kotlin">// androidx.lifecycle.ViewModelProvider#get(java.lang.Class&lt;T&gt;)
    public constructor(
        owner: ViewModelStoreOwner
    ) : this(owner.viewModelStore, defaultFactory(owner), defaultCreationExtras(owner))
</code></pre>
<p>thisæŒ‡MyActivityï¼Œå³MyActivityåº”è¯¥æ˜¯<code>[I]ViewModelStoreOwner</code>ç±»å‹</p>
<p>MyActivityç»§æ‰¿<code>[C]ComponentActivity]</code>ï¼ŒComponentActivityå®ç°äº†<code>[I]ViewModelStoreOwner</code>æ¥å£</p>
<pre><code class="java">// CompnentActivity
public class ComponentActivity extends androidx.core.app.ComponentActivity implements
        // ...
        ViewModelStoreOwner,
        // ... &#123;
</code></pre>
<p><code>this(owner.viewModelStore, defaultFactory(owner), defaultCreationExtras(owner))</code> ï¼Œè¿™é‡Œä½¿ç”¨ <code>owner.viewModelStore</code>ä»ViewModelStoreOwnerä¸­å–å‡º<code>[OC]ViewModelStore]</code></p>
<pre><code class="kotlin">// ViewModelStoreOwner
interface ViewModelStoreOwner &#123;

    /**
     * The owned [ViewModelStore]
     */
    val viewModelStore: ViewModelStore
&#125;
</code></pre>
<p>ç„¶åè°ƒç”¨ä¸‹é¢çš„æ„é€ å‡½æ•°</p>
<pre><code class="kotlin">// ViewModelStoreOwner

/**
 * Creates a ViewModelProvider
 *
 * @param store `ViewModelStore` where ViewModels will be stored.
 * @param factory factory a `Factory` which will be used to instantiate new `ViewModels`
 * @param defaultCreationExtras extras to pass to a factory
 */
@JvmOverloads
constructor(
    private val store: ViewModelStore,
    private val factory: Factory,
    private val defaultCreationExtras: CreationExtras = CreationExtras.Empty,
) &#123;
</code></pre>
</li>
<li><p><code>[V2]</code></p>
<p>è°ƒç”¨äº†getæ–¹æ³•â¬‡ï¸</p>
<pre><code class="kotlin">// androidx.lifecycle.ViewModelProvider#get(java.lang.Class&lt;T&gt;)
    @MainThread
    public open operator fun &lt;T : ViewModel&gt; get(modelClass: Class&lt;T&gt;): T &#123;
        val canonicalName = modelClass.canonicalName
            ?: throw IllegalArgumentException(&quot;Local and anonymous classes can not be ViewModels&quot;)
   [W1]  return get(&quot;$DEFAULT_KEY:$canonicalName&quot;, modelClass)
    &#125;
</code></pre>
</li>
<li><p><code>[W1]</code></p>
<pre><code class="kotlin">// androidx.lifecycle.ViewModelProvider#get(java.lang.String, java.lang.Class&lt;T&gt;)
    @MainThread
    public open operator fun &lt;T : ViewModel&gt; get(key: String, modelClass: Class&lt;T&gt;): T &#123;
    [X1]val viewModel = store[key]
    [X1]if (modelClass.isInstance(viewModel)) &#123;
            ....
    [X1]    return viewModel as T
        ....
    [X2]return try &#123;
    [X2]     factory.create(modelClass, extras)
    [X2] catch (e: AbstractMethodError) &#123;
    [X2]    factory.create(modelClass)
    [X2]&#125;.also &#123; store.put(key, it) &#125;
    &#125;
</code></pre>
</li>
<li><p><code>[X1]</code>â¬…ï¸<code>[W1]</code></p>
<p>ä»store(<code>[OC]ViewModelStore</code>)ä¸­èƒ½æ‰¾åˆ°viewmodelåˆ™ç›´æ¥è¿”å›</p>
</li>
<li><p><code>[X2]</code>â¬…ï¸<code>[W1]</code></p>
<p>storeä¸­æ‰¾ä¸åˆ°åˆ™éœ€è¦æ–°åˆ›å»ºä¸€ä¸ªviewmodelå¹¶æ”¾å…¥storeï¼Œè¿™é‡Œè¯´æ˜åªè¦ä½¿ç”¨åŒä¸€ä¸ªViewModelStoreè·å–ViewModelåˆ™ä¸åŒåœ°æ–¹è·å–åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªViewModel</p>
<p><code>[OC]ViewModelStore</code>çœ‹èµ·æ¥æ˜¯ä¸ªMapï¼Œäº‹å®ä¸Šä»–çš„å®ç°å°±æ˜¯ç»´æŠ¤ä¸€ä¸ªmapï¼Œæ”¾å‡ºgetå’Œputæ–¹æ³•</p>
<pre><code class="kotlin">open class ViewModelStore &#123;

    private val map = mutableMapOf&lt;String, ViewModel&gt;()
    ...

    fun put(key: String, viewModel: ViewModel) &#123;
    &#125;

    operator fun get(key: String): ViewModel? &#123;
        return map[key]
    &#125;
    ...
&#125;
</code></pre>
</li>
</ul>
<p>æ€»ç»“ä¸Šé¢ï¼ŒActivityåœ¨onCreateæ—¶åˆ›å»ºviewModelï¼ŒActivityæ˜¯ä¸€ä¸ªViewModelStoreOwnerå…¶ä¸­æœ‰ä¸€ä¸ªViewModelStoreå…¶ä¸­ç»´æŠ¤ä¸€ä¸ªmapï¼ŒViewModelProvierä½œä¸ºä¸€ä¸ªå·¥å…·ç±»åœ¨ä½¿ç”¨é»˜è®¤çš„&#x2F;æˆ‘ä»¬æä¾›çš„Factoryï¼ˆä¸ºäº†é€‚é…æ„é€ å‡½æ•°æœ‰å‚çš„ViewModelï¼‰åˆ›å»ºViewModelçš„åŒæ—¶ä¼šå°†å…¶å­˜å…¥è¿™ä¸ªmapã€‚</p>
<p>æ‰€ä»¥ï¼Œåœ¨relaunchè¿‡ç¨‹ä¸­ï¼Œé”€æ¯æ—§çš„Activityæ—¶å¦‚æœèƒ½ä¿å­˜å®ƒçš„mViewModelStoreï¼Œç„¶åå°†å…¶èµ‹å€¼æ–°çš„Activityçš„mViewModelStoreå°±èƒ½å®ç°é…ç½®å˜æ›´viewModelä¸å˜æ›´çš„æ•ˆæœã€‚</p>
<h2 id="Activityé‡å»ºViewModelä¿æŒå­˜åœ¨çš„å®ç°"><a href="#Activityé‡å»ºViewModelä¿æŒå­˜åœ¨çš„å®ç°" class="headerlink" title="Activityé‡å»ºViewModelä¿æŒå­˜åœ¨çš„å®ç°"></a>Activityé‡å»ºViewModelä¿æŒå­˜åœ¨çš„å®ç°</h2><h3 id="relaunchä¹‹åæ–°çš„Activityè·å–ä¹‹å‰çš„viewModel"><a href="#relaunchä¹‹åæ–°çš„Activityè·å–ä¹‹å‰çš„viewModel" class="headerlink" title="relaunchä¹‹åæ–°çš„Activityè·å–ä¹‹å‰çš„viewModel"></a>relaunchä¹‹åæ–°çš„Activityè·å–ä¹‹å‰çš„viewModel</h3><p>viewModelå­˜åœ¨ViewModelStoreä¸­ï¼Œè¯´æ˜ViewModelStoreåœ¨Activityé‡å»ºçš„è¿‡ç¨‹ä¸­èƒ½ä¿æŒå­˜åœ¨ï¼Œçœ‹ä¸‹<code>[C]ComponentActivity</code>å¦‚ä½•å¦‚ä½•è·å–<code>[OC]ViewModelStore</code>çš„</p>
<pre><code class="kotlin">    public ViewModelStore getViewModelStore() &#123;
        if (getApplication() == null) &#123;
            throw new IllegalStateException(&quot;Your activity is not yet attached to the &quot;
                    + &quot;Application instance. You can&#39;t request ViewModel before onCreate call.&quot;);
        &#125;
   [T1] ensureViewModelStore();
        return mViewModelStore;
    &#125;


</code></pre>
<ul>
<li><p><code>[T1]</code></p>
<p>åœ¨getViewModelStore()æ–¹æ³•ä¸­è°ƒç”¨äº†ensureViewModelStore()ç¡®ä¿mViewModelStoreä¸ä¸ºç©º</p>
<pre><code class="kotlin">    @SuppressWarnings(&quot;WeakerAccess&quot;) /* synthetic access */
    void ensureViewModelStore() &#123;
        if (mViewModelStore == null) &#123;
        [U1] NonConfigurationInstances nc =
                    (NonConfigurationInstances) getLastNonConfigurationInstance();
            if (nc != null) &#123;
                // Restore the ViewModelStore from NonConfigurationInstances
        [U2]    mViewModelStore = nc.viewModelStore;
            &#125;
            if (mViewModelStore == null) &#123;
                mViewModelStore = new ViewModelStore();
            &#125;
        &#125;
    &#125;
</code></pre>
</li>
<li><p><code>[U1]</code>â¬…ï¸<code>[T1]</code></p>
<pre><code class="kotlin">// Activity

    @Nullable
    public Object getLastNonConfigurationInstance() &#123;
        return mLastNonConfigurationInstances != null
                ? mLastNonConfigurationInstances.activity : null;
    &#125;
</code></pre>
<p>Activirty.mLastNonConfigurationInstancesç±»å‹ä¸º<code>[C]Activity.NonConfigurationInstances</code></p>
<pre><code class="java">// android.app.Activity.NonConfigurationInstances
    static final class NonConfigurationInstances &#123;
        Object activity;
        ....
    &#125;
</code></pre>
<p>mLastNonConfigurationInstances.activityåœ¨<code>[U1]</code>å¤„è¢«å¼ºè½¬ä¸º<code>[C]ComponentActivity.NonConfigurationInstances</code></p>
<pre><code class="kotlin">// androidx.activity.ComponentActivity.NonConfigurationInstances
    static final class NonConfigurationInstances &#123;
        Object custom;
        ViewModelStore viewModelStore;
    &#125;
</code></pre>
</li>
<li><p><code>[U2]</code>â¬…ï¸<code>[T1]</code></p>
<p>å¦‚æœ<code>[U1]</code>è·å–çš„ncä¸ä¸ºç©ºï¼Œåˆ™å°†mViewModelStoreèµ‹å€¼ä¸ºnc.viewModelStore å³Activity.mLastNonConfigurationInstances.activity.viewModelStore</p>
<p>æ‰€ä»¥æƒ³è¦ä¿å­˜ç»™æ–°Activityä½¿ç”¨åŸæ¥çš„viewModelï¼Œé‡ç‚¹å°±æ˜¯è¦åœ¨relaunchè¿‡ç¨‹ä¸­ä¿å­˜æ—§çš„Activity.mLastNonConfigurationInstancesç„¶åå†èµ‹å€¼ç»™æ–°Activity.mLastNonConfigurationInstances</p>
</li>
</ul>
<h3 id="relaunchè¿‡ç¨‹ä¸­ä¿å­˜æ—§Activityçš„viewModel"><a href="#relaunchè¿‡ç¨‹ä¸­ä¿å­˜æ—§Activityçš„viewModel" class="headerlink" title="relaunchè¿‡ç¨‹ä¸­ä¿å­˜æ—§Activityçš„viewModel"></a>relaunchè¿‡ç¨‹ä¸­ä¿å­˜æ—§Activityçš„viewModel</h3><p>è®¾å¤‡å˜æ›´ï¼Œç³»ç»Ÿè°ƒç”¨AMSçš„updateConfiguration æ–¹æ³•</p>
<p><a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java;l=462?q=ActivityManagerService&sq=&ss=android/platform/superproject" title="ActivityManagerService.java - Android Code Search">ActivityManagerService.java - Android Code Search</a></p>
<pre><code class="java">// ActivityManagerService
    @Override
    public boolean updateConfiguration(Configuration values) &#123;
        return mActivityTaskManager.updateConfiguration(values);
    &#125;
</code></pre>
<pre><code class="java">// ActivityTaskManagerService
    @Override
    public boolean updateConfiguration(Configuration values) &#123;
           ....
                updateConfigurationLocked(values, null, false, false /* persistent */,
           ....
    &#125;
</code></pre>
<pre><code class="java">// ActivityTaskManagerService
    boolean updateConfigurationLocked(Configuration values, ActivityRecord starting,
            boolean initLocale, boolean persistent, int userId, boolean deferResume,
            ActivityTaskManagerService.UpdateConfigurationResult result) &#123;
            ....
            ã€ŒI1ã€  changes = updateGlobalConfigurationLocked(values, initLocale, persistent, userId);
            ....
            ã€ŒI2ã€ kept = ensureConfigAndVisibilityAfterUpdate(starting, changes);
            ....
    &#125;
</code></pre>
<ul>
<li><p><code>ã€ŒI1ã€</code></p>
<p>updateGlobalConfigurationLocked æ›´æ–°å½“å‰é…ç½®ä¿¡æ¯</p>
</li>
<li><p><code>ã€ŒI2ã€</code></p>
<p>ensureConfigAndVisibilityAfterUpdate ç¡®ä¿ç»™å®šçš„activityæ›´æ–°ä½¿ç”¨çš„é…ç½®</p>
<p>è¿™é‡Œstartingä¼ å…¥çš„æ˜¯nullï¼Œéœ€è¦ensureConfigAndVisibilityAfterUpdateä¸­è‡ªå·±è·å–</p>
<pre><code class="kotlin">// ActivityTaskManagerService
    boolean ensureConfigAndVisibilityAfterUpdate(ActivityRecord starting, int changes) &#123;
        boolean kept = true;
     ã€ŒJ1ã€   final Task mainRootTask = mRootWindowContainer.getTopDisplayFocusedRootTask();
        ....
             ã€ŒJ2ã€ starting = mainRootTask.topRunningActivity();
        ....
             ã€ŒJ3ã€ kept = starting.ensureActivityConfiguration(changes,
        ....
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒJ1ã€</code>â¬…ï¸<code>ã€ŒI2ã€</code></p>
<p>è·å–æ ¹çª—å£å®¹å™¨ä¸­å½“å‰å…·æœ‰ç„¦ç‚¹çš„é¡¶çº§ä»»åŠ¡ï¼ˆroot taskï¼‰</p>
</li>
<li><p><code>ã€ŒJ2ã€</code>â¬…ï¸<code>ã€ŒI2ã€</code></p>
<p>è·å–é¡¶çº§ä»»åŠ¡ï¼ˆroot taskï¼‰ä¸­å½“å‰æ­£åœ¨è¿è¡Œçš„é¡¶çº§Activityï¼ˆtop running Activityï¼‰çš„ActivityRecordèµ‹å€¼ç»™starting</p>
</li>
<li><p><code>ã€ŒJ3ã€</code>â¬…ï¸<code>ã€ŒI2ã€</code></p>
<p>ActivityRecordå¯¹åº”çš„Activityæ›´æ–°Configuration</p>
<pre><code class="kotlin">// com.android.server.wm.ActivityRecord#ensureActivityConfiguration(int, boolean)
    boolean ensureActivityConfiguration(int globalChanges, boolean preserveWindow) &#123;
        return ensureActivityConfiguration(globalChanges, preserveWindow,
                false /* ignoreVisibility */);
    &#125;
</code></pre>
<pre><code class="java">// com.android.server.wm.ActivityRecord#ensureActivityConfiguration(int, boolean, boolean)
    boolean ensureActivityConfiguration(int globalChanges, boolean preserveWindow,
            boolean ignoreVisibility) &#123;
            ....
                relaunchActivityLocked(preserveWindow);
            ....
    &#125;
</code></pre>
<pre><code class="java"> // com.android.server.wm.ActivityRecord#relaunchActivityLocked
    void relaunchActivityLocked(boolean preserveWindow) &#123;
            ....
       ã€ŒK2ã€  final ClientTransactionItem callbackItem = ActivityRelaunchItem.obtain(pendingResults,
            ....
       ã€ŒK1ã€  final ClientTransaction transaction = ClientTransaction.obtain(app.getThread(), token);
       ã€ŒK2ã€  transaction.addCallback(callbackItem);
            ....
       ã€ŒK3ã€  mAtmService.getLifecycleManager().scheduleTransaction(transaction);
            ....
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒK1ã€</code>â¬…ï¸<code>ã€ŒJ3ã€</code></p>
<p>tokenæ¥è‡ª<code>[C]ActivityRecord</code>ç»§æ‰¿çš„<code>[C]WindowToken</code>ä¸­çš„token</p>
<pre><code class="kotlin">class WindowToken extends WindowContainer&lt;WindowState&gt; &#123;
    private static final String TAG = TAG_WITH_CLASS_NAME ? &quot;WindowToken&quot; : TAG_WM;

    /** The actual token */
    final IBinder token;

    /** The type of window this token is for, as per &#123;@link WindowManager.LayoutParams&#125; */
    final int windowType;
</code></pre>
<pre><code class="kotlin"> // ClientTransaction
    /** Obtain an instance initialized with provided params. */
    public static ClientTransaction obtain(IApplicationThread client, IBinder activityToken) &#123;
        ClientTransaction instance = ObjectPool.obtain(ClientTransaction.class);
        if (instance == null) &#123;
            instance = new ClientTransaction();
        &#125;
        instance.mClient = client;
        instance.mActivityToken = activityToken;

        return instance;
    &#125;
</code></pre>
<p>å°†transaction.mActivityTokenè®¾ç½®ä¸ºActivityRecord.token</p>
</li>
<li><p><code>ã€ŒK2ã€</code>â¬…ï¸<code>ã€ŒJ3ã€</code></p>
<p>ç»™transactionæ”¾å…¥callbackï¼š<code>[C]ActivityRelaunchItem</code></p>
</li>
<li><p><code>ã€ŒK3ã€</code>â¬…ï¸<code>ã€ŒJ3ã€</code></p>
<p>æ‰§è¡Œtransaction</p>
<pre><code class="java">// com.android.server.wm.ClientLifecycleManager#scheduleTransaction(ClientTransaction)
    void scheduleTransaction(ClientTransaction transaction) throws RemoteException &#123;
        ....
        transaction.schedule();
        ....
    &#125;
</code></pre>
<pre><code class="kotlin">// ClientTransaction
    public void schedule() throws RemoteException &#123;
   ã€ŒL1ã€  mClient.scheduleTransaction(this);
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒL1ã€</code>â¬…ï¸<code>ã€ŒK3ã€</code></p>
<p><code>[C]ClientTransaction</code>ä½¿ç”¨mClientæ‰§è¡Œè‡ªå·±</p>
<ul>
<li>mClientæ˜¯ä»€ä¹ˆ?&#x20;<pre><code class="kotlin">// ClientTransaction
    /** Target client. */
    private IApplicationThread mClient;
</code></pre>
è¿™é‡Œæ˜¯ä½¿ç”¨AIDL(åŸºäºBinder)è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ï¼Œå¯¹åº”æ–‡ä»¶<code>IApplicationThread.aidl</code>â¬‡ï¸<pre><code class="kotlin">oneway interface IApplicationThread &#123;
    ....
    void scheduleTransaction(in ClientTransaction transaction);
</code></pre>
è¿™é‡ŒmClientæ˜¯å®¢æˆ·ç«¯ï¼Œå¯¹åº”çš„å®¢æˆ·ç«¯ä¸º<code>[c]ApplicationThread</code><pre><code class="kotlin">    private class ApplicationThread extends IApplicationThread.Stub &#123;
</code></pre>
</li>
</ul>
</li>
<li><p><code>ã€ŒM1ã€</code>â¬…ï¸<code>ã€ŒL1ã€</code></p>
<p>æ‰€ä»¥ä¸‹é¢ä» android.app.ActivityThread.ApplicationThread#scheduleTransactionæ–¹æ³•ç»§ç»­</p>
<pre><code class="kotlin">// android.app.ActivityThread.ApplicationThread#scheduleTransaction
        @Override
        public void scheduleTransaction(ClientTransaction transaction) throws RemoteException &#123;
            ActivityThread.this.scheduleTransaction(transaction);
        &#125;
</code></pre>
<p>è¿™é‡ŒscheduleTransactionæ˜¯è°ƒç”¨çš„ActivityThreadçš„åŸºç±»ClientTransactonHandlerä¸­çš„scheduleTransactionæ–¹æ³•</p>
<pre><code class="kotlin">// android.app.ClientTransactionHandler#scheduleTransaction
    void scheduleTransaction(ClientTransaction transaction) &#123;
 ã€ŒN1ã€  transaction.preExecute(this);
 ã€ŒN2ã€  sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒN1ã€</code>â¬…ï¸<code>ã€ŒM1ã€</code></p>
<p>ä¸ºåé¢transactionçš„æ‰§è¡Œåšäº›å‡†å¤‡ï¼Œè¿™é‡Œthisä¼ å…¥çš„æ˜¯<code>[C]ActivityThread</code></p>
<pre><code class="java">    public void preExecute(android.app.ClientTransactionHandler clientTransactionHandler) &#123;
        if (mActivityCallbacks != null) &#123;
            ....
            for (int i = 0; i &lt; size; ++i) &#123;
            ã€ŒO1ã€  mActivityCallbacks.get(i).preExecute(clientTransactionHandler, mActivityToken);
            ....
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒO1ã€</code>â¬…ï¸<code>ã€ŒN1ã€</code></p>
<p>æ‰§è¡Œæ¯ä¸ªcallbackçš„preExecuteæ–¹æ³•ï¼Œcallbackåªæœ‰ä¸€ä¸ªä¹‹å‰åœ¨<code>ã€ŒK2ã€</code>å¤„æ”¾å…¥çš„ActivityRelaunchItem</p>
<pre><code class="java"> // android.app.servertransaction.ActivityRelaunchItem#preExecute
    public void preExecute(ClientTransactionHandler client, IBinder token) &#123;
    ã€ŒP1ã€ mActivityClientRecord = client.prepareRelaunchActivity(token, mPendingResults,
                mPendingNewIntents, mConfigChanges, mConfig, mPreserveWindow);
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒP1ã€</code>â¬…ï¸ <code>ã€ŒO1ã€</code></p>
<p>ä»ActivityThread(å³client)è·å–è¦relaunchçš„ActivityRecordå­˜å…¥ActivityRelaunchItem.mActivityClientRecord</p>
<pre><code class="java">    @Override
    public ActivityClientRecord prepareRelaunchActivity(IBinder token,
            List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,
            int configChanges, MergedConfiguration config, boolean preserveWindow) &#123;
    ã€ŒQ1ã€     ....

    ã€ŒQ2ã€     target = new ActivityClientRecord();
    ã€ŒQ2ã€     target.token = token;
                ....
    ã€ŒQ3ã€     mRelaunchingActivities.add(target);
                ....

        return ....target....;
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒQ1ã€</code>â¬…ï¸<code>ã€ŒP1ã€</code></p>
<p>æ£€æŸ¥æ˜¯å¦ç›®æ ‡activityæ˜¯å¦å·²ç»æ­£åœ¨relaunchäº†ï¼Œå¦‚æœæ˜¯åˆ™è¿”å›</p>
</li>
<li><p><code>ã€ŒQ2ã€</code>â¬…ï¸<code>ã€ŒP1ã€</code></p>
<p>ç›®æ ‡activityæ²¡æœ‰å·²ç»æ­£åœ¨relaunchï¼ˆè¿™é‡Œè®¤ä¸ºæ˜¯æ²¡æœ‰ï¼Œè¿™ä¸ªåˆ¤æ–­åªæ˜¯ä¸ºäº†é˜²æ­¢relaunchæ­£åœ¨relaunchçš„activityï¼‰ï¼Œåˆ™æ„é€ ä¸€ä¸ª<code>[sC]ActivityClientRecord</code>è®°å½•è¦relaunchçš„Activityçš„tokenç­‰ä¿¡æ¯</p>
</li>
<li><p><code>ã€ŒQ3ã€</code>â¬…ï¸<code>ã€ŒP1ã€</code>ä½¿ç”¨ActivityThread.mRelaunchingActivitiesè®°å½•æ‰€æœ‰è¦å‡†å¤‡é‡å¯çš„ActivityClientRecord</p>
<pre><code class="text">+-----------------------------------------------------+
|                                                     |
|                 ActivityThread                      |
|                                                     |
|       +-----------------------------------+         |
|       |    mRelaunchingActivities         |         |
|       |                                   |         |
|       |   +------------------------+      |         |
|       |   | ActivityClientRecord   |      |         |
|       |   +------------------------+      |         |
|       |                                   |         |
|       |   +------------------------+      |         |
|       |   | ActivityClientRecord   |      |         |
|       |   +------------------------+      |         |
|       |                                   |         |
|       |           ....                    |         |
|       |                                   |         |
|       |                                   |         |
|       +-----------------------------------+         |
|                                                     |
+-----------------------------------------------------+
</code></pre>
</li>
<li><p><code>ã€ŒN2ã€</code>â¬…ï¸<code>ã€ŒM1ã€</code></p>
<p>è¿™é‡Œä½¿ç”¨Handlerå»çœŸæ­£æ‰§è¡Œtransactionï¼Œobjä¼ å…¥çš„å°±æ˜¯transaction</p>
<pre><code class="java">// android.app.ClientTransactionHandler#sendMessage
    abstract void sendMessage(int what, Object obj);
</code></pre>
<pre><code class="java">// android.app.ActivityThread#sendMessage(int, java.lang.Object)
    void sendMessage(int what, Object obj) &#123;
        sendMessage(what, obj, 0, 0, false);
    &#125;
</code></pre>
<p>â¬‡ï¸æ„é€ Message</p>
<pre><code class="java">// android.app.ActivityThread#sendMessage(int, java.lang.Object, int, int, boolean)
    private void sendMessage(int what, Object obj, int arg1, int arg2, boolean async) &#123;
        ....
        msg.what = what;
        msg.obj = obj;
        ....
        mH.sendMessage(msg);
    &#125;
</code></pre>
<p>â¬‡ï¸handlerï¼šActivityThread.H æ”¶åˆ°æ¶ˆæ¯å¹¶å¤„ç†</p>
<pre><code class="java">// android.app.ActivityThread.H#handleMessage
        public void handleMessage(Message msg) &#123;
            ...
             switch (msg.what) &#123;
                ...
                case EXECUTE_TRANSACTION:
              ã€ŒR1ã€  final ClientTransaction transaction = (ClientTransaction) msg.obj;
              ã€ŒR2ã€  mTransactionExecutor.execute(transaction);
                    ....

</code></pre>
</li>
<li><p><code>ã€ŒR1ã€</code>â¬…ï¸<code>ã€ŒN2ã€</code>ä»messageä¸­å–å‡ºtransaction</p>
</li>
<li><p><code>ã€ŒR2ã€</code>â¬…ï¸<code>ã€ŒN2ã€</code>äº¤ç»™mTransactionExecutoræ‰§è¡Œ</p>
<p>mTransactionHandler æ˜¯è°ï¼Ÿæ˜¯<code>[C]ActivityThread</code>ï¼Œä»TransactionExecutorçš„æ„é€ å‡½æ•°â¬‡ï¸ä¸­å¯ä»¥çœ‹å‡º</p>
<pre><code class="kotlin">// ActivityThread
    private final TransactionExecutor mTransactionExecutor = new TransactionExecutor(this);
</code></pre>
<pre><code class="kotlin">    /** Initialize an instance with transaction handler, that will execute all requested actions. */
    public TransactionExecutor(ClientTransactionHandler clientTransactionHandler) &#123;
        mTransactionHandler = clientTransactionHandler;
    &#125;
</code></pre>
<p>TransactionExecutor.mTransactionHandleræ˜¯å¯¹æŒæœ‰è¯¥TransactionExecutorçš„ActivityThreadçš„å¼•ç”¨</p>
<pre><code class="text">+-------------------------------------------------------------------------------------+
|                                    ActivityThread &lt;-------+                         |
|                                                           |                         |
|                                                           |                         |
|      +-----------------------------------------------------------------+            |
|      |  mTransactionExecutor: TransactionExecutor         |            |            |
|      |                                                    |            |            |
|      |                                                    |            |            |
|      |  +-------------------------------------------------+---------+  |            |
|      |  |   mTransactionHandler: ClientTransactionHandler           |  |            |
|      |  |                                                           |  |            |
|      |  |                                                           |  |            |
|      |  +-----------------------------------------------------------+  |            |
|      |                                                                 |            |
|      |                                                                 |            |
|      +-----------------------------------------------------------------+            |
|                                                                                     |
+-------------------------------------------------------------------------------------+
</code></pre>
<pre><code class="java">// android.app.servertransaction.TransactionExecutor#execute
    public void execute(ClientTransaction transaction) &#123;
        ....
        executeCallbacks(transaction);
        ....
    &#125;
</code></pre>
<pre><code class="kotlin">// android.app.servertransaction.TransactionExecutor#executeCallbacks
    public void executeCallbacks(ClientTransaction transaction) &#123;
        final List&lt;ClientTransactionItem&gt; callbacks = transaction.getCallbacks();
        ....
  ã€ŒS1ã€ final IBinder token = transaction.getActivityToken();
        ....
        for (int i = 0; i &lt; size; ++i) &#123;
            final ClientTransactionItem item = callbacks.get(i);
            ....
    ã€ŒS2ã€  item.execute(mTransactionHandler, token, mPendingActions);
            ....
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒS1ã€</code>â¬…ï¸<code>ã€ŒR2ã€</code></p>
<p>ä»transactionä¸­è·å–activityToken<code>ã€ŒK1ã€</code>â¬…ï¸<code>ã€ŒJ3ã€</code></p>
</li>
<li><p><code>ã€ŒS2ã€</code>â¬…ï¸<code>ã€ŒR2ã€</code></p>
<p>callbackï¼ˆä¸ºActivityRelaunchItemï¼‰æ‰§è¡Œï¼Œexecuteæ–¹æ³•æ¥è‡ªActivityRelaunchItem å®ç°çš„æ¥å£BaseClientRequestçš„executeæ–¹æ³•</p>
<p>è‡³äºmTransactionHandleræ˜¯è°ï¼Œåœ¨<code>ã€ŒR2ã€</code>å·²ç»è§£é‡Š</p>
<p>executeæ–¹æ³•æ¥è‡ªActivityRelaunchItemå®ç°çš„æ¥å£BaseClientRequestä¸­çš„executeæ–¹æ³•â¬‡ï¸</p>
<pre><code class="kotlin">public interface BaseClientRequest extends ObjectPoolItem &#123;

    ....
    void execute(ClientTransactionHandler client, IBinder token,
            PendingTransactionActions pendingActions);
    ....

&#125;
</code></pre>
<p>ActivityRelaunchItemå’ŒBaseClientRequestçš„å…³ç³»â¬‡ï¸</p>
<pre><code class="kotlin">public abstract class ClientTransactionItem implements BaseClientRequest
</code></pre>
<pre><code class="kotlin">public abstract class ActivityTransactionItem extends ClientTransactionItem
</code></pre>
<pre><code class="kotlin">public class ActivityRelaunchItem extends ActivityTransactionItem
</code></pre>
<pre class="mermaid">    classDiagram
      class ClientTransactionItem 
      class ActivityTransactionItem 
      class ActivityRelaunchItem 
      class BaseClientRequest {
         <<interface>>
         + execute(ClientTransactionHandler client, IBinder token,PendingTransactionActions pendingActions)
      }
      ClientTransactionItem <|-- ActivityTransactionItem
      ActivityTransactionItem <|-- ActivityRelaunchItem
      BaseClientRequest <|-- ClientTransactionItem: implements</pre>

<p>è¯¥executeæ–¹æ³•ç”±<code>[C]ActivityRelaunchItem</code>çš„åŸºç±»ActivityTransactionItemå®ç°</p>
<pre><code class="kotlin">// ActivityTransactionItem
    public final void execute(ClientTransactionHandler client, IBinder token,
            PendingTransactionActions pendingActions) &#123;
   ã€ŒA1ã€  final ActivityClientRecord r = getActivityClientRecord(client, token);

   ã€ŒA2ã€  execute(client, r, pendingActions);
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒA1ã€</code>æ ¹æ®tokenè·å–ActivityClientRecord</p>
<pre><code class="kotlin">// ActivityTransactionItem
    @NonNull ActivityClientRecord getActivityClientRecord(
            @NonNull ClientTransactionHandler client, IBinder token) &#123;
        final ActivityClientRecord r = client.getActivityClient(token);
        ....
        return r;
    &#125;
</code></pre>
<p>clientæ˜¯ TransactionExecutor.mTransactionHandlerï¼Œä¹Ÿå°±æ˜¯æŒæœ‰TransactionExecutorçš„ActivityThread</p>
<pre><code class="java">// ActivityThread 
    @Override
    public ActivityClientRecord getActivityClient(IBinder token) &#123;
        return mActivities.get(token);
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒA2ã€</code>ç»§ç»­æ‰§è¡Œ â¬‡ï¸</p>
<pre><code class="java">// ActivityRelaunchItem
    @Override
    public void execute(ClientTransactionHandler client, ActivityClientRecord r,
            PendingTransactionActions pendingActions) &#123;
        ....
  ã€ŒB1ã€  client.handleRelaunchActivity(mActivityClientRecord, pendingActions);
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒB1ã€</code>mActivityClientRecordä»å“ªé‡Œæ¥ï¼Ÿä¹‹å‰ğŸ”—<code>ã€ŒP1ã€</code>â¬…ï¸ <code>ã€ŒO1ã€</code></p>
<pre><code class="kotlin">// ActivityThread
    @Override
    public void handleRelaunchActivity(ActivityClientRecord tmp,
            PendingTransactionActions pendingActions) &#123;
        ...
    ã€ŒC1ã€ ActivityClientRecord r = mActivities.get(tmp.token);
        ...
    ã€ŒC2ã€handleRelaunchActivityInner(r, configChanges, tmp.pendingResults, tmp.pendingIntents,
                pendingActions, tmp.startsNotResumed, tmp.overrideConfig, &quot;handleRelaunchActivity&quot;);
        ...
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒC1ã€</code>â¬…ï¸<code>ã€ŒB1ã€</code></p>
<p>è¿™é‡Œä»<code>mActivities</code>ä¸­æ ¹æ®tokenè·å–<code>[sC]ActivityClientRecord</code></p>
<pre><code class="text">+----------------------------------------------------------------+
|   ActivityThread                                               |
|                                                                |
|                                                                |
|    +------------------------------------------------------+    |
|    |  mActivities                                         |    |
|    |             +--------------------------------------+ |    |
|    |             |      +---------------+               | |    |
|    |             |      |    Activity   |               | |    |
|    |             |      +---------------+               | |    |
|    |             |                                      | |    |
|    |             |   +-------------------------------+  | |    |
|    |             |   | lastNonConfigurationInstances |  | |    |
|    |             |   +-------------------------------+  | |    |
|    |             |                                      | |    |
|    |             +--------------------------------------+ |    |
|    |             +--------------------------------------+ |    |
|    |             |                                      | |    |
|    |             |                                      | |    |
|    |             +--------------------------------------+ |    |
|    |             +--------------------------------------+ |    |
|    |             |                                      | |    |
|    |             |                                      | |    |
|    |             +--------------------------------------+ |    |
|    |                                                      |    |
|    |                           ...                        |    |
|    |                                                      |    |
|    +------------------------------------------------------+    |
+----------------------------------------------------------------+
</code></pre>
</li>
<li><p><code>ã€ŒC2ã€</code>â¬…ï¸<code>ã€ŒB1ã€</code></p>
<p>ä¼ é€’rç»™</p>
<pre><code class="java">// ActivityThread
    private void handleRelaunchActivityInner(ActivityClientRecord r, int configChanges,
            List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingIntents,
            PendingTransactionActions pendingActions, boolean startsNotResumed,
            Configuration overrideConfig, String reason) &#123;
        ...
ã€ŒD1ã€        handleDestroyActivity(r, false, configChanges, true, reason);
        ...
ã€ŒD2ã€        handleLaunchActivity(r, pendingActions, customIntent);
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒD1ã€</code>â¬…ï¸<code>ã€ŒC2ã€</code></p>
<p>â¬‡ï¸DestroyåŸæ¥çš„Activityï¼Œå…¶ä¸­getNonConfigInstanceä¼ å…¥äº†true</p>
<pre><code class="java">// ActivityThread
    @Override
    public void handleDestroyActivity(ActivityClientRecord r, boolean finishing, int configChanges,
            boolean getNonConfigInstance, String reason) &#123;
        performDestroyActivity(r, finishing, configChanges, getNonConfigInstance, reason);
        ...
    &#125;
</code></pre>
<p>â¬‡ï¸å°†åŸæ¥çš„activityçš„nonConfigurationInstanceså­˜å…¥ActivityRecord.lastNonConfigurationInstances</p>
<pre><code class="java">// ActivityThread
    /** Core implementation of activity destroy call. */
    void performDestroyActivity(ActivityClientRecord r, boolean finishing,
            int configChanges, boolean getNonConfigInstance, String reason) &#123;
        ...
    ã€ŒE1ã€ if (getNonConfigInstance) &#123;
            ....
            ã€ŒE2ã€  r.lastNonConfigurationInstances = r.activity.retainNonConfigurationInstances();
            ....
</code></pre>
</li>
<li><p><code>ã€ŒE1ã€</code>è¿™é‡Œå¦‚æœæ˜¯getNonConfigInstanceä¸ºtrueï¼ˆå‰é¢ä¼ çš„æ˜¯trueï¼‰ï¼Œ</p>
</li>
<li><p><code>ã€ŒE2ã€</code></p>
<p>åˆ™ï¸å°†retainNonConfigurationInstancesçš„ç»“æœæ”¾å…¥<code>[sC]ActivityClientRecord</code>.lastNonConfigurationInstancesï¼Œå…¶ä¸­å°±åŒ…å«viewModelStore</p>
<pre><code class="java"> // Activity
    NonConfigurationInstances retainNonConfigurationInstances() &#123;
ã€ŒF1ã€ Object activity = onRetainNonConfigurationInstance();
        ...
        NonConfigurationInstances nci = new NonConfigurationInstances();
        nci.activity = activity;
        ....
        return nci;
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒF1ã€</code>Activityé»˜è®¤å®ç°ä¸­åªè¿”å›äº†nullï¼Œä½†æ˜¯<code>[C]ComponentActivity</code>é‡å†™äº†è¿™ä¸ªæ–¹æ³•â¬‡ï¸</p>
<pre><code class="java"> // ComponentActivity
    public final Object onRetainNonConfigurationInstance() &#123;
        // Maintain backward compatibility.
ã€ŒG1ã€  Object custom = onRetainCustomNonConfigurationInstance();

        ViewModelStore viewModelStore = mViewModelStore;
ã€ŒG2ã€  if (viewModelStore == null) &#123;
            ....
        &#125;
        ....

ã€ŒG3ã€   NonConfigurationInstances nci = new NonConfigurationInstances();
        nci.custom = custom;
        nci.viewModelStore = viewModelStore;
        return nci;
    &#125;

</code></pre>
</li>
<li><p><code>ã€ŒG1ã€</code>æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™onRetainCustomNonConfigurationInstance()åˆ›å»ºcustomå³è‡ªå®šä¹‰çš„åœ¨configurationæ”¹å˜åä»ç„¶æƒ³è¦ä¿å­˜çš„æ•°æ®ã€‚</p>
</li>
<li><p><code>ã€ŒG2ã€</code>è¿™é‡Œå½“viewModelStoreä¸ºç©ºçš„æ—¶å€™ä¼šæŸ¥çœ‹<code>[C]ComponentActivity.NonConfigurationInstances</code>ä¸­æ˜¯å¦æœ‰viewModelStoreï¼Œè¿™é‡Œå¯¹åº”ä»æ¥æ²¡æœ‰åœ°æ–¹è°ƒç”¨è¿‡getViewModelStoreï¼Œä¹Ÿå°±ä¸ä¼šåˆå§‹åŒ–ComponentActivity.mVieModelStoreï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œæƒ…å†µæ˜¯ä¹‹å‰æœ‰åˆ›å»ºviewmodelï¼Œ<code>this(owner.viewModelStore, defaultFactory(owner), defaultCreationExtras(owner))</code> ï¼Œè¿™é‡Œä½¿ç”¨ <code>owner.viewModelStore</code>ä»ViewModelStoreOwnerä¸­å–å‡º<code>[OC]ViewModelStore</code>è°ƒç”¨è¿‡ï¼Œæ‰€æœ‰ä¸ä¼šèµ°åˆ°viewModelStore &#x3D;&#x3D; nullçš„åˆ†æ”¯</p>
</li>
<li><p><code>ã€ŒG3ã€</code>è¿™é‡Œåˆ›å»ºäº†<code>[C]ComponentActivity.NonConfigurationInstances</code>å­˜å…¥ customå’ŒviewModelStoreå¹¶è¿”å›ã€‚</p>
</li>
<li><p><code>ã€ŒD2ã€</code>â¬…ï¸<code>ã€ŒC2ã€</code>æ‰§è¡ŒLaunchActivity</p>
<pre><code class="java">// android.app.ActivityThread#handleLaunchActivity
    public Activity handleLaunchActivity(ActivityClientRecord r,
            PendingTransactionActions pendingActions, Intent customIntent) &#123;
        ....
        final Activity a = performLaunchActivity(r, customIntent);
        ....
        return a;
    &#125;
</code></pre>
<pre><code class="kotlin">// android.app.ActivityThread#performLaunchActivity
    private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;
        ....
        Activity activity = null;
        try &#123;
            java.lang.ClassLoader cl = appContext.getClassLoader();
      ã€ŒH1ã€ activity = mInstrumentation.newActivity(
                    cl, component.getClassName(), r.intent);
            ....

        try &#123;
            ....
            if (activity != null) &#123;
                ....
        ã€ŒH2ã€   activity.attach(appContext, this, getInstrumentation(), r.token,
                        r.ident, app, r.intent, r.activityInfo, title, r.parent,
                        r.embeddedID, r.lastNonConfigurationInstances, config,
                        r.referrer, r.voiceInteractor, window, r.activityConfigCallback,
                        r.assistToken, r.shareableActivityToken);
        ....
        return activity;
    &#125;
</code></pre>
</li>
<li><p><code>ã€ŒH1ã€</code></p>
<p>å®ä¾‹åŒ–ä¸€ä¸ªActivity</p>
</li>
<li><p><code>ã€ŒH2ã€</code></p>
<p>ä½¿ç”¨åŸæ¥çš„ActivityRecordç»™Activityè®¾ç½®å‚æ•°ï¼Œå…¶ä¸­ç¬¬12ä¸ªå‚æ•°å°±æ˜¯åœ¨<code>ã€ŒE2ã€</code>å¤„ä¿å­˜çš„lastNonConfigurationInstancesï¼Œå…¶ä¸­å°±æœ‰viewModel</p>
<p>è¿™é‡Œå°±å›ç­”äº†ä¸Šé¢<code>[U2]</code>å¤„çš„é—®é¢˜ï¼Œä¸²èµ·æ¥äº†</p>
</li>
</ul>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p>code</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6976025197333708837" title="Android é¢è¯•æ€»ç»“ - ViewModel æ˜¯æ€ä¹ˆä¿å­˜å’Œæ¢å¤ï¼Ÿ - æ˜é‡‘ (juejin.cn)">Android é¢è¯•æ€»ç»“ - ViewModel æ˜¯æ€ä¹ˆä¿å­˜å’Œæ¢å¤ï¼Ÿ - æ˜é‡‘ (juejin.cn)</a></li>
<li><a target="_blank" rel="noopener" href="https://pomelojiang.github.io/android_framework_start_activity_1" title="Android Frameworkä¹‹Activityå¯åŠ¨æµç¨‹(ä¸€) | æŸšå­ | pomeloJiang">Android Frameworkä¹‹Activityå¯åŠ¨æµç¨‹(ä¸€) | æŸšå­ | pomeloJiang</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904179299778567" title="Zygoteçš„å¯åŠ¨æµç¨‹ - æ˜é‡‘ (juejin.cn)">Zygoteçš„å¯åŠ¨æµç¨‹ - æ˜é‡‘ (juejin.cn)</a></li>
<li><a target="_blank" rel="noopener" href="https://benzblog.site/2017-06-19-all-about-rotations/" title="Androidå±å¹•æ—‹è½¬æºç æ¢ç´¢åŠåº”ç”¨å®è·µ | å¥”å“²æ˜çš„åšå®¢ (benzblog.site)">Androidå±å¹•æ—‹è½¬æºç æ¢ç´¢åŠåº”ç”¨å®è·µ | å¥”å“²æ˜çš„åšå®¢ (benzblog.site)</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903869814669319" title="Configuration å˜æ›´æ—¶Activityçš„ç”Ÿå‘½å‘¨æœŸæ¢ç©¶ - æ˜é‡‘ (juejin.cn)">Configuration å˜æ›´æ—¶Activityçš„ç”Ÿå‘½å‘¨æœŸæ¢ç©¶ - æ˜é‡‘ (juejin.cn)</a></li>
</ul>

</article>

<script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<div id="paginator">
  
</div>

      </div>
    </div>

  </div>

  <!-- åº•éƒ¨ä¿¡æ¯ -->
  <div id="bottom-outer">
    <div id="bottom-inner">
      Site by Swithun Liu using
      <a target="_blank" rel="noopener" href="http://hexo.io">hexo blog framework</a>.
      <br>
      <a href="/">Home</a>
    </div>
  </div>


  
  <!-- scripts list from theme config.yml -->
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.0-alpha1/highlight.min.js"></script>
  
  <script src="/lib/jquery-3.4.1.min.js"></script>
  
  <script src="/lib/jquery.pjax.js"></script>
  
  <script src="/js/again.js"></script>
  
  


  <!-- é«˜äº®è„šæœ¬å¯åŠ¨ -->
  <script>hljs.initHighlightingOnLoad();</script>

    <!-- å¦‚æœè®¾ç½®ä¸­mermaidé€‰é¡¹æ‰“å¼€ -->
    
    <!-- å¼•å…¥mermaidè„šæœ¬ -->
    <div class=".pjax-reload">
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.0.0-alpha.4/mermaid.min.js'></script>
    </div>
    <!-- mermaidå¯åŠ¨ -->
    <script>
      if (window.mermaid) {
        mermaid.initialize({ theme: 'dark' });
      }
    </script>
    

</body>

</html>