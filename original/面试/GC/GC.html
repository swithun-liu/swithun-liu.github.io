

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title> [ Swithun Blog ]</title>

  
  <!-- stylesheets list from _config.yml -->
  
  <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css">
  
  <link rel="stylesheet" href="/lib/highlight-11-9-0/src/styles/atom-one-dark.css">
  
  <link rel="stylesheet" href="/css/again.css">
  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>

  <!-- menu -->
  <div id="menu-outer">
    <div id="menu-inner">
      
      <a class="menu-button" href="/">Home</a>
      
      <a class="menu-button" href="/about">About</a>
      
      <a class="menu-button" href="/contact">Contact</a>
      
      <a class="menu-button" href="/archives">Archives</a>
      
      <a class="menu-button" href="/categories">Category</a>
      
    </div>
  </div>

  <!-- 中间主体 -->
  <div id="main">
    <!-- 侧边栏 -->
    <div id="aside-outer">
      <aside>
        <!-- 搜索栏 -->
<div id="search">
    <input class="search-input" type="text" placeholder="search">
    <i id="search-icon" class="fa fa-bars" title="切换目录与索引"></i>
</div>

<!-- 侧边目录栏 -->
<div id="tree">
    

    

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            Android
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/18/Android/Fragment原理/">
                            <i class="fa fa-file"></i>
                            Fragment原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/Android/viewmodel原理/">
                            <i class="fa fa-file"></i>
                            viewmodel原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/03/03/Android/view绘制原理/">
                            <i class="fa fa-file"></i>
                            view绘制原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/03/09/Android/自定义View实现拖拽展开面板/">
                            <i class="fa fa-file"></i>
                            自定义View实现拖拽展开面板
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/05/12/Android/NestedScrolling原理/">
                            <i class="fa fa-file"></i>
                            NestedScrolling原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/05/25/Android/自己实现一个NestedScrollView/">
                            <i class="fa fa-file"></i>
                            自己实现一个NestedScrollView
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/06/02/Android/EditText光标定位原理/">
                            <i class="fa fa-file"></i>
                            EditText光标定位原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/06/02/Android/一步步解决NestedScrollView嵌套EditText的冲突/">
                            <i class="fa fa-file"></i>
                            一步步解决NestedScrollView嵌套EditText的冲突
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/06/11/Android/Dialog原理/">
                            <i class="fa fa-file"></i>
                            Dialog原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/07/20/Android/从0实现一个BottomSheetDialog/">
                            <i class="fa fa-file"></i>
                            从0实现一个BottomSheetDialog
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/08/18/Android/kotlin协程原理/">
                            <i class="fa fa-file"></i>
                            kotlin协程原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/09/07/Android/textview measure流程/">
                            <i class="fa fa-file"></i>
                            textview measure流程
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/03/10/Android/Activity的启动流程/">
                            <i class="fa fa-file"></i>
                            Activity的启动流程
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            主题演示
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/主题演示/demo1/">
                            <i class="fa fa-file"></i>
                            demo1
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/22/主题演示/temp/">
                            <i class="fa fa-file"></i>
                            temp
                        </a>
                    </li>
                </ul>

              

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            demo_folder_level2
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/主题演示/demo_folder_level2/demo2/">
                            <i class="fa fa-file"></i>
                            demo2
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            AOSP
                        </a>
                        

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            java
                        </a>
                        

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            lang
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/10/07/AOSP/java/lang/ThreadLocal/">
                            <i class="fa fa-file"></i>
                            ThreadLocal
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/01/04/AOSP/java/lang/Thread/">
                            <i class="fa fa-file"></i>
                            Thread
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            util
                        </a>
                        

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            concurrent
                        </a>
                        

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            ThreadPoolExecutor
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/01/04/AOSP/java/util/concurrent/ThreadPoolExecutor/Worker/">
                            <i class="fa fa-file"></i>
                            Worker
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/12/28/AOSP/java/util/concurrent/LinkedBlockingQueue/">
                            <i class="fa fa-file"></i>
                            LinkedBlockingQueue
                        </a>
                    </li>
                </ul>

              

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            sub-ThreadPoolExecutor
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/01/04/AOSP/java/util/concurrent/sub-ThreadPoolExecutor/Worker/">
                            <i class="fa fa-file"></i>
                            Worker
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            locks
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/01/11/AOSP/java/util/concurrent/locks/Condition/">
                            <i class="fa fa-file"></i>
                            Condition
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            multi_thread
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/12/08/multi_thread/Test/">
                            <i class="fa fa-file"></i>
                            Test
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/12/08/multi_thread/ThreadPool/">
                            <i class="fa fa-file"></i>
                            ThreadPool
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/01/04/multi_thread/Java锁/">
                            <i class="fa fa-file"></i>
                            Java锁
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            面试
                        </a>
                        

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            Handler
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/10/18/面试/Handler/handler/">
                            <i class="fa fa-file"></i>
                            handler
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            GC
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/11/16/面试/GC/GC/">
                            <i class="fa fa-file"></i>
                            GC
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            HashMap
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/10/26/面试/HashMap/HashMap面试/">
                            <i class="fa fa-file"></i>
                            HashMap面试
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            java基础
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/03/02/java基础/java-basic/">
                            <i class="fa fa-file"></i>
                            java-basic
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
</div>

<div id="toc" style="display: none;"></div>
      </aside>
    </div>
    <!-- 文章内容 -->
    <div id="content-outer">
      <div id="content-inner">
        
<article id="page">
  <h1></h1>
  <h2 id="G1之前"><a href="#G1之前" class="headerlink" title="G1之前"></a>G1之前</h2><ol>
<li>根据内存地址划分 E,S,S,O</li>
<li>根据内存地址判断是老年代还是新生代，当老年代引用新生的时候，在cardtable中记录该老年代为脏</li>
<li>minor gc阶段：当Eden满了，将Stack、Static、JNI、被标记为脏的老年代作为GCRoots，递归遍历（Eden和上次使用的S）哪些新生代是存活的，当递归到老年代的时候则停止，最后将存活的新生代移动到另一个S中，循环往复交换使用S，每次新生代移动年龄加一，当15岁则变成老年代</li>
<li>full gc阶段：当老年代满了，需要将Stack、Static、JNI作为GCRoots、全量递归到底，确认所有存活的对象，确认后有两种清理方式可选（1. 保留存活的在原地 2. 将存活的从头排列整齐，减少内存碎片）</li>
</ol>
<pre><code>+-----------------------------------+
|   App 进程的总内存                |
|                                   |
|  +-----------------------------+  |
|  |     Java 堆 (Heap)          |  |  &lt;-- &quot;1 号仓库&quot; (产品)
|  | [ E | S0 | S1 | Old ]      |  |
|  +-----------------------------+  |
|                                   |
|  +-----------------------------+  |
|  |     虚拟机栈 (Stacks)       |  |  &lt;-- &quot;工人&quot;的&quot;随身工具&quot;
|  +-----------------------------+  |
|                                   |
|  +-----------------------------+  |
|  |     元空间 (Metaspace)      |  |  &lt;-- &quot;2 号仓库&quot; (类的图纸)
|  +-----------------------------+  |
|                                   |
|  +-----------------------------+  |
|  |   JVM/ART 内部内存           |  |  &lt;-- &quot;经理办公室&quot;
|  |   +-------------------+     |  |
|  |   |  JIT 编译代码     |     |  |
|  |   +-------------------+     |  |
|  |   |   卡片表 (Card Table) | &lt;------ 在这里！
|  |   +-------------------+     |  |
|  |   |   RSet (G1 的账本)  |     |  |
|  |   |   GC 状态信息      |     |  |
|  |   +-------------------+     |  |
|  +-----------------------------+  |
|                                   |
+-----------------------------------+
</code></pre>
<h2 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h2><p>目标：Full GC -&gt; 大型 Stop-The-World! 将1次长卡顿-&gt;N次小卡顿</p>
<ol>
<li>“堆” &#x3D; 一大堆 Region 的集合。<code>[O][E][S][E][O][O][H][E][S][O][O][E]...</code>,非常灵活地“动态调整”新生代和老年代的大小。</li>
<li>这是 G1 的“终极版”作弊卡，取代了【G1之前】的 Card Table。</li>
</ol>
<blockquote>
<p>有多少个？ (How many?) G1 为 每一个 Region 都配了一个 RSet 账本。 (比如堆被分成 2048 个 Region，就有 2048 个 RSet 账本)。</p>
</blockquote>
<blockquote>
<p>是什么维度的？ (What dimension?) 它是一个“谁指向我” (Who-Points-To-Me) 的列表。 Region 8 的 RSet 账本，记录了所有“外部” Region 指向“Region 8”的引用。 (比如 RSet(Region 8) &#x3D; { Region 1(Old) 指向我, Region 5(Young) 指向我 })</p>
</blockquote>
<blockquote>
<p>G1 如何使用它？ (How?) G1 一直（通过“写屏障”）在维护这个“终极账本”（包括 Old-&gt;Old）。 只不过，在“不同”的 GC 模式下，G1 会“按需”去查询 RSet 的“不同”部分。</p>
</blockquote>
<h2 id="minor-GC"><a href="#minor-GC" class="headerlink" title="minor GC"></a>minor GC</h2><blockquote>
<p>仅仅是“打扫新生代”。它（为了快）不想管老年代的死活</p>
</blockquote>
<ol>
<li>打扫目标 (CSet): [所有 Young Region (E+S)]</li>
<li>GCRoots (起点):<ul>
<li>Stack, Static, JNI (真的 GCRoots)</li>
<li>RSet (按需查询) (假的 GCRoots)<blockquote>
<p>RSet (按需查询) 详解:<br>G1 会查询所有 [Young Region] 的 RSet 账本。<br>它在账本里只查找来自 [Old Region] 的引用。<br>最终得到一个列表：所有 Old -&gt; Young 的引用。</p>
</blockquote>
</li>
</ul>
</li>
<li>扫描规则：遇老就停</li>
<li>整理方式<table>
<thead>
<tr>
<th>整理方式</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
</tr>
</thead>
<tbody><tr>
<td>minorGC前</td>
<td>O</td>
<td>E</td>
<td>E</td>
<td>S</td>
<td>O</td>
<td>O</td>
<td>空</td>
<td>空</td>
<td>空</td>
</tr>
<tr>
<td>minorGC后</td>
<td>0</td>
<td>空</td>
<td>空</td>
<td>空</td>
<td>O</td>
<td>O</td>
<td>S(整齐)</td>
<td>空</td>
<td>空</td>
</tr>
<tr>
<td>minorGC后-假设不整理</td>
<td>O</td>
<td>E(碎片)</td>
<td>E(碎片)</td>
<td>S(碎片)</td>
<td>O</td>
<td>O</td>
<td>空</td>
<td>空</td>
<td>空</td>
</tr>
</tbody></table>
</li>
</ol>
<h2 id="mixed-GC"><a href="#mixed-GC" class="headerlink" title="mixed GC"></a>mixed GC</h2><ol>
<li>触发时机：堆占用率达到阈值，启动阶段一</li>
<li>阶段1-Initial Mark(初始标记)：<ol>
<li>GCRoots: Stack&amp;Static&amp;JNI</li>
<li>深度：向下找一层，存活的(Young&#x2F;Old)&#x3D;&gt;”Marking Queue”</li>
</ol>
</li>
<li>阶段2-Concurrent Marking (并发标记)<ol>
<li>MarkingQueue: AB</li>
<li>取出A，A-&gt;C, A-&gt;D</li>
<li>MarkingQueue: BCD</li>
<li>取出B, B-&gt;E</li>
<li>MarkingQueue: BCDE</li>
<li>取出C, C-&gt; F</li>
<li>…</li>
</ol>
</li>
<li>阶段 3：“对账” (Remark &#x2F; Final Mark) - (有 STW，但“可控”)<ol>
<li>STW 停停停！</li>
<li>根据SATB Log对账(阶段2期间变更的引用(Old-&gt;Old&#x2F;Young))，将记录的旧值作为GCRoots全量递归排查</li>
</ol>
</li>
<li>阶段4: Cleanup (清理) - (有 STW，但极短)<ol>
<li>（STW 期间）G1 经理（GC）现在有了“100% 准确”的“存活地图”。 </li>
<li>他遍历所有 Region，计算“垃圾比例”，生成一张 <strong>“投资回报率 (ROI) 报表”</strong> (即“建议表”)。 </li>
<li>他 <strong>“顺便”</strong> （在后台）“一键清空”那些“100% 都是垃圾”的 [Old] Region（白捡内存）。</li>
</ol>
</li>
<li>阶段5: “混合回收” (Mixed GC) - (N 次“小卡顿” STW)<ol>
<li>打扫目标 (CSet): <ol>
<li>[所有 Young Region] (和 Minor GC 一样)</li>
<li>[“ROI报表”上“最划算”的 Old Region (比如 R8, R15)]</li>
</ol>
</li>
<li>GCRoots (起点): <ol>
<li>Stack, Static, JNI (真的 GCRoots) </li>
<li>RSet (按需查询) (假的 GCRoots)<blockquote>
<p>RSet (按需查询) 详解:<br>G1 会查询所有 CSet（Young + R8 + R15）的 RSet 账本。<br>它查找所有“CSet 之外”指向“CSet 之内”的引用(只找OldRegion)。<br>最终得到一个列表：(比如 Old -&gt; Young, Old -&gt; R8, Old -&gt; R15)</p>
</blockquote>
</li>
</ol>
</li>
<li>扫描规则 (和 Minor GC 一样！“遇老则停”):</li>
<li>算法 (复制算法！):<ol>
<li>Young 活口 -&gt; “复制” 到 [New S]</li>
<li>R8, R15 活口 -&gt; “复制” 到 [New O]</li>
<li>“清空” (格式化) [All Young] + [R8] + [R15]。</li>
<li>(STW 结束，只花了 20ms)</li>
</ol>
</li>
</ol>
</li>
</ol>

</article>

<div id="paginator">
  
</div>

      </div>
    </div>

  </div>

  <!-- 底部信息 -->
  <div id="bottom-outer">
    <div id="bottom-inner">
      Site by Swithun Liu using
      <a target="_blank" rel="noopener" href="http://hexo.io">hexo blog framework</a>.
      <br>
      <a href="/">Home</a>
    </div>
  </div>


  
  <!-- scripts list from theme config.yml -->
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.0-alpha1/highlight.min.js"></script>
  
  <script src="/lib/jquery-3.4.1.min.js"></script>
  
  <script src="/lib/jquery.pjax.js"></script>
  
  <script src="/js/again.js"></script>
  
  <script src="/js/img.js"></script>
  
  


  <!-- 高亮脚本启动 -->
  <script>hljs.initHighlightingOnLoad();</script>

    <!-- 如果设置中mermaid选项打开 -->
    
    <!-- 引入mermaid脚本 -->
    <div class=".pjax-reload">
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.3.0/mermaid.min.js'></script>
    </div>
    <!-- mermaid启动 -->
    <script>
      if (window.mermaid) {
        mermaid.initialize({ theme: 'dark' });
      }
    </script>
    

</body>

</html>