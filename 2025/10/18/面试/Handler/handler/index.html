

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>handler [ Swithun Blog ]</title>

  
  <!-- stylesheets list from _config.yml -->
  
  <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css">
  
  <link rel="stylesheet" href="/lib/highlight-11-9-0/src/styles/atom-one-dark.css">
  
  <link rel="stylesheet" href="/css/again.css">
  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>

  <!-- menu -->
  <div id="menu-outer">
    <div id="menu-inner">
      
      <a class="menu-button" href="/">Home</a>
      
      <a class="menu-button" href="/about">About</a>
      
      <a class="menu-button" href="/contact">Contact</a>
      
      <a class="menu-button" href="/archives">Archives</a>
      
      <a class="menu-button" href="/categories">Category</a>
      
    </div>
  </div>

  <!-- 中间主体 -->
  <div id="main">
    <!-- 侧边栏 -->
    <div id="aside-outer">
      <aside>
        <!-- 搜索栏 -->
<div id="search">
    <input class="search-input" type="text" placeholder="search">
    <i id="search-icon" class="fa fa-bars" title="切换目录与索引"></i>
</div>

<!-- 侧边目录栏 -->
<div id="tree">
    

    

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            Android
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/18/Android/Fragment原理/">
                            <i class="fa fa-file"></i>
                            Fragment原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/Android/viewmodel原理/">
                            <i class="fa fa-file"></i>
                            viewmodel原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/03/03/Android/view绘制原理/">
                            <i class="fa fa-file"></i>
                            view绘制原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/03/09/Android/自定义View实现拖拽展开面板/">
                            <i class="fa fa-file"></i>
                            自定义View实现拖拽展开面板
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/05/12/Android/NestedScrolling原理/">
                            <i class="fa fa-file"></i>
                            NestedScrolling原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/05/25/Android/自己实现一个NestedScrollView/">
                            <i class="fa fa-file"></i>
                            自己实现一个NestedScrollView
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/06/02/Android/EditText光标定位原理/">
                            <i class="fa fa-file"></i>
                            EditText光标定位原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/06/02/Android/一步步解决NestedScrollView嵌套EditText的冲突/">
                            <i class="fa fa-file"></i>
                            一步步解决NestedScrollView嵌套EditText的冲突
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/06/11/Android/Dialog原理/">
                            <i class="fa fa-file"></i>
                            Dialog原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/07/20/Android/从0实现一个BottomSheetDialog/">
                            <i class="fa fa-file"></i>
                            从0实现一个BottomSheetDialog
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/08/18/Android/kotlin协程原理/">
                            <i class="fa fa-file"></i>
                            kotlin协程原理
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/09/07/Android/textview measure流程/">
                            <i class="fa fa-file"></i>
                            textview measure流程
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/03/10/Android/Activity的启动流程/">
                            <i class="fa fa-file"></i>
                            Activity的启动流程
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            主题演示
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/主题演示/demo1/">
                            <i class="fa fa-file"></i>
                            demo1
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/22/主题演示/temp/">
                            <i class="fa fa-file"></i>
                            temp
                        </a>
                    </li>
                </ul>

              

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            demo_folder_level2
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2023/10/10/主题演示/demo_folder_level2/demo2/">
                            <i class="fa fa-file"></i>
                            demo2
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            AOSP
                        </a>
                        

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            java
                        </a>
                        

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            lang
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/10/07/AOSP/java/lang/ThreadLocal/">
                            <i class="fa fa-file"></i>
                            ThreadLocal
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/01/04/AOSP/java/lang/Thread/">
                            <i class="fa fa-file"></i>
                            Thread
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            util
                        </a>
                        

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            concurrent
                        </a>
                        

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            ThreadPoolExecutor
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/01/04/AOSP/java/util/concurrent/ThreadPoolExecutor/Worker/">
                            <i class="fa fa-file"></i>
                            Worker
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/12/28/AOSP/java/util/concurrent/LinkedBlockingQueue/">
                            <i class="fa fa-file"></i>
                            LinkedBlockingQueue
                        </a>
                    </li>
                </ul>

              

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            sub-ThreadPoolExecutor
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/01/04/AOSP/java/util/concurrent/sub-ThreadPoolExecutor/Worker/">
                            <i class="fa fa-file"></i>
                            Worker
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            locks
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/01/11/AOSP/java/util/concurrent/locks/Condition/">
                            <i class="fa fa-file"></i>
                            Condition
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            multi_thread
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/12/08/multi_thread/Test/">
                            <i class="fa fa-file"></i>
                            Test
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2024/12/08/multi_thread/ThreadPool/">
                            <i class="fa fa-file"></i>
                            ThreadPool
                        </a>
                    </li>
                </ul>

              
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/01/04/multi_thread/Java锁/">
                            <i class="fa fa-file"></i>
                            Java锁
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            面试
                        </a>
                        

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            Handler
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file active">
                        <a href="/2025/10/18/面试/Handler/handler/">
                            <i class="fa fa-file"></i>
                            handler
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            GC
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/11/16/面试/GC/GC/">
                            <i class="fa fa-file"></i>
                            GC
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            HashMap
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/10/26/面试/HashMap/HashMap面试/">
                            <i class="fa fa-file"></i>
                            HashMap面试
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
                    </li>
                </ul>

                 

                <!--如果是文件夹-->
                <ul>
                    <li class="directory">
                        <a href="#" class="directory">
                            <i class="fa fa-folder"></i>
                            java基础
                        </a>
                        
                <!--如果是文章-->
                <ul>
                    <li class="file">
                        <a href="/2025/03/02/java基础/java-basic/">
                            <i class="fa fa-file"></i>
                            java-basic
                        </a>
                    </li>
                </ul>

              
                    </li>
                </ul>

                 
</div>

<div id="toc" style="display: none;"></div>
      </aside>
    </div>
    <!-- 文章内容 -->
    <div id="content-outer">
      <div id="content-inner">
        
<article id="post">
  <h1>handler</h1>
  <p><a target="_blank" rel="noopener" href="https://github.com/jinguangyue/Android-Advanced-Interview">目录</a></p>
<h2 id="Handler-Looper-Message-关系是什么？"><a href="#Handler-Looper-Message-关系是什么？" class="headerlink" title="Handler Looper Message 关系是什么？"></a>Handler Looper Message 关系是什么？</h2><h3 id="1-让我理解的回答"><a href="#1-让我理解的回答" class="headerlink" title="1. 让我理解的回答"></a>1. 让我理解的回答</h3><p>Handler、Looper、Message 是 Android 消息机制的核心组件，它们的关系可以用一个<strong>消息队列模型</strong>来理解：</p>
<p><strong>核心比喻：消息队列系统</strong></p>
<ul>
<li><strong>Looper</strong>：消息循环器，相当于一个<strong>消息泵</strong>，不断从消息队列中取出消息并分发</li>
<li><strong>MessageQueue</strong>：消息队列，存储所有待处理的消息</li>
<li><strong>Handler</strong>：消息处理器，负责发送和处理消息</li>
<li><strong>Message</strong>：消息实体，包含要执行的任务和数据</li>
</ul>
<p><strong>工作流程</strong>：</p>
<ol>
<li><strong>Looper 准备</strong>：在主线程中，系统已经创建了 Looper 并调用了 <code>loop()</code> 方法开始循环</li>
<li><strong>Handler 发送消息</strong>：Handler 通过 <code>sendMessage()</code> 或 <code>post()</code> 方法将 Message 放入 MessageQueue</li>
<li><strong>Looper 循环处理</strong>：Looper 不断从 MessageQueue 中取出消息，然后调用对应 Handler 的 <code>handleMessage()</code> 方法</li>
<li><strong>Handler 处理消息</strong>：在 <code>handleMessage()</code> 中执行具体的业务逻辑</li>
</ol>
<p><strong>关键点</strong>：</p>
<ul>
<li>每个线程只能有一个 Looper</li>
<li>一个 Looper 对应一个 MessageQueue</li>
<li>一个 Handler 必须绑定到一个 Looper</li>
<li>Handler 可以在任何线程发送消息，但处理消息总是在创建 Handler 的线程中</li>
</ul>
<h3 id="2-给面试官的回答"><a href="#2-给面试官的回答" class="headerlink" title="2. 给面试官的回答"></a>2. 给面试官的回答</h3><p>Handler、Looper、Message 是 Android 消息机制的核心组件，它们的关系如下：</p>
<p><strong>核心关系</strong>：</p>
<ul>
<li><strong>Looper</strong>：消息循环器，负责从 MessageQueue 中取出消息并分发给对应的 Handler</li>
<li><strong>MessageQueue</strong>：消息队列，存储所有待处理的 Message</li>
<li><strong>Handler</strong>：消息处理器，负责发送和处理消息</li>
<li><strong>Message</strong>：消息实体，封装了要执行的任务和数据</li>
</ul>
<p><strong>工作流程</strong>：</p>
<ol>
<li>主线程默认创建了 Looper 并调用 <code>loop()</code> 方法进入消息循环</li>
<li>Handler 通过 <code>sendMessage()</code> 或 <code>post()</code> 将 Message 放入 MessageQueue</li>
<li>Looper 不断从 MessageQueue 中取出消息，调用对应 Handler 的 <code>handleMessage()</code></li>
<li>Handler 在 <code>handleMessage()</code> 中处理消息，执行 UI 更新等操作</li>
</ol>
<p><strong>关键特性</strong>：</p>
<ul>
<li>线程间通信：Handler 实现了不同线程间的消息传递</li>
<li>消息调度：支持延时消息和定时消息</li>
<li>主线程安全：确保 UI 操作在主线程执行</li>
<li>内存管理：Message 对象池化，避免频繁创建销毁</li>
</ul>
<p><strong>应用场景</strong>：</p>
<ul>
<li>子线程向主线程发送消息更新 UI</li>
<li>定时任务执行</li>
<li>延时操作处理</li>
<li>跨线程数据传递</li>
</ul>
<h2 id="Handler-的内存泄漏问题如何避免？"><a href="#Handler-的内存泄漏问题如何避免？" class="headerlink" title="Handler 的内存泄漏问题如何避免？"></a>Handler 的内存泄漏问题如何避免？</h2><h3 id="1-内存泄漏原因"><a href="#1-内存泄漏原因" class="headerlink" title="1. 内存泄漏原因"></a>1. 内存泄漏原因</h3><ul>
<li><strong>Handler 持有 Activity 引用</strong>：非静态内部类 Handler 隐式持有外部类 Activity 引用</li>
<li><strong>消息队列延迟</strong>：如果 Activity 销毁时仍有未处理的消息，Handler 会阻止 Activity 被回收</li>
<li><strong>生命周期不匹配</strong>：Handler 生命周期长于 Activity</li>
</ul>
<h3 id="2-解决方案"><a href="#2-解决方案" class="headerlink" title="2. 解决方案"></a>2. 解决方案</h3><ul>
<li><strong>使用静态内部类 + WeakReference</strong></li>
</ul>
<pre><code class="java">private static class MyHandler extends Handler &#123;
    private final WeakReference&lt;Activity&gt; mActivity;
    
    public MyHandler(Activity activity) &#123;
        mActivity = new WeakReference&lt;&gt;(activity);
    &#125;
    
    @Override
    public void handleMessage(Message msg) &#123;
        Activity activity = mActivity.get();
        if (activity != null &amp;&amp; !activity.isFinishing()) &#123;
            // 处理消息
        &#125;
    &#125;
&#125;
</code></pre>
<ul>
<li><strong>在 Activity 销毁时移除所有消息</strong></li>
</ul>
<pre><code class="java">@Override
protected void onDestroy() &#123;
    super.onDestroy();
    mHandler.removeCallbacksAndMessages(null);
&#125;
</code></pre>
<ul>
<li><strong>使用 ViewModel + LiveData</strong> 替代部分 Handler 使用场景</li>
</ul>
<h3 id="3-最佳实践"><a href="#3-最佳实践" class="headerlink" title="3. 最佳实践"></a>3. 最佳实践</h3><ul>
<li>避免在 Handler 中执行耗时操作</li>
<li>及时清理不需要的消息</li>
<li>考虑使用更现代的架构组件</li>
</ul>

</article>

<script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<div id="paginator">
  
</div>

      </div>
    </div>

  </div>

  <!-- 底部信息 -->
  <div id="bottom-outer">
    <div id="bottom-inner">
      Site by Swithun Liu using
      <a target="_blank" rel="noopener" href="http://hexo.io">hexo blog framework</a>.
      <br>
      <a href="/">Home</a>
    </div>
  </div>


  
  <!-- scripts list from theme config.yml -->
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.0-alpha1/highlight.min.js"></script>
  
  <script src="/lib/jquery-3.4.1.min.js"></script>
  
  <script src="/lib/jquery.pjax.js"></script>
  
  <script src="/js/again.js"></script>
  
  <script src="/js/img.js"></script>
  
  


  <!-- 高亮脚本启动 -->
  <script>hljs.initHighlightingOnLoad();</script>

    <!-- 如果设置中mermaid选项打开 -->
    
    <!-- 引入mermaid脚本 -->
    <div class=".pjax-reload">
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.3.0/mermaid.min.js'></script>
    </div>
    <!-- mermaid启动 -->
    <script>
      if (window.mermaid) {
        mermaid.initialize({ theme: 'dark' });
      }
    </script>
    

</body>

</html>